import { ReplaySubject, take } from 'rxjs';
import { ConstraintsWithNewVariables } from '../../models/glpk/constraints-with-new-variables';
import { IncrementingCounter } from '../incrementing-counter';
import { arraify } from '../arraify';
import { Constraint, MessageLevel } from '../../models/glpk/glpk-constants';
export class IlpSolver {
    constructor(_solver$) {
        this._solver$ = _solver$;
        this._constraintCounter = new IncrementingCounter();
        this._variableCounter = new IncrementingCounter();
        this._allVariables = new Set();
    }
    applyConstraints(ilp, constraints) {
        if (ilp.subjectTo === undefined) {
            ilp.subjectTo = [];
        }
        ilp.subjectTo.push(...constraints.constraints);
        if (ilp.binaries === undefined) {
            ilp.binaries = [];
        }
        ilp.binaries.push(...constraints.binaryVariables);
        if (ilp.generals === undefined) {
            ilp.generals = [];
        }
        ilp.generals.push(...constraints.integerVariables);
    }
    combineCoefficients(variables) {
        const map = new Map();
        for (const variable of variables) {
            const coef = map.get(variable.name);
            if (coef !== undefined) {
                map.set(variable.name, coef + variable.coef);
            }
            else {
                map.set(variable.name, variable.coef);
            }
        }
        const result = [];
        for (const [name, coef] of map) {
            if (coef === 0) {
                continue;
            }
            result.push(this.variable(name, coef));
        }
        return result;
    }
    createVariablesFromPlaceIds(placeIds, coefficient) {
        return placeIds.map(id => this.variable(id, coefficient));
    }
    helperVariableName(prefix = 'y') {
        let helpVariableName;
        do {
            helpVariableName = `${prefix}${this._variableCounter.next()}`;
        } while (this._allVariables.has(helpVariableName));
        this._allVariables.add(helpVariableName);
        return helpVariableName;
    }
    xAbsoluteOfSum(x, sum) {
        /*
         * As per https://blog.adamfurmanek.pl/2015/09/19/ilp-part-5/
         *
         * x >= 0
         * (x + sum is 0) or (x - sum is 0) = 1
         *
         */
        const y = this.helperVariableName('yAbsSum'); // x + sum is 0
        const z = this.helperVariableName('zAbsSum'); // x - sym is 0
        const w = this.helperVariableName('wAbsSum'); // y or z
        return ConstraintsWithNewVariables.combineAndIntroduceVariables(w, undefined, 
        // x >= 0
        this.greaterEqualThan(this.variable(x), 0), 
        // w is y or z
        this.xAorB(w, y, z), 
        // w is true
        this.equal(this.variable(w), 1), 
        // x + sum is 0
        this.xWhenAEqualsB(y, [this.variable(x), ...sum.map(a => this.createOrCopyVariable(a))], 0), 
        // x - sum is 0
        this.xWhenAEqualsB(z, [this.variable(x), ...sum.map(a => this.createOrCopyVariable(a, -1))], 0));
    }
    xWhenAEqualsB(x, a, b) {
        /*
             As per https://blog.adamfurmanek.pl/2015/09/12/ilp-part-4/

             x is a equals b <=> a greater equal than b and a less equal than b
         */
        const y = this.helperVariableName('yWhenEquals');
        const z = this.helperVariableName('zWhenEquals');
        const aGreaterEqualB = this.xWhenAGreaterEqualB(y, a, b);
        const aLessEqualB = this.xWhenALessEqualB(z, a, b);
        return ConstraintsWithNewVariables.combineAndIntroduceVariables([x, y], undefined, aGreaterEqualB, aLessEqualB, this.xAandB(x, y, z));
    }
    yWhenAGreaterEqualB(a, b) {
        /*
            As per https://blog.adamfurmanek.pl/2015/09/12/ilp-part-4/ and https://blog.adamfurmanek.pl/2015/08/22/ilp-part-1/
            x = a >= b can be defined as !(b > a)
            the negation for binary variables can be expressed as (for x = !y both binary) x = 1 - y
            the 1 - y form can be extracted and added to the constraint that puts all help variables together, therefore we only need to express y = b > a
            for |a|,|b| <= k and K = 2k + 1
            y = b > a can be expressed as:
            a - b + Ky >= 0
            a - b + Ky <= K-1

            in our case b is always a constant given by the solution (region)
            therefore we only have a and y as our variables which gives:
            a + Ky >= b
            a + Ky <= K-1 + b
         */
        const y = this.helperVariableName();
        if (b > IlpSolver.k) {
            console.debug("b", b);
            console.debug("k", IlpSolver.k);
            throw new Error("b > k. This implementation can only handle solutions that are at most k");
        }
        return ConstraintsWithNewVariables.combineAndIntroduceVariables([y], undefined, this.greaterEqualThan([this.variable(a), this.variable(y, IlpSolver.K)], b), this.lessEqualThan([this.variable(a), this.variable(y, IlpSolver.K)], IlpSolver.K - 1 + b));
    }
    xWhenAGreaterEqualB(x, a, b) {
        /*
            As per https://blog.adamfurmanek.pl/2015/09/12/ilp-part-4/

            a is greater equal b <=> not a less than b
         */
        const z = this.helperVariableName('zALessB');
        return ConstraintsWithNewVariables.combineAndIntroduceVariables(z, undefined, 
        // z when a less than b
        this.xWhenALessB(z, a, b), 
        // x not z
        this.xNotA(x, z));
    }
    xWhenALessEqualB(x, a, b) {
        /*
            As per https://blog.adamfurmanek.pl/2015/09/12/ilp-part-4/

            a is less equal b <=> not a greater than b
         */
        const z = this.helperVariableName('zAGreaterB');
        return ConstraintsWithNewVariables.combineAndIntroduceVariables(z, undefined, 
        // z when a greater than b
        this.xWhenAGreaterB(z, a, b), 
        // x not z
        this.xNotA(x, z));
    }
    xWhenAGreaterB(x, a, b) {
        /*
            As per https://blog.adamfurmanek.pl/2015/09/12/ilp-part-4/
            a,b integer
            |a|,|b| <= k
            k = 2^n - 1, n natural
            K = 2k + 1
            x binary

            0 <= b - a + Kx <= K - 1
         */
        let aIsVariable = false;
        let bIsVariable = false;
        if (typeof a === 'string' || Array.isArray(a)) {
            aIsVariable = true;
            if (typeof a === 'string') {
                a = arraify(a);
            }
        }
        if (typeof b === 'string' || Array.isArray(b)) {
            bIsVariable = true;
            if (typeof b === 'string') {
                b = arraify(b);
            }
        }
        if (aIsVariable && bIsVariable) {
            return ConstraintsWithNewVariables.combine(
            // b - a + Kx >= 0
            this.greaterEqualThan([
                ...b.map(b => this.createOrCopyVariable(b)),
                ...a.map(a => this.createOrCopyVariable(a, -1)),
                this.variable(x, IlpSolver.K)
            ], 0), 
            // b - a + Kx <= K - 1
            this.lessEqualThan([
                ...b.map(b => this.createOrCopyVariable(b)),
                ...a.map(a => this.createOrCopyVariable(a, -1)),
                this.variable(x, IlpSolver.K)
            ], IlpSolver.K - 1));
        }
        else if (aIsVariable && !bIsVariable) {
            return ConstraintsWithNewVariables.combine(
            // -a + Kx >= -b
            this.greaterEqualThan([
                ...a.map(a => this.createOrCopyVariable(a, -1)),
                this.variable(x, IlpSolver.K)
            ], -b), 
            // -a + Kx <= K - b - 1
            this.lessEqualThan([
                ...a.map(a => this.createOrCopyVariable(a, -1)),
                this.variable(x, IlpSolver.K)
            ], IlpSolver.K - b - 1));
        }
        else if (!aIsVariable && bIsVariable) {
            return ConstraintsWithNewVariables.combine(
            // b + Kx >= a
            this.greaterEqualThan([
                ...b.map(b => this.createOrCopyVariable(b)),
                this.variable(x, IlpSolver.K)
            ], a), 
            // b + Kx <= K + a - 1
            this.lessEqualThan([
                ...b.map(b => this.createOrCopyVariable(b)),
                this.variable(x, IlpSolver.K)
            ], IlpSolver.K + a - 1));
        }
        else {
            throw new Error(`unsupported comparison! x when ${a} > ${b}`);
        }
    }
    xWhenALessB(x, a, b) {
        /*
            As per https://blog.adamfurmanek.pl/2015/09/12/ilp-part-4/

            a is less than b <=> b is greater than a
         */
        return this.xWhenAGreaterB(x, b, a);
    }
    xAandB(x, a, b) {
        /*
            As per http://blog.adamfurmanek.pl/2015/08/22/ilp-part-1/
            a,b,x binary

            0 <= a + b - 2x <= 1
         */
        return ConstraintsWithNewVariables.combine(
        // a + b -2x >= 0
        this.greaterEqualThan([this.variable(a), this.variable(b), this.variable(x, -2)], 0), 
        // a + b -2x <= 1
        this.lessEqualThan([this.variable(a), this.variable(b), this.variable(x, -2)], 1));
    }
    xAorB(x, a, b) {
        /*
            As per http://blog.adamfurmanek.pl/2015/08/22/ilp-part-1/
            a,b,x binary

            -1 <= a + b - 2x <= 0
         */
        return ConstraintsWithNewVariables.combine(
        // a + b -2x >= -1
        this.greaterEqualThan([this.variable(a), this.variable(b), this.variable(x, -2)], -1), 
        // a + b -2x <= 0
        this.lessEqualThan([this.variable(a), this.variable(b), this.variable(x, -2)], 0));
    }
    xNotA(x, a) {
        /*
            As per http://blog.adamfurmanek.pl/2015/08/22/ilp-part-1/
            a,x binary

            x = 1 - a
         */
        // x + a = 1
        return this.equal([this.variable(x), this.variable(a)], 1);
    }
    createOrCopyVariable(original, coefficient = 1) {
        if (typeof original === 'string') {
            return this.variable(original, coefficient);
        }
        else {
            return this.variable(original.name, original.coef * coefficient);
        }
    }
    variable(name, coefficient = 1) {
        return { name, coef: coefficient };
    }
    equal(variables, value) {
        console.debug(`${this.formatVariableList(variables)} = ${value}`);
        return new ConstraintsWithNewVariables(this.constrain(arraify(variables), { type: Constraint.FIXED_VARIABLE, ub: value, lb: value }));
    }
    greaterEqualThan(variables, lowerBound) {
        console.debug(`${this.formatVariableList(variables)} >= ${lowerBound}`);
        return new ConstraintsWithNewVariables(this.constrain(arraify(variables), { type: Constraint.LOWER_BOUND, ub: 0, lb: lowerBound }));
    }
    lessEqualThan(variables, upperBound) {
        console.debug(`${this.formatVariableList(variables)} <= ${upperBound}`);
        return new ConstraintsWithNewVariables(this.constrain(arraify(variables), { type: Constraint.UPPER_BOUND, ub: upperBound, lb: 0 }));
    }
    sumEqualsZero(...variables) {
        return this.equal(variables, 0);
    }
    sumGreaterThan(variables, lowerBound) {
        return this.greaterEqualThan(variables, lowerBound + 1);
    }
    constrain(vars, bnds) {
        return {
            name: this.constraintName(),
            vars,
            bnds
        };
    }
    constraintName() {
        return 'c' + this._constraintCounter.next();
    }
    solveILP(ilp) {
        const result$ = new ReplaySubject();
        this._solver$.pipe(take(1)).subscribe(glpk => {
            const res = glpk.solve(ilp, {
                msglev: MessageLevel.ERROR,
            });
            res.then((solution) => {
                result$.next({ ilp, solution });
                result$.complete();
            });
        });
        return result$.asObservable();
    }
    formatVariableList(variables) {
        return arraify(variables).map(v => `${v.coef > 0 ? '+' : ''}${v.coef === -1 ? '-' : (v.coef === 1 ? '' : v.coef)}${v.name}`).join(' ');
    }
}
// k and K defined as per https://blog.adamfurmanek.pl/2015/09/12/ilp-part-4/
// for some reason k = 2^19 while not large enough to cause precision problems in either doubles or integers
// has caused the iterative algorithm to loop indefinitely, presumably because of some precision error in the implementation of the solver
IlpSolver.k = (1 << 10) - 1; // 2^10 - 1
IlpSolver.K = 2 * IlpSolver.k + 1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWJzdHJhY3QtaWxwLXNvbHZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvbXBvbmVudHMvc3JjL2xpYi91dGlsaXR5L2dscGsvYWJzdHJhY3QtaWxwLXNvbHZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWEsYUFBYSxFQUFFLElBQUksRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUVyRCxPQUFPLEVBQUMsMkJBQTJCLEVBQUMsTUFBTSxrREFBa0QsQ0FBQztBQUU3RixPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUM1RCxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBQ25DLE9BQU8sRUFBQyxVQUFVLEVBQUUsWUFBWSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFNMUUsTUFBTSxPQUFnQixTQUFTO0lBWTNCLFlBQWdDLFFBQTBCO1FBQTFCLGFBQVEsR0FBUixRQUFRLENBQWtCO1FBQ3RELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7UUFDcEQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQztRQUNsRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7SUFDM0MsQ0FBQztJQUVTLGdCQUFnQixDQUFDLEdBQU8sRUFBRSxXQUF3QztRQUN4RSxJQUFJLEdBQUcsQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUFFO1lBQzdCLEdBQUcsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1NBQ3RCO1FBQ0QsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFL0MsSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBRTtZQUM1QixHQUFHLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztTQUNy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QUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNJLENBQUM7O0FBcFlELDZFQUE2RTtBQUM3RSw0R0FBNEc7QUFDNUcsMElBQTBJO0FBQ2hILFdBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUEsQ0FBQyxXQUFXO0FBQzdCLFdBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge09ic2VydmFibGUsIFJlcGxheVN1YmplY3QsIHRha2V9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge0dMUEssIExQLCBSZXN1bHR9IGZyb20gJ2dscGsuanMnO1xyXG5pbXBvcnQge0NvbnN0cmFpbnRzV2l0aE5ld1ZhcmlhYmxlc30gZnJvbSAnLi4vLi4vbW9kZWxzL2dscGsvY29uc3RyYWludHMtd2l0aC1uZXctdmFyaWFibGVzJztcclxuaW1wb3J0IHtWYXJpYWJsZX0gZnJvbSAnLi4vLi4vbW9kZWxzL2dscGsvdmFyaWFibGUnO1xyXG5pbXBvcnQge0luY3JlbWVudGluZ0NvdW50ZXJ9IGZyb20gJy4uL2luY3JlbWVudGluZy1jb3VudGVyJztcclxuaW1wb3J0IHthcnJhaWZ5fSBmcm9tICcuLi9hcnJhaWZ5JztcclxuaW1wb3J0IHtDb25zdHJhaW50LCBNZXNzYWdlTGV2ZWx9IGZyb20gJy4uLy4uL21vZGVscy9nbHBrL2dscGstY29uc3RhbnRzJztcclxuaW1wb3J0IHtCb3VuZH0gZnJvbSAnLi4vLi4vbW9kZWxzL2dscGsvYm91bmQnO1xyXG5pbXBvcnQge1N1YmplY3RUb30gZnJvbSAnLi4vLi4vbW9kZWxzL2dscGsvc3ViamVjdC10byc7XHJcbmltcG9ydCB7UHJvYmxlbVNvbHV0aW9ufSBmcm9tICcuLi8uLi9tb2RlbHMvZ2xway9wcm9ibGVtLXNvbHV0aW9uJztcclxuXHJcblxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgSWxwU29sdmVyIHtcclxuXHJcbiAgICAvLyBrIGFuZCBLIGRlZmluZWQgYXMgcGVyIGh0dHBzOi8vYmxvZy5hZGFtZnVybWFuZWsucGwvMjAxNS8wOS8xMi9pbHAtcGFydC00L1xyXG4gICAgLy8gZm9yIHNvbWUgcmVhc29uIGsgPSAyXjE5IHdoaWxlIG5vdCBsYXJnZSBlbm91Z2ggdG8gY2F1c2UgcHJlY2lzaW9uIHByb2JsZW1zIGluIGVpdGhlciBkb3VibGVzIG9yIGludGVnZXJzXHJcbiAgICAvLyBoYXMgY2F1c2VkIHRoZSBpdGVyYXRpdmUgYWxnb3JpdGhtIHRvIGxvb3AgaW5kZWZpbml0ZWx5LCBwcmVzdW1hYmx5IGJlY2F1c2Ugb2Ygc29tZSBwcmVjaXNpb24gZXJyb3IgaW4gdGhlIGltcGxlbWVudGF0aW9uIG9mIHRoZSBzb2x2ZXJcclxuICAgIHByb3RlY3RlZCBzdGF0aWMgcmVhZG9ubHkgayA9ICgxIDw8IDEwKSAtIDEgLy8gMl4xMCAtIDFcclxuICAgIHByb3RlY3RlZCBzdGF0aWMgcmVhZG9ubHkgSyA9IDIgKiBJbHBTb2x2ZXIuayArIDE7XHJcblxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBfY29uc3RyYWludENvdW50ZXI6IEluY3JlbWVudGluZ0NvdW50ZXI7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF92YXJpYWJsZUNvdW50ZXI6IEluY3JlbWVudGluZ0NvdW50ZXI7XHJcbiAgICBwcm90ZWN0ZWQgX2FsbFZhcmlhYmxlczogU2V0PHN0cmluZz47XHJcblxyXG4gICAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBfc29sdmVyJDogT2JzZXJ2YWJsZTxHTFBLPikge1xyXG4gICAgICAgIHRoaXMuX2NvbnN0cmFpbnRDb3VudGVyID0gbmV3IEluY3JlbWVudGluZ0NvdW50ZXIoKTtcclxuICAgICAgICB0aGlzLl92YXJpYWJsZUNvdW50ZXIgPSBuZXcgSW5jcmVtZW50aW5nQ291bnRlcigpO1xyXG4gICAgICAgIHRoaXMuX2FsbFZhcmlhYmxlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBhcHBseUNvbnN0cmFpbnRzKGlscDogTFAsIGNvbnN0cmFpbnRzOiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMpIHtcclxuICAgICAgICBpZiAoaWxwLnN1YmplY3RUbyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlscC5zdWJqZWN0VG8gPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWxwLnN1YmplY3RUby5wdXNoKC4uLmNvbnN0cmFpbnRzLmNvbnN0cmFpbnRzKTtcclxuXHJcbiAgICAgICAgaWYgKGlscC5iaW5hcmllcyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlscC5iaW5hcmllcyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpbHAuYmluYXJpZXMucHVzaCguLi5jb25zdHJhaW50cy5iaW5hcnlWYXJpYWJsZXMpO1xyXG5cclxuICAgICAgICBpZiAoaWxwLmdlbmVyYWxzID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaWxwLmdlbmVyYWxzID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlscC5nZW5lcmFscy5wdXNoKC4uLmNvbnN0cmFpbnRzLmludGVnZXJWYXJpYWJsZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBjb21iaW5lQ29lZmZpY2llbnRzKHZhcmlhYmxlczogQXJyYXk8VmFyaWFibGU+KTogQXJyYXk8VmFyaWFibGU+IHtcclxuICAgICAgICBjb25zdCBtYXAgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xyXG4gICAgICAgIGZvciAoY29uc3QgdmFyaWFibGUgb2YgdmFyaWFibGVzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvZWYgPSBtYXAuZ2V0KHZhcmlhYmxlLm5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoY29lZiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBtYXAuc2V0KHZhcmlhYmxlLm5hbWUsIGNvZWYgKyB2YXJpYWJsZS5jb2VmKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG1hcC5zZXQodmFyaWFibGUubmFtZSwgdmFyaWFibGUuY29lZik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHJlc3VsdDogQXJyYXk8VmFyaWFibGU+ID0gW107XHJcbiAgICAgICAgZm9yIChjb25zdCBbbmFtZSwgY29lZl0gb2YgbWFwKSB7XHJcbiAgICAgICAgICAgIGlmIChjb2VmID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh0aGlzLnZhcmlhYmxlKG5hbWUsIGNvZWYpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgY3JlYXRlVmFyaWFibGVzRnJvbVBsYWNlSWRzKHBsYWNlSWRzOiBBcnJheTxzdHJpbmc+LCBjb2VmZmljaWVudDogbnVtYmVyKTogQXJyYXk8VmFyaWFibGU+IHtcclxuICAgICAgICByZXR1cm4gcGxhY2VJZHMubWFwKGlkID0+IHRoaXMudmFyaWFibGUoaWQsIGNvZWZmaWNpZW50KSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGhlbHBlclZhcmlhYmxlTmFtZShwcmVmaXggPSAneScpOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCBoZWxwVmFyaWFibGVOYW1lO1xyXG4gICAgICAgIGRvIHtcclxuICAgICAgICAgICAgaGVscFZhcmlhYmxlTmFtZSA9IGAke3ByZWZpeH0ke3RoaXMuX3ZhcmlhYmxlQ291bnRlci5uZXh0KCl9YDtcclxuICAgICAgICB9IHdoaWxlICh0aGlzLl9hbGxWYXJpYWJsZXMuaGFzKGhlbHBWYXJpYWJsZU5hbWUpKTtcclxuICAgICAgICB0aGlzLl9hbGxWYXJpYWJsZXMuYWRkKGhlbHBWYXJpYWJsZU5hbWUpO1xyXG4gICAgICAgIHJldHVybiBoZWxwVmFyaWFibGVOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCB4QWJzb2x1dGVPZlN1bSh4OiBzdHJpbmcsIHN1bTogQXJyYXk8VmFyaWFibGU+KTogQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzIHtcclxuICAgICAgICAvKlxyXG4gICAgICAgICAqIEFzIHBlciBodHRwczovL2Jsb2cuYWRhbWZ1cm1hbmVrLnBsLzIwMTUvMDkvMTkvaWxwLXBhcnQtNS9cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIHggPj0gMFxyXG4gICAgICAgICAqICh4ICsgc3VtIGlzIDApIG9yICh4IC0gc3VtIGlzIDApID0gMVxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIGNvbnN0IHkgPSB0aGlzLmhlbHBlclZhcmlhYmxlTmFtZSgneUFic1N1bScpOyAvLyB4ICsgc3VtIGlzIDBcclxuICAgICAgICBjb25zdCB6ID0gdGhpcy5oZWxwZXJWYXJpYWJsZU5hbWUoJ3pBYnNTdW0nKTsgLy8geCAtIHN5bSBpcyAwXHJcbiAgICAgICAgY29uc3QgdyA9IHRoaXMuaGVscGVyVmFyaWFibGVOYW1lKCd3QWJzU3VtJyk7IC8vIHkgb3IgelxyXG5cclxuICAgICAgICByZXR1cm4gQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzLmNvbWJpbmVBbmRJbnRyb2R1Y2VWYXJpYWJsZXMoXHJcbiAgICAgICAgICAgIHcsIHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgLy8geCA+PSAwXHJcbiAgICAgICAgICAgIHRoaXMuZ3JlYXRlckVxdWFsVGhhbih0aGlzLnZhcmlhYmxlKHgpLCAwKSxcclxuICAgICAgICAgICAgLy8gdyBpcyB5IG9yIHpcclxuICAgICAgICAgICAgdGhpcy54QW9yQih3LCB5LCB6KSxcclxuICAgICAgICAgICAgLy8gdyBpcyB0cnVlXHJcbiAgICAgICAgICAgIHRoaXMuZXF1YWwodGhpcy52YXJpYWJsZSh3KSwgMSksXHJcbiAgICAgICAgICAgIC8vIHggKyBzdW0gaXMgMFxyXG4gICAgICAgICAgICB0aGlzLnhXaGVuQUVxdWFsc0IoeSwgW3RoaXMudmFyaWFibGUoeCksIC4uLnN1bS5tYXAoYSA9PiB0aGlzLmNyZWF0ZU9yQ29weVZhcmlhYmxlKGEpKV0sIDApLFxyXG4gICAgICAgICAgICAvLyB4IC0gc3VtIGlzIDBcclxuICAgICAgICAgICAgdGhpcy54V2hlbkFFcXVhbHNCKHosIFt0aGlzLnZhcmlhYmxlKHgpLCAuLi5zdW0ubWFwKGEgPT4gdGhpcy5jcmVhdGVPckNvcHlWYXJpYWJsZShhLCAtMSkpXSwgMClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCB4V2hlbkFFcXVhbHNCKHg6IHN0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICBhOiBzdHJpbmcgfCBBcnJheTxzdHJpbmc+IHwgQXJyYXk8VmFyaWFibGU+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGI6IHN0cmluZyB8IG51bWJlcik6IENvbnN0cmFpbnRzV2l0aE5ld1ZhcmlhYmxlcyB7XHJcbiAgICAgICAgLypcclxuICAgICAgICAgICAgIEFzIHBlciBodHRwczovL2Jsb2cuYWRhbWZ1cm1hbmVrLnBsLzIwMTUvMDkvMTIvaWxwLXBhcnQtNC9cclxuXHJcbiAgICAgICAgICAgICB4IGlzIGEgZXF1YWxzIGIgPD0+IGEgZ3JlYXRlciBlcXVhbCB0aGFuIGIgYW5kIGEgbGVzcyBlcXVhbCB0aGFuIGJcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgY29uc3QgeSA9IHRoaXMuaGVscGVyVmFyaWFibGVOYW1lKCd5V2hlbkVxdWFscycpO1xyXG4gICAgICAgIGNvbnN0IHogPSB0aGlzLmhlbHBlclZhcmlhYmxlTmFtZSgneldoZW5FcXVhbHMnKTtcclxuXHJcbiAgICAgICAgY29uc3QgYUdyZWF0ZXJFcXVhbEIgPSB0aGlzLnhXaGVuQUdyZWF0ZXJFcXVhbEIoeSwgYSwgYik7XHJcbiAgICAgICAgY29uc3QgYUxlc3NFcXVhbEIgPSB0aGlzLnhXaGVuQUxlc3NFcXVhbEIoeiwgYSwgYik7XHJcblxyXG4gICAgICAgIHJldHVybiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZUFuZEludHJvZHVjZVZhcmlhYmxlcyhcclxuICAgICAgICAgICAgW3gsIHldLCB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIGFHcmVhdGVyRXF1YWxCLFxyXG4gICAgICAgICAgICBhTGVzc0VxdWFsQixcclxuICAgICAgICAgICAgdGhpcy54QWFuZEIoeCwgeSwgeiksXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgeVdoZW5BR3JlYXRlckVxdWFsQihhOiBzdHJpbmcsIGI6IG51bWJlcik6IENvbnN0cmFpbnRzV2l0aE5ld1ZhcmlhYmxlcyB7XHJcbiAgICAgICAgLypcclxuICAgICAgICAgICAgQXMgcGVyIGh0dHBzOi8vYmxvZy5hZGFtZnVybWFuZWsucGwvMjAxNS8wOS8xMi9pbHAtcGFydC00LyBhbmQgaHR0cHM6Ly9ibG9nLmFkYW1mdXJtYW5lay5wbC8yMDE1LzA4LzIyL2lscC1wYXJ0LTEvXHJcbiAgICAgICAgICAgIHggPSBhID49IGIgY2FuIGJlIGRlZmluZWQgYXMgIShiID4gYSlcclxuICAgICAgICAgICAgdGhlIG5lZ2F0aW9uIGZvciBiaW5hcnkgdmFyaWFibGVzIGNhbiBiZSBleHByZXNzZWQgYXMgKGZvciB4ID0gIXkgYm90aCBiaW5hcnkpIHggPSAxIC0geVxyXG4gICAgICAgICAgICB0aGUgMSAtIHkgZm9ybSBjYW4gYmUgZXh0cmFjdGVkIGFuZCBhZGRlZCB0byB0aGUgY29uc3RyYWludCB0aGF0IHB1dHMgYWxsIGhlbHAgdmFyaWFibGVzIHRvZ2V0aGVyLCB0aGVyZWZvcmUgd2Ugb25seSBuZWVkIHRvIGV4cHJlc3MgeSA9IGIgPiBhXHJcbiAgICAgICAgICAgIGZvciB8YXwsfGJ8IDw9IGsgYW5kIEsgPSAyayArIDFcclxuICAgICAgICAgICAgeSA9IGIgPiBhIGNhbiBiZSBleHByZXNzZWQgYXM6XHJcbiAgICAgICAgICAgIGEgLSBiICsgS3kgPj0gMFxyXG4gICAgICAgICAgICBhIC0gYiArIEt5IDw9IEstMVxyXG5cclxuICAgICAgICAgICAgaW4gb3VyIGNhc2UgYiBpcyBhbHdheXMgYSBjb25zdGFudCBnaXZlbiBieSB0aGUgc29sdXRpb24gKHJlZ2lvbilcclxuICAgICAgICAgICAgdGhlcmVmb3JlIHdlIG9ubHkgaGF2ZSBhIGFuZCB5IGFzIG91ciB2YXJpYWJsZXMgd2hpY2ggZ2l2ZXM6XHJcbiAgICAgICAgICAgIGEgKyBLeSA+PSBiXHJcbiAgICAgICAgICAgIGEgKyBLeSA8PSBLLTEgKyBiXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgY29uc3QgeSA9IHRoaXMuaGVscGVyVmFyaWFibGVOYW1lKCk7XHJcblxyXG4gICAgICAgIGlmIChiID4gSWxwU29sdmVyLmspIHtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhcImJcIiwgYik7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJrXCIsIElscFNvbHZlci5rKTtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYiA+IGsuIFRoaXMgaW1wbGVtZW50YXRpb24gY2FuIG9ubHkgaGFuZGxlIHNvbHV0aW9ucyB0aGF0IGFyZSBhdCBtb3N0IGtcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzLmNvbWJpbmVBbmRJbnRyb2R1Y2VWYXJpYWJsZXMoXHJcbiAgICAgICAgICAgIFt5XSwgdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICB0aGlzLmdyZWF0ZXJFcXVhbFRoYW4oW3RoaXMudmFyaWFibGUoYSksIHRoaXMudmFyaWFibGUoeSwgSWxwU29sdmVyLkspXSwgYiksXHJcbiAgICAgICAgICAgIHRoaXMubGVzc0VxdWFsVGhhbihbdGhpcy52YXJpYWJsZShhKSwgdGhpcy52YXJpYWJsZSh5LCBJbHBTb2x2ZXIuSyldLCBJbHBTb2x2ZXIuSyAtIDEgKyBiKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHhXaGVuQUdyZWF0ZXJFcXVhbEIoeDogc3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGE6IHN0cmluZyB8IEFycmF5PHN0cmluZz4gfCBBcnJheTxWYXJpYWJsZT4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYjogc3RyaW5nIHwgbnVtYmVyKTogQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzIHtcclxuICAgICAgICAvKlxyXG4gICAgICAgICAgICBBcyBwZXIgaHR0cHM6Ly9ibG9nLmFkYW1mdXJtYW5lay5wbC8yMDE1LzA5LzEyL2lscC1wYXJ0LTQvXHJcblxyXG4gICAgICAgICAgICBhIGlzIGdyZWF0ZXIgZXF1YWwgYiA8PT4gbm90IGEgbGVzcyB0aGFuIGJcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgY29uc3QgeiA9IHRoaXMuaGVscGVyVmFyaWFibGVOYW1lKCd6QUxlc3NCJyk7XHJcblxyXG4gICAgICAgIHJldHVybiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZUFuZEludHJvZHVjZVZhcmlhYmxlcyh6LCB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIC8vIHogd2hlbiBhIGxlc3MgdGhhbiBiXHJcbiAgICAgICAgICAgIHRoaXMueFdoZW5BTGVzc0IoeiwgYSwgYiksXHJcbiAgICAgICAgICAgIC8vIHggbm90IHpcclxuICAgICAgICAgICAgdGhpcy54Tm90QSh4LCB6KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHhXaGVuQUxlc3NFcXVhbEIoeDogc3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGE6IHN0cmluZyB8IEFycmF5PHN0cmluZz4gfCBBcnJheTxWYXJpYWJsZT4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYjogc3RyaW5nIHwgbnVtYmVyKTogQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzIHtcclxuICAgICAgICAvKlxyXG4gICAgICAgICAgICBBcyBwZXIgaHR0cHM6Ly9ibG9nLmFkYW1mdXJtYW5lay5wbC8yMDE1LzA5LzEyL2lscC1wYXJ0LTQvXHJcblxyXG4gICAgICAgICAgICBhIGlzIGxlc3MgZXF1YWwgYiA8PT4gbm90IGEgZ3JlYXRlciB0aGFuIGJcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgY29uc3QgeiA9IHRoaXMuaGVscGVyVmFyaWFibGVOYW1lKCd6QUdyZWF0ZXJCJyk7XHJcblxyXG4gICAgICAgIHJldHVybiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZUFuZEludHJvZHVjZVZhcmlhYmxlcyh6LCB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIC8vIHogd2hlbiBhIGdyZWF0ZXIgdGhhbiBiXHJcbiAgICAgICAgICAgIHRoaXMueFdoZW5BR3JlYXRlckIoeiwgYSwgYiksXHJcbiAgICAgICAgICAgIC8vIHggbm90IHpcclxuICAgICAgICAgICAgdGhpcy54Tm90QSh4LCB6KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHhXaGVuQUdyZWF0ZXJCKHg6IHN0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgYTogc3RyaW5nIHwgQXJyYXk8c3RyaW5nPiB8IEFycmF5PFZhcmlhYmxlPiB8IG51bWJlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgYjogc3RyaW5nIHwgQXJyYXk8c3RyaW5nPiB8IEFycmF5PFZhcmlhYmxlPiB8IG51bWJlcik6IENvbnN0cmFpbnRzV2l0aE5ld1ZhcmlhYmxlcyB7XHJcbiAgICAgICAgLypcclxuICAgICAgICAgICAgQXMgcGVyIGh0dHBzOi8vYmxvZy5hZGFtZnVybWFuZWsucGwvMjAxNS8wOS8xMi9pbHAtcGFydC00L1xyXG4gICAgICAgICAgICBhLGIgaW50ZWdlclxyXG4gICAgICAgICAgICB8YXwsfGJ8IDw9IGtcclxuICAgICAgICAgICAgayA9IDJebiAtIDEsIG4gbmF0dXJhbFxyXG4gICAgICAgICAgICBLID0gMmsgKyAxXHJcbiAgICAgICAgICAgIHggYmluYXJ5XHJcblxyXG4gICAgICAgICAgICAwIDw9IGIgLSBhICsgS3ggPD0gSyAtIDFcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgbGV0IGFJc1ZhcmlhYmxlID0gZmFsc2U7XHJcbiAgICAgICAgbGV0IGJJc1ZhcmlhYmxlID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBhID09PSAnc3RyaW5nJyB8fCBBcnJheS5pc0FycmF5KGEpKSB7XHJcbiAgICAgICAgICAgIGFJc1ZhcmlhYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBhID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgYSA9IGFycmFpZnkoYSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiID09PSAnc3RyaW5nJyB8fCBBcnJheS5pc0FycmF5KGIpKSB7XHJcbiAgICAgICAgICAgIGJJc1ZhcmlhYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBiID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgYiA9IGFycmFpZnkoYik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChhSXNWYXJpYWJsZSAmJiBiSXNWYXJpYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzLmNvbWJpbmUoXHJcbiAgICAgICAgICAgICAgICAvLyBiIC0gYSArIEt4ID49IDBcclxuICAgICAgICAgICAgICAgIHRoaXMuZ3JlYXRlckVxdWFsVGhhbihbXHJcbiAgICAgICAgICAgICAgICAgICAgLi4uKGIgYXMgQXJyYXk8c3RyaW5nPiB8IEFycmF5PFZhcmlhYmxlPikubWFwKGIgPT4gdGhpcy5jcmVhdGVPckNvcHlWYXJpYWJsZShiKSksXHJcbiAgICAgICAgICAgICAgICAgICAgLi4uKGEgYXMgQXJyYXk8c3RyaW5nPiB8IEFycmF5PFZhcmlhYmxlPikubWFwKGEgPT4gdGhpcy5jcmVhdGVPckNvcHlWYXJpYWJsZShhLCAtMSkpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFyaWFibGUoeCwgSWxwU29sdmVyLkspXHJcbiAgICAgICAgICAgICAgICBdLCAwKSxcclxuICAgICAgICAgICAgICAgIC8vIGIgLSBhICsgS3ggPD0gSyAtIDFcclxuICAgICAgICAgICAgICAgIHRoaXMubGVzc0VxdWFsVGhhbihbXHJcbiAgICAgICAgICAgICAgICAgICAgLi4uKGIgYXMgQXJyYXk8c3RyaW5nPiB8IEFycmF5PFZhcmlhYmxlPikubWFwKGIgPT4gdGhpcy5jcmVhdGVPckNvcHlWYXJpYWJsZShiKSksXHJcbiAgICAgICAgICAgICAgICAgICAgLi4uKGEgYXMgQXJyYXk8c3RyaW5nPiB8IEFycmF5PFZhcmlhYmxlPikubWFwKGEgPT4gdGhpcy5jcmVhdGVPckNvcHlWYXJpYWJsZShhLCAtMSkpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFyaWFibGUoeCwgSWxwU29sdmVyLkspXHJcbiAgICAgICAgICAgICAgICBdLCBJbHBTb2x2ZXIuSyAtIDEpLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoYUlzVmFyaWFibGUgJiYgIWJJc1ZhcmlhYmxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZShcclxuICAgICAgICAgICAgICAgIC8vIC1hICsgS3ggPj0gLWJcclxuICAgICAgICAgICAgICAgIHRoaXMuZ3JlYXRlckVxdWFsVGhhbihbXHJcbiAgICAgICAgICAgICAgICAgICAgLi4uKGEgYXMgQXJyYXk8c3RyaW5nPiB8IEFycmF5PFZhcmlhYmxlPikubWFwKGEgPT4gdGhpcy5jcmVhdGVPckNvcHlWYXJpYWJsZShhLCAtMSkpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFyaWFibGUoeCwgSWxwU29sdmVyLkspXHJcbiAgICAgICAgICAgICAgICBdLCAtYiksXHJcbiAgICAgICAgICAgICAgICAvLyAtYSArIEt4IDw9IEsgLSBiIC0gMVxyXG4gICAgICAgICAgICAgICAgdGhpcy5sZXNzRXF1YWxUaGFuKFtcclxuICAgICAgICAgICAgICAgICAgICAuLi4oYSBhcyBBcnJheTxzdHJpbmc+IHwgQXJyYXk8VmFyaWFibGU+KS5tYXAoYSA9PiB0aGlzLmNyZWF0ZU9yQ29weVZhcmlhYmxlKGEsIC0xKSksXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52YXJpYWJsZSh4LCBJbHBTb2x2ZXIuSylcclxuICAgICAgICAgICAgICAgIF0sIElscFNvbHZlci5LIC0gKGIgYXMgbnVtYmVyKSAtIDEpLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoIWFJc1ZhcmlhYmxlICYmIGJJc1ZhcmlhYmxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZShcclxuICAgICAgICAgICAgICAgIC8vIGIgKyBLeCA+PSBhXHJcbiAgICAgICAgICAgICAgICB0aGlzLmdyZWF0ZXJFcXVhbFRoYW4oW1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLihiIGFzIEFycmF5PHN0cmluZz4gfCBBcnJheTxWYXJpYWJsZT4pLm1hcChiID0+IHRoaXMuY3JlYXRlT3JDb3B5VmFyaWFibGUoYikpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFyaWFibGUoeCwgSWxwU29sdmVyLkspXHJcbiAgICAgICAgICAgICAgICBdLCBhIGFzIG51bWJlciksXHJcbiAgICAgICAgICAgICAgICAvLyBiICsgS3ggPD0gSyArIGEgLSAxXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxlc3NFcXVhbFRoYW4oW1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLihiIGFzIEFycmF5PHN0cmluZz4gfCBBcnJheTxWYXJpYWJsZT4pLm1hcChiID0+IHRoaXMuY3JlYXRlT3JDb3B5VmFyaWFibGUoYikpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFyaWFibGUoeCwgSWxwU29sdmVyLkspXHJcbiAgICAgICAgICAgICAgICBdLCBJbHBTb2x2ZXIuSyArIChhIGFzIG51bWJlcikgLSAxKSxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVuc3VwcG9ydGVkIGNvbXBhcmlzb24hIHggd2hlbiAke2F9ID4gJHtifWApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgeFdoZW5BTGVzc0IoeDogc3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhOiBzdHJpbmcgfCBBcnJheTxzdHJpbmc+IHwgQXJyYXk8VmFyaWFibGU+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBiOiBzdHJpbmcgfCBudW1iZXIpOiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMge1xyXG4gICAgICAgIC8qXHJcbiAgICAgICAgICAgIEFzIHBlciBodHRwczovL2Jsb2cuYWRhbWZ1cm1hbmVrLnBsLzIwMTUvMDkvMTIvaWxwLXBhcnQtNC9cclxuXHJcbiAgICAgICAgICAgIGEgaXMgbGVzcyB0aGFuIGIgPD0+IGIgaXMgZ3JlYXRlciB0aGFuIGFcclxuICAgICAgICAgKi9cclxuICAgICAgICByZXR1cm4gdGhpcy54V2hlbkFHcmVhdGVyQih4LCBiLCBhKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgeEFhbmRCKHg6IHN0cmluZywgYTogc3RyaW5nLCBiOiBzdHJpbmcpOiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMge1xyXG4gICAgICAgIC8qXHJcbiAgICAgICAgICAgIEFzIHBlciBodHRwOi8vYmxvZy5hZGFtZnVybWFuZWsucGwvMjAxNS8wOC8yMi9pbHAtcGFydC0xL1xyXG4gICAgICAgICAgICBhLGIseCBiaW5hcnlcclxuXHJcbiAgICAgICAgICAgIDAgPD0gYSArIGIgLSAyeCA8PSAxXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgcmV0dXJuIENvbnN0cmFpbnRzV2l0aE5ld1ZhcmlhYmxlcy5jb21iaW5lKFxyXG4gICAgICAgICAgICAvLyBhICsgYiAtMnggPj0gMFxyXG4gICAgICAgICAgICB0aGlzLmdyZWF0ZXJFcXVhbFRoYW4oW3RoaXMudmFyaWFibGUoYSksIHRoaXMudmFyaWFibGUoYiksIHRoaXMudmFyaWFibGUoeCwgLTIpXSwgMCksXHJcbiAgICAgICAgICAgIC8vIGEgKyBiIC0yeCA8PSAxXHJcbiAgICAgICAgICAgIHRoaXMubGVzc0VxdWFsVGhhbihbdGhpcy52YXJpYWJsZShhKSwgdGhpcy52YXJpYWJsZShiKSwgdGhpcy52YXJpYWJsZSh4LCAtMildLCAxKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHhBb3JCKHg6IHN0cmluZywgYTogc3RyaW5nLCBiOiBzdHJpbmcpOiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMge1xyXG4gICAgICAgIC8qXHJcbiAgICAgICAgICAgIEFzIHBlciBodHRwOi8vYmxvZy5hZGFtZnVybWFuZWsucGwvMjAxNS8wOC8yMi9pbHAtcGFydC0xL1xyXG4gICAgICAgICAgICBhLGIseCBiaW5hcnlcclxuXHJcbiAgICAgICAgICAgIC0xIDw9IGEgKyBiIC0gMnggPD0gMFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHJldHVybiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZShcclxuICAgICAgICAgICAgLy8gYSArIGIgLTJ4ID49IC0xXHJcbiAgICAgICAgICAgIHRoaXMuZ3JlYXRlckVxdWFsVGhhbihbdGhpcy52YXJpYWJsZShhKSwgdGhpcy52YXJpYWJsZShiKSwgdGhpcy52YXJpYWJsZSh4LCAtMildLCAtMSksXHJcbiAgICAgICAgICAgIC8vIGEgKyBiIC0yeCA8PSAwXHJcbiAgICAgICAgICAgIHRoaXMubGVzc0VxdWFsVGhhbihbdGhpcy52YXJpYWJsZShhKSwgdGhpcy52YXJpYWJsZShiKSwgdGhpcy52YXJpYWJsZSh4LCAtMildLCAwKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHhOb3RBKHg6IHN0cmluZywgYTogc3RyaW5nKTogQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzIHtcclxuICAgICAgICAvKlxyXG4gICAgICAgICAgICBBcyBwZXIgaHR0cDovL2Jsb2cuYWRhbWZ1cm1hbmVrLnBsLzIwMTUvMDgvMjIvaWxwLXBhcnQtMS9cclxuICAgICAgICAgICAgYSx4IGJpbmFyeVxyXG5cclxuICAgICAgICAgICAgeCA9IDEgLSBhXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgLy8geCArIGEgPSAxXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXF1YWwoW3RoaXMudmFyaWFibGUoeCksIHRoaXMudmFyaWFibGUoYSldLCAxKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZU9yQ29weVZhcmlhYmxlKG9yaWdpbmFsOiBzdHJpbmcgfCBWYXJpYWJsZSwgY29lZmZpY2llbnQ6IG51bWJlciA9IDEpOiBWYXJpYWJsZSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBvcmlnaW5hbCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFyaWFibGUob3JpZ2luYWwsIGNvZWZmaWNpZW50KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy52YXJpYWJsZShvcmlnaW5hbC5uYW1lLCBvcmlnaW5hbC5jb2VmICogY29lZmZpY2llbnQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgdmFyaWFibGUobmFtZTogc3RyaW5nLCBjb2VmZmljaWVudDogbnVtYmVyID0gMSk6IFZhcmlhYmxlIHtcclxuICAgICAgICByZXR1cm4ge25hbWUsIGNvZWY6IGNvZWZmaWNpZW50fTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZXF1YWwodmFyaWFibGVzOiBWYXJpYWJsZSB8IEFycmF5PFZhcmlhYmxlPiwgdmFsdWU6IG51bWJlcik6IENvbnN0cmFpbnRzV2l0aE5ld1ZhcmlhYmxlcyB7XHJcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhgJHt0aGlzLmZvcm1hdFZhcmlhYmxlTGlzdCh2YXJpYWJsZXMpfSA9ICR7dmFsdWV9YCk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXModGhpcy5jb25zdHJhaW4oXHJcbiAgICAgICAgICAgIGFycmFpZnkodmFyaWFibGVzKSxcclxuICAgICAgICAgICAge3R5cGU6IENvbnN0cmFpbnQuRklYRURfVkFSSUFCTEUsIHViOiB2YWx1ZSwgbGI6IHZhbHVlfVxyXG4gICAgICAgICkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBncmVhdGVyRXF1YWxUaGFuKHZhcmlhYmxlczogVmFyaWFibGUgfCBBcnJheTxWYXJpYWJsZT4sIGxvd2VyQm91bmQ6IG51bWJlcik6IENvbnN0cmFpbnRzV2l0aE5ld1ZhcmlhYmxlcyB7XHJcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhgJHt0aGlzLmZvcm1hdFZhcmlhYmxlTGlzdCh2YXJpYWJsZXMpfSA+PSAke2xvd2VyQm91bmR9YCk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXModGhpcy5jb25zdHJhaW4oXHJcbiAgICAgICAgICAgIGFycmFpZnkodmFyaWFibGVzKSxcclxuICAgICAgICAgICAge3R5cGU6IENvbnN0cmFpbnQuTE9XRVJfQk9VTkQsIHViOiAwLCBsYjogbG93ZXJCb3VuZH1cclxuICAgICAgICApKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgbGVzc0VxdWFsVGhhbih2YXJpYWJsZXM6IFZhcmlhYmxlIHwgQXJyYXk8VmFyaWFibGU+LCB1cHBlckJvdW5kOiBudW1iZXIpOiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMge1xyXG4gICAgICAgIGNvbnNvbGUuZGVidWcoYCR7dGhpcy5mb3JtYXRWYXJpYWJsZUxpc3QodmFyaWFibGVzKX0gPD0gJHt1cHBlckJvdW5kfWApO1xyXG4gICAgICAgIHJldHVybiBuZXcgQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzKHRoaXMuY29uc3RyYWluKFxyXG4gICAgICAgICAgICBhcnJhaWZ5KHZhcmlhYmxlcyksXHJcbiAgICAgICAgICAgIHt0eXBlOiBDb25zdHJhaW50LlVQUEVSX0JPVU5ELCB1YjogdXBwZXJCb3VuZCwgbGI6IDB9XHJcbiAgICAgICAgKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHN1bUVxdWFsc1plcm8oLi4udmFyaWFibGVzOiBBcnJheTxWYXJpYWJsZT4pOiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmVxdWFsKHZhcmlhYmxlcywgMCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHN1bUdyZWF0ZXJUaGFuKHZhcmlhYmxlczogQXJyYXk8VmFyaWFibGU+LCBsb3dlckJvdW5kOiBudW1iZXIpOiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdyZWF0ZXJFcXVhbFRoYW4odmFyaWFibGVzLCBsb3dlckJvdW5kICsgMSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb25zdHJhaW4odmFyczogQXJyYXk8VmFyaWFibGU+LCBibmRzOiBCb3VuZCk6IFN1YmplY3RUbyB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbmFtZTogdGhpcy5jb25zdHJhaW50TmFtZSgpLFxyXG4gICAgICAgICAgICB2YXJzLFxyXG4gICAgICAgICAgICBibmRzXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNvbnN0cmFpbnROYW1lKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuICdjJyArIHRoaXMuX2NvbnN0cmFpbnRDb3VudGVyLm5leHQoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgc29sdmVJTFAoaWxwOiBMUCk6IE9ic2VydmFibGU8UHJvYmxlbVNvbHV0aW9uPiB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0JCA9IG5ldyBSZXBsYXlTdWJqZWN0PFByb2JsZW1Tb2x1dGlvbj4oKTtcclxuXHJcbiAgICAgICAgdGhpcy5fc29sdmVyJC5waXBlKHRha2UoMSkpLnN1YnNjcmliZShnbHBrID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcmVzID0gZ2xway5zb2x2ZShpbHAsIHtcclxuICAgICAgICAgICAgICAgIG1zZ2xldjogTWVzc2FnZUxldmVsLkVSUk9SLFxyXG4gICAgICAgICAgICB9KSBhcyB1bmtub3duIGFzIFByb21pc2U8UmVzdWx0PjtcclxuICAgICAgICAgICAgcmVzLnRoZW4oKHNvbHV0aW9uOiBSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCQubmV4dCh7aWxwLCBzb2x1dGlvbn0pO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0JC5hc09ic2VydmFibGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGZvcm1hdFZhcmlhYmxlTGlzdCh2YXJpYWJsZXM6IFZhcmlhYmxlIHwgQXJyYXk8VmFyaWFibGU+KTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gYXJyYWlmeSh2YXJpYWJsZXMpLm1hcCh2ID0+IGAke3YuY29lZiA+IDAgPyAnKycgOiAnJ30ke3YuY29lZiA9PT0gLTEgPyAnLScgOiAodi5jb2VmID09PSAxID8gJycgOiB2LmNvZWYpfSR7di5uYW1lfWApLmpvaW4oJyAnKTtcclxuICAgIH1cclxufVxyXG4iXX0=