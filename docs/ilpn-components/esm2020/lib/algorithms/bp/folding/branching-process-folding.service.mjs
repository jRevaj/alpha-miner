import { Injectable } from '@angular/core';
import { PetriNet } from '../../../models/pn/model/petri-net';
import { Place } from '../../../models/pn/model/place';
import { Transition } from '../../../models/pn/model/transition';
import { FoldingStatus } from './model/folding-status';
import { LogSymbol } from '../../log/log-symbol';
import * as i0 from "@angular/core";
export class BranchingProcessFoldingService {
    constructor() {
    }
    foldPartialOrders(pos) {
        if (pos.length === 0) {
            return new PetriNet();
        }
        const result = pos[0].clone();
        this.addStartEvent(result);
        for (let i = 1; i < pos.length; i++) {
            this.addPoToBranchingProcess(pos[i], result);
        }
        return result;
    }
    addStartEvent(po) {
        const start = new Transition(LogSymbol.START);
        po.addTransition(start);
        for (const p of po.getInputPlaces()) {
            po.addArc(start, p);
        }
        const initial = new Place();
        po.addPlace(initial);
        po.addArc(initial, start);
    }
    addPoToBranchingProcess(po, result) {
        po = po.clone();
        this.addStartEvent(po);
        const conflictQueue = [{
                target: result.getInputPlaces()[0],
                conflict: po.getInputPlaces()[0]
            }];
        conflictResolution: while (conflictQueue.length > 0) {
            const problem = conflictQueue.shift();
            if (problem.conflict.foldingStatus === FoldingStatus.FOLDED) {
                continue;
            }
            if (problem.conflict.foldingStatus === FoldingStatus.CONFLICT) {
                conflictQueue.push(...this.addConflict(problem, result));
                continue;
            }
            const followingEvent = problem.conflict.outgoingArcs[0]?.destination;
            if (followingEvent === undefined) {
                // the conflicting place has no following event => there is no conflict to resolve
                continue;
            }
            if (followingEvent.ingoingArcs.length > 1) {
                for (const a of followingEvent.ingoingArcs) {
                    const p = a.source;
                    if (p === problem.conflict) {
                        continue;
                    }
                    if (p.foldingStatus === FoldingStatus.CONFLICT) {
                        conflictQueue.push(problem);
                        problem.conflict.foldingStatus = FoldingStatus.CONFLICT;
                        continue conflictResolution;
                    }
                    if (p.foldingStatus === undefined) {
                        problem.conflict.foldingStatus = FoldingStatus.PENDING;
                        conflictQueue.push(problem);
                        continue conflictResolution;
                    }
                }
            }
            conflictQueue.push(...this.fold(problem.conflict, problem.target, followingEvent, po, result));
        }
        return result;
    }
    fold(conflict, target, followingEvent, po, result) {
        let folding;
        for (const a of target.outgoingArcs) {
            const foldedEvent = a.destination;
            if (foldedEvent.label !== followingEvent.label) {
                continue;
            }
            folding = this.attemptEventFolding(followingEvent, foldedEvent);
            if (folding !== undefined) {
                break;
            }
        }
        if (folding !== undefined) {
            // the conflict can be resolved and the target place can be folded => move the conflict to the following places
            conflict.foldingStatus = FoldingStatus.FOLDED;
            conflict.foldedPair = target;
            if (followingEvent.ingoingArcs.length > 1) {
                for (const a of followingEvent.ingoingArcs) {
                    const p = a.source;
                    if (p === conflict) {
                        continue;
                    }
                    if (p.foldingStatus !== FoldingStatus.FOLDED) {
                        return [];
                    }
                }
            }
            const r = [];
            for (const [conflictId, targetId] of folding.entries()) {
                r.push({
                    target: result.getPlace(targetId),
                    conflict: po.getPlace(conflictId)
                });
            }
            return r;
        }
        else {
            // the conflict cannot be resolved => add conflict to the folded net
            conflict.foldingStatus = FoldingStatus.CONFLICT;
            return [{ conflict, target }];
        }
    }
    attemptEventFolding(following, folded) {
        if (folded.outgoingArcs.length !== following.outgoingArcs.length) {
            return undefined;
        }
        const mapping = new Map();
        const mapped = new Set();
        const unmapped = following.outgoingArcs.map(a => a.destination);
        while (unmapped.length > 0) {
            const p = unmapped.shift();
            if (p.outgoingArcs.length === 0) {
                if (unmapped.length !== 0) {
                    unmapped.push(p);
                    continue;
                }
                else {
                    for (const af of folded.outgoingArcs) {
                        const pf = af.destination;
                        if (mapped.has(pf.id)) {
                            continue;
                        }
                        mapping.set(p.id, pf.id);
                        break;
                    }
                    break;
                }
            }
            const followLabel = p.outgoingArcs[0].destination.label;
            mappingFor: for (const af of folded.outgoingArcs) {
                const pf = af.destination;
                if (mapped.has(pf.id)) {
                    continue;
                }
                for (const ap of pf.outgoingArcs) {
                    if (ap.destination.label === followLabel) {
                        mapping.set(p.id, pf.id);
                        mapped.add(pf.id);
                        break mappingFor;
                    }
                }
            }
            if (!mapping.has(p.id)) {
                return undefined;
            }
        }
        return mapping;
    }
    addConflict(problem, folded) {
        if (problem.conflict.outgoingArcs.length === 0) {
            return [];
        }
        const original = problem.conflict.outgoingArcs[0].destination;
        let following = original.foldedPair;
        if (following === undefined) {
            following = new Transition(original.label);
            folded.addTransition(following);
        }
        folded.addArc(problem.target, following);
        if (original.foldedPair === undefined) {
            const newConflicts = [];
            for (const out of original.outgoingArcs) {
                const p = new Place();
                folded.addPlace(p);
                folded.addArc(following, p);
                newConflicts.push({ conflict: out.destination, target: p });
            }
            original.foldedPair = following;
            return newConflicts;
        }
        return [];
    }
}
BranchingProcessFoldingService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: BranchingProcessFoldingService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
BranchingProcessFoldingService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: BranchingProcessFoldingService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: BranchingProcessFoldingService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJhbmNoaW5nLXByb2Nlc3MtZm9sZGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvY29tcG9uZW50cy9zcmMvbGliL2FsZ29yaXRobXMvYnAvZm9sZGluZy9icmFuY2hpbmctcHJvY2Vzcy1mb2xkaW5nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sb0NBQW9DLENBQUM7QUFDNUQsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBQ3JELE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUUvRCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFDckQsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLHNCQUFzQixDQUFDOztBQU0vQyxNQUFNLE9BQU8sOEJBQThCO0lBRXZDO0lBQ0EsQ0FBQztJQUVNLGlCQUFpQixDQUFDLEdBQW9CO1FBQ3pDLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDbEIsT0FBTyxJQUFJLFFBQVEsRUFBRSxDQUFDO1NBQ3pCO1FBQ0QsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFM0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDakMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUNoRDtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFTyxhQUFhLENBQUMsRUFBWTtRQUM5QixNQUFNLEtBQUssR0FBRyxJQUFJLFVBQVUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4QixLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxjQUFjLEVBQUUsRUFBRTtZQUNqQyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztTQUN2QjtRQUNELE1BQU0sT0FBTyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7UUFDNUIsRUFBRSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNyQixFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRU8sdUJBQXVCLENBQUMsRUFBWSxFQUFFLE1BQWdCO1FBQzFELEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUV2QixNQUFNLGFBQWEsR0FBNEIsQ0FBQztnQkFDNUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLFFBQVEsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ25DLENBQUMsQ0FBQztRQUVILGtCQUFrQixFQUNsQixPQUFPLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzdCLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxLQUFLLEVBQUcsQ0FBQztZQUV2QyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsYUFBYSxLQUFLLGFBQWEsQ0FBQyxNQUFNLEVBQUU7Z0JBQ3pELFNBQVM7YUFDWjtZQUVELElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQyxhQUFhLEtBQUssYUFBYSxDQUFDLFFBQVEsRUFBRTtnQkFDM0QsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUE7Z0JBQ3hELFNBQVM7YUFDWjtZQUVELE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLFdBQXlCLENBQUM7WUFDbkYsSUFBSSxjQUFjLEtBQUssU0FBUyxFQUFFO2dCQUM5QixrRkFBa0Y7Z0JBQ2xGLFNBQVM7YUFDWjtZQUVELElBQUksY0FBYyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUN2QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxXQUFXLEVBQUU7b0JBQ3hDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFlLENBQUM7b0JBQzVCLElBQUksQ0FBQyxLQUFLLE9BQU8sQ0FBQyxRQUFRLEVBQUU7d0JBQ3hCLFNBQVM7cUJBQ1o7b0JBQ0QsSUFBSSxDQUFDLENBQUMsYUFBYSxLQUFLLGFBQWEsQ0FBQyxRQUFRLEVBQUU7d0JBQzVDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQzVCLE9BQU8sQ0FBQyxRQUFRLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUM7d0JBQ3hELFNBQVMsa0JBQWtCLENBQUM7cUJBQy9CO29CQUNELElBQUksQ0FBQyxDQUFDLGFBQWEsS0FBSyxTQUFTLEVBQUU7d0JBQy9CLE9BQU8sQ0FBQyxRQUFRLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUM7d0JBQ3ZELGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQzVCLFNBQVMsa0JBQWtCLENBQUM7cUJBQy9CO2lCQUNKO2FBQ0o7WUFFRCxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQ2xHO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVPLElBQUksQ0FBQyxRQUFlLEVBQUUsTUFBYSxFQUFFLGNBQTBCLEVBQUUsRUFBWSxFQUFFLE1BQWdCO1FBQ25HLElBQUksT0FBd0MsQ0FBQztRQUM3QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxZQUFZLEVBQUU7WUFDakMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDLFdBQXlCLENBQUM7WUFDaEQsSUFBSSxXQUFXLENBQUMsS0FBSyxLQUFLLGNBQWMsQ0FBQyxLQUFLLEVBQUU7Z0JBQzVDLFNBQVM7YUFDWjtZQUVELE9BQU8sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsY0FBYyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ2hFLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtnQkFDdkIsTUFBTTthQUNUO1NBQ0o7UUFFRCxJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUU7WUFDdkIsK0dBQStHO1lBQy9HLFFBQVEsQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQztZQUM5QyxRQUFRLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQztZQUU3QixJQUFJLGNBQWMsQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDdkMsS0FBSyxNQUFNLENBQUMsSUFBSSxjQUFjLENBQUMsV0FBVyxFQUFFO29CQUN4QyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBZSxDQUFDO29CQUM1QixJQUFJLENBQUMsS0FBSyxRQUFRLEVBQUU7d0JBQ2hCLFNBQVM7cUJBQ1o7b0JBQ0QsSUFBSSxDQUFDLENBQUMsYUFBYSxLQUFLLGFBQWEsQ0FBQyxNQUFNLEVBQUU7d0JBQzFDLE9BQU8sRUFBRSxDQUFDO3FCQUNiO2lCQUNKO2FBQ0o7WUFFRCxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDYixLQUFLLE1BQU0sQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNILE1BQU0sRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBRTtvQkFDbEMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFFO2lCQUNyQyxDQUFDLENBQUM7YUFDTjtZQUNELE9BQU8sQ0FBQyxDQUFDO1NBQ1o7YUFBTTtZQUNILG9FQUFvRTtZQUNwRSxRQUFRLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUM7WUFDaEQsT0FBTyxDQUFDLEVBQUMsUUFBUSxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7U0FDL0I7SUFDTCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsU0FBcUIsRUFBRSxNQUFrQjtRQUNqRSxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFO1lBQzlELE9BQU8sU0FBUyxDQUFDO1NBQ3BCO1FBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7UUFDMUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUVqQyxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFvQixDQUFDLENBQUM7UUFFekUsT0FBTyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN4QixNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxFQUFHLENBQUM7WUFFNUIsSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQzdCLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQ3ZCLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2pCLFNBQVM7aUJBQ1o7cUJBQU07b0JBQ0gsS0FBSyxNQUFNLEVBQUUsSUFBSSxNQUFNLENBQUMsWUFBWSxFQUFFO3dCQUNsQyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsV0FBb0IsQ0FBQzt3QkFDbkMsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFHLENBQUMsRUFBRTs0QkFDcEIsU0FBUzt5QkFDWjt3QkFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUcsQ0FBQyxDQUFDO3dCQUMzQixNQUFNO3FCQUNUO29CQUNELE1BQU07aUJBQ1Q7YUFDSjtZQUVELE1BQU0sV0FBVyxHQUFJLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBMEIsQ0FBQyxLQUFLLENBQUM7WUFFeEUsVUFBVSxFQUNOLEtBQUssTUFBTSxFQUFFLElBQUksTUFBTSxDQUFDLFlBQVksRUFBRTtnQkFDbEMsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQW9CLENBQUM7Z0JBQ25DLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRyxDQUFDLEVBQUU7b0JBQ3BCLFNBQVM7aUJBQ1o7Z0JBRUQsS0FBSyxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsWUFBWSxFQUFFO29CQUM5QixJQUFLLEVBQUUsQ0FBQyxXQUEwQixDQUFDLEtBQUssS0FBSyxXQUFXLEVBQUU7d0JBQ3RELE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUcsRUFBRSxFQUFFLENBQUMsRUFBRyxDQUFDLENBQUM7d0JBQzNCLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUcsQ0FBQyxDQUFDO3dCQUNuQixNQUFNLFVBQVUsQ0FBQztxQkFDcEI7aUJBQ0o7YUFDSjtZQUVMLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFHLENBQUMsRUFBRTtnQkFDckIsT0FBTyxTQUFTLENBQUM7YUFDcEI7U0FDSjtRQUVELE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7SUFFTyxXQUFXLENBQUMsT0FBeUIsRUFBRSxNQUFnQjtRQUMzRCxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDNUMsT0FBTyxFQUFFLENBQUM7U0FDYjtRQUVELE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQXlCLENBQUM7UUFFNUUsSUFBSSxTQUFTLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBQztRQUNwQyxJQUFJLFNBQVMsS0FBSyxTQUFTLEVBQUU7WUFDekIsU0FBUyxHQUFHLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQyxNQUFNLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ25DO1FBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXpDLElBQUksUUFBUSxDQUFDLFVBQVUsS0FBSyxTQUFTLEVBQUU7WUFDbkMsTUFBTSxZQUFZLEdBQTRCLEVBQUUsQ0FBQztZQUNqRCxLQUFLLE1BQU0sR0FBRyxJQUFJLFFBQVEsQ0FBQyxZQUFZLEVBQUU7Z0JBQ3JDLE1BQU0sQ0FBQyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7Z0JBQ3RCLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25CLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxXQUFvQixFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUMsQ0FBQyxDQUFDO2FBQ3RFO1lBRUQsUUFBUSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7WUFDaEMsT0FBTyxZQUFZLENBQUM7U0FDdkI7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7OzJIQXJOUSw4QkFBOEI7K0hBQTlCLDhCQUE4QixjQUYzQixNQUFNOzJGQUVULDhCQUE4QjtrQkFIMUMsVUFBVTttQkFBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge1BldHJpTmV0fSBmcm9tICcuLi8uLi8uLi9tb2RlbHMvcG4vbW9kZWwvcGV0cmktbmV0JztcclxuaW1wb3J0IHtQbGFjZX0gZnJvbSAnLi4vLi4vLi4vbW9kZWxzL3BuL21vZGVsL3BsYWNlJztcclxuaW1wb3J0IHtUcmFuc2l0aW9ufSBmcm9tICcuLi8uLi8uLi9tb2RlbHMvcG4vbW9kZWwvdHJhbnNpdGlvbic7XHJcbmltcG9ydCB7Q29uZmxpY3RpbmdQbGFjZX0gZnJvbSAnLi9tb2RlbC9jb25mbGljdGluZy1wbGFjZSc7XHJcbmltcG9ydCB7Rm9sZGluZ1N0YXR1c30gZnJvbSAnLi9tb2RlbC9mb2xkaW5nLXN0YXR1cyc7XHJcbmltcG9ydCB7TG9nU3ltYm9sfSBmcm9tICcuLi8uLi9sb2cvbG9nLXN5bWJvbCc7XHJcblxyXG5cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBCcmFuY2hpbmdQcm9jZXNzRm9sZGluZ1NlcnZpY2Uge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmb2xkUGFydGlhbE9yZGVycyhwb3M6IEFycmF5PFBldHJpTmV0Pik6IFBldHJpTmV0IHtcclxuICAgICAgICBpZiAocG9zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFBldHJpTmV0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHBvc1swXS5jbG9uZSgpO1xyXG4gICAgICAgIHRoaXMuYWRkU3RhcnRFdmVudChyZXN1bHQpO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHBvcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB0aGlzLmFkZFBvVG9CcmFuY2hpbmdQcm9jZXNzKHBvc1tpXSwgcmVzdWx0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhZGRTdGFydEV2ZW50KHBvOiBQZXRyaU5ldCkge1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gbmV3IFRyYW5zaXRpb24oTG9nU3ltYm9sLlNUQVJUKTtcclxuICAgICAgICBwby5hZGRUcmFuc2l0aW9uKHN0YXJ0KTtcclxuICAgICAgICBmb3IgKGNvbnN0IHAgb2YgcG8uZ2V0SW5wdXRQbGFjZXMoKSkge1xyXG4gICAgICAgICAgICBwby5hZGRBcmMoc3RhcnQsIHApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBpbml0aWFsID0gbmV3IFBsYWNlKCk7XHJcbiAgICAgICAgcG8uYWRkUGxhY2UoaW5pdGlhbCk7XHJcbiAgICAgICAgcG8uYWRkQXJjKGluaXRpYWwsIHN0YXJ0KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFkZFBvVG9CcmFuY2hpbmdQcm9jZXNzKHBvOiBQZXRyaU5ldCwgcmVzdWx0OiBQZXRyaU5ldCkge1xyXG4gICAgICAgIHBvID0gcG8uY2xvbmUoKTtcclxuICAgICAgICB0aGlzLmFkZFN0YXJ0RXZlbnQocG8pO1xyXG5cclxuICAgICAgICBjb25zdCBjb25mbGljdFF1ZXVlOiBBcnJheTxDb25mbGljdGluZ1BsYWNlPiA9IFt7XHJcbiAgICAgICAgICAgIHRhcmdldDogcmVzdWx0LmdldElucHV0UGxhY2VzKClbMF0sXHJcbiAgICAgICAgICAgIGNvbmZsaWN0OiBwby5nZXRJbnB1dFBsYWNlcygpWzBdXHJcbiAgICAgICAgfV07XHJcblxyXG4gICAgICAgIGNvbmZsaWN0UmVzb2x1dGlvbjpcclxuICAgICAgICB3aGlsZSAoY29uZmxpY3RRdWV1ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByb2JsZW0gPSBjb25mbGljdFF1ZXVlLnNoaWZ0KCkhO1xyXG5cclxuICAgICAgICAgICAgaWYgKHByb2JsZW0uY29uZmxpY3QuZm9sZGluZ1N0YXR1cyA9PT0gRm9sZGluZ1N0YXR1cy5GT0xERUQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAocHJvYmxlbS5jb25mbGljdC5mb2xkaW5nU3RhdHVzID09PSBGb2xkaW5nU3RhdHVzLkNPTkZMSUNUKSB7XHJcbiAgICAgICAgICAgICAgICBjb25mbGljdFF1ZXVlLnB1c2goLi4udGhpcy5hZGRDb25mbGljdChwcm9ibGVtLCByZXN1bHQpKVxyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGZvbGxvd2luZ0V2ZW50ID0gcHJvYmxlbS5jb25mbGljdC5vdXRnb2luZ0FyY3NbMF0/LmRlc3RpbmF0aW9uIGFzIFRyYW5zaXRpb247XHJcbiAgICAgICAgICAgIGlmIChmb2xsb3dpbmdFdmVudCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAvLyB0aGUgY29uZmxpY3RpbmcgcGxhY2UgaGFzIG5vIGZvbGxvd2luZyBldmVudCA9PiB0aGVyZSBpcyBubyBjb25mbGljdCB0byByZXNvbHZlXHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGZvbGxvd2luZ0V2ZW50LmluZ29pbmdBcmNzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgYSBvZiBmb2xsb3dpbmdFdmVudC5pbmdvaW5nQXJjcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBhLnNvdXJjZSBhcyBQbGFjZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gcHJvYmxlbS5jb25mbGljdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAuZm9sZGluZ1N0YXR1cyA9PT0gRm9sZGluZ1N0YXR1cy5DT05GTElDVCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25mbGljdFF1ZXVlLnB1c2gocHJvYmxlbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2JsZW0uY29uZmxpY3QuZm9sZGluZ1N0YXR1cyA9IEZvbGRpbmdTdGF0dXMuQ09ORkxJQ1Q7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGNvbmZsaWN0UmVzb2x1dGlvbjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAuZm9sZGluZ1N0YXR1cyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2JsZW0uY29uZmxpY3QuZm9sZGluZ1N0YXR1cyA9IEZvbGRpbmdTdGF0dXMuUEVORElORztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmxpY3RRdWV1ZS5wdXNoKHByb2JsZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBjb25mbGljdFJlc29sdXRpb247XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25mbGljdFF1ZXVlLnB1c2goLi4udGhpcy5mb2xkKHByb2JsZW0uY29uZmxpY3QsIHByb2JsZW0udGFyZ2V0LCBmb2xsb3dpbmdFdmVudCwgcG8sIHJlc3VsdCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGZvbGQoY29uZmxpY3Q6IFBsYWNlLCB0YXJnZXQ6IFBsYWNlLCBmb2xsb3dpbmdFdmVudDogVHJhbnNpdGlvbiwgcG86IFBldHJpTmV0LCByZXN1bHQ6IFBldHJpTmV0KTogQXJyYXk8Q29uZmxpY3RpbmdQbGFjZT4ge1xyXG4gICAgICAgIGxldCBmb2xkaW5nOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGZvciAoY29uc3QgYSBvZiB0YXJnZXQub3V0Z29pbmdBcmNzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvbGRlZEV2ZW50ID0gYS5kZXN0aW5hdGlvbiBhcyBUcmFuc2l0aW9uO1xyXG4gICAgICAgICAgICBpZiAoZm9sZGVkRXZlbnQubGFiZWwgIT09IGZvbGxvd2luZ0V2ZW50LmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9sZGluZyA9IHRoaXMuYXR0ZW1wdEV2ZW50Rm9sZGluZyhmb2xsb3dpbmdFdmVudCwgZm9sZGVkRXZlbnQpO1xyXG4gICAgICAgICAgICBpZiAoZm9sZGluZyAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGZvbGRpbmcgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAvLyB0aGUgY29uZmxpY3QgY2FuIGJlIHJlc29sdmVkIGFuZCB0aGUgdGFyZ2V0IHBsYWNlIGNhbiBiZSBmb2xkZWQgPT4gbW92ZSB0aGUgY29uZmxpY3QgdG8gdGhlIGZvbGxvd2luZyBwbGFjZXNcclxuICAgICAgICAgICAgY29uZmxpY3QuZm9sZGluZ1N0YXR1cyA9IEZvbGRpbmdTdGF0dXMuRk9MREVEO1xyXG4gICAgICAgICAgICBjb25mbGljdC5mb2xkZWRQYWlyID0gdGFyZ2V0O1xyXG5cclxuICAgICAgICAgICAgaWYgKGZvbGxvd2luZ0V2ZW50LmluZ29pbmdBcmNzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgYSBvZiBmb2xsb3dpbmdFdmVudC5pbmdvaW5nQXJjcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBhLnNvdXJjZSBhcyBQbGFjZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocCA9PT0gY29uZmxpY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwLmZvbGRpbmdTdGF0dXMgIT09IEZvbGRpbmdTdGF0dXMuRk9MREVEKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHIgPSBbXTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBbY29uZmxpY3RJZCwgdGFyZ2V0SWRdIG9mIGZvbGRpbmcuZW50cmllcygpKSB7XHJcbiAgICAgICAgICAgICAgICByLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldDogcmVzdWx0LmdldFBsYWNlKHRhcmdldElkKSEsXHJcbiAgICAgICAgICAgICAgICAgICAgY29uZmxpY3Q6IHBvLmdldFBsYWNlKGNvbmZsaWN0SWQpIVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gdGhlIGNvbmZsaWN0IGNhbm5vdCBiZSByZXNvbHZlZCA9PiBhZGQgY29uZmxpY3QgdG8gdGhlIGZvbGRlZCBuZXRcclxuICAgICAgICAgICAgY29uZmxpY3QuZm9sZGluZ1N0YXR1cyA9IEZvbGRpbmdTdGF0dXMuQ09ORkxJQ1Q7XHJcbiAgICAgICAgICAgIHJldHVybiBbe2NvbmZsaWN0LCB0YXJnZXR9XTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhdHRlbXB0RXZlbnRGb2xkaW5nKGZvbGxvd2luZzogVHJhbnNpdGlvbiwgZm9sZGVkOiBUcmFuc2l0aW9uKTogTWFwPHN0cmluZywgc3RyaW5nPiB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgaWYgKGZvbGRlZC5vdXRnb2luZ0FyY3MubGVuZ3RoICE9PSBmb2xsb3dpbmcub3V0Z29pbmdBcmNzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbWFwcGluZyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcbiAgICAgICAgY29uc3QgbWFwcGVkID0gbmV3IFNldDxzdHJpbmc+KCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHVubWFwcGVkID0gZm9sbG93aW5nLm91dGdvaW5nQXJjcy5tYXAoYSA9PiBhLmRlc3RpbmF0aW9uIGFzIFBsYWNlKTtcclxuXHJcbiAgICAgICAgd2hpbGUgKHVubWFwcGVkLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgcCA9IHVubWFwcGVkLnNoaWZ0KCkhO1xyXG5cclxuICAgICAgICAgICAgaWYgKHAub3V0Z29pbmdBcmNzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHVubWFwcGVkLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVubWFwcGVkLnB1c2gocCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgYWYgb2YgZm9sZGVkLm91dGdvaW5nQXJjcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwZiA9IGFmLmRlc3RpbmF0aW9uIGFzIFBsYWNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFwcGVkLmhhcyhwZi5pZCEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXBwaW5nLnNldChwLmlkISwgcGYuaWQhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBmb2xsb3dMYWJlbCA9IChwLm91dGdvaW5nQXJjc1swXS5kZXN0aW5hdGlvbiBhcyBUcmFuc2l0aW9uKS5sYWJlbDtcclxuXHJcbiAgICAgICAgICAgIG1hcHBpbmdGb3I6XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGFmIG9mIGZvbGRlZC5vdXRnb2luZ0FyY3MpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBwZiA9IGFmLmRlc3RpbmF0aW9uIGFzIFBsYWNlO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtYXBwZWQuaGFzKHBmLmlkISkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGFwIG9mIHBmLm91dGdvaW5nQXJjcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGFwLmRlc3RpbmF0aW9uIGFzIFRyYW5zaXRpb24pLmxhYmVsID09PSBmb2xsb3dMYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwcGluZy5zZXQocC5pZCEsIHBmLmlkISk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBwZWQuYWRkKHBmLmlkISk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBtYXBwaW5nRm9yO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFtYXBwaW5nLmhhcyhwLmlkISkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBtYXBwaW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWRkQ29uZmxpY3QocHJvYmxlbTogQ29uZmxpY3RpbmdQbGFjZSwgZm9sZGVkOiBQZXRyaU5ldCk6IEFycmF5PENvbmZsaWN0aW5nUGxhY2U+IHtcclxuICAgICAgICBpZiAocHJvYmxlbS5jb25mbGljdC5vdXRnb2luZ0FyY3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG9yaWdpbmFsID0gcHJvYmxlbS5jb25mbGljdC5vdXRnb2luZ0FyY3NbMF0uZGVzdGluYXRpb24gYXMgVHJhbnNpdGlvbjtcclxuXHJcbiAgICAgICAgbGV0IGZvbGxvd2luZyA9IG9yaWdpbmFsLmZvbGRlZFBhaXI7XHJcbiAgICAgICAgaWYgKGZvbGxvd2luZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGZvbGxvd2luZyA9IG5ldyBUcmFuc2l0aW9uKG9yaWdpbmFsLmxhYmVsKTtcclxuICAgICAgICAgICAgZm9sZGVkLmFkZFRyYW5zaXRpb24oZm9sbG93aW5nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvbGRlZC5hZGRBcmMocHJvYmxlbS50YXJnZXQsIGZvbGxvd2luZyk7XHJcblxyXG4gICAgICAgIGlmIChvcmlnaW5hbC5mb2xkZWRQYWlyID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgY29uc3QgbmV3Q29uZmxpY3RzOiBBcnJheTxDb25mbGljdGluZ1BsYWNlPiA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IG91dCBvZiBvcmlnaW5hbC5vdXRnb2luZ0FyY3MpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBuZXcgUGxhY2UoKTtcclxuICAgICAgICAgICAgICAgIGZvbGRlZC5hZGRQbGFjZShwKTtcclxuICAgICAgICAgICAgICAgIGZvbGRlZC5hZGRBcmMoZm9sbG93aW5nLCBwKTtcclxuICAgICAgICAgICAgICAgIG5ld0NvbmZsaWN0cy5wdXNoKHtjb25mbGljdDogb3V0LmRlc3RpbmF0aW9uIGFzIFBsYWNlLCB0YXJnZXQ6IHB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgb3JpZ2luYWwuZm9sZGVkUGFpciA9IGZvbGxvd2luZztcclxuICAgICAgICAgICAgcmV0dXJuIG5ld0NvbmZsaWN0cztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==