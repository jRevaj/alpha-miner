import { ArcWeightIlpSolver } from '../../../../utility/glpk/ArcWeightIlpSolver';
import { concatMap, from, toArray } from 'rxjs';
import { VariableName } from '../../../../utility/glpk/model/variable-name';
import { DirectlyFollowsExtractor } from '../../../../utility/directly-follows-extractor';
import { Goal } from '../../../../models/glpk/glpk-constants';
export class Ilp2MinerIlpSolver extends ArcWeightIlpSolver {
    constructor(solver$) {
        super(solver$);
        this._directlyFollowsExtractor = new DirectlyFollowsExtractor();
        this._poVariableNames = new Set();
    }
    findSolutions(pos) {
        const baseIlpConstraints = [];
        if (Array.isArray(pos)) {
            // creates tokenflow system with unique variables for each partial order
            for (let i = 0; i < pos.length; i++) {
                const events = pos[i].events;
                for (const e of events) {
                    baseIlpConstraints.push(...this.firingRule(e, i));
                    baseIlpConstraints.push(...this.tokenFlow(e, i));
                }
                baseIlpConstraints.push(...this.initialMarking(events, i));
            }
        }
        else {
            // uses the combined branching process to reduce the number of unique variables
            const events = pos.getTransitions();
            for (const e of events) {
                baseIlpConstraints.push(...this.branchingProcessFiringRule(e));
                baseIlpConstraints.push(...this.branchingProcessTokenFlow(e));
            }
        }
        const baseIlp = this.setUpBaseIlp();
        const problems = this._directlyFollowsExtractor.oneWayDirectlyFollows().map(pair => ({
            baseIlpConstraints,
            baseIlp,
            pair
        }));
        return from(problems).pipe(concatMap(problem => {
            return this.solveILP(this.populateIlp(problem.baseIlp, problem.baseIlpConstraints, problem.pair));
        }), toArray());
    }
    firingRule(event, i) {
        const variables = [this.variable(this.getPoEventId(event.id, i))];
        for (const pre of event.previousEvents) {
            variables.push(this.variable(this.getPoArcId(pre.id, event.id, i)));
            this._directlyFollowsExtractor.add(event.label, pre.label);
        }
        variables.push(this.variable(this.transitionVariableName(event.label, VariableName.INGOING_ARC_WEIGHT_PREFIX), -1));
        return this.greaterEqualThan(variables, 0).constraints;
    }
    tokenFlow(event, i) {
        const variables = [this.variable(this.getPoEventId(event.id, i))];
        for (const pre of event.previousEvents) {
            variables.push(this.variable(this.getPoArcId(pre.id, event.id, i)));
        }
        for (const post of event.nextEvents) {
            variables.push(this.variable(this.getPoArcId(event.id, post.id, i), -1));
        }
        if (event.nextEvents.size === 0) {
            variables.push(this.variable(this.getPoArcId(event.id, Ilp2MinerIlpSolver.FINAL_MARKING, i), -1));
        }
        variables.push(this.variable(this.transitionVariableName(event.label, VariableName.INGOING_ARC_WEIGHT_PREFIX), -1));
        variables.push(this.variable(this.transitionVariableName(event.label, VariableName.OUTGOING_ARC_WEIGHT_PREFIX)));
        return this.equal(variables, 0).constraints;
    }
    initialMarking(events, i) {
        const variables = events.map(e => this.variable(this.getPoEventId(e.id, i), -1));
        variables.push(this.variable(VariableName.INITIAL_MARKING));
        return this.equal(variables, 0).constraints;
    }
    getPoEventId(id, i) {
        const d = `${i}${Ilp2MinerIlpSolver.PO_ARC_SEPARATOR}${id}`;
        this._poVariableNames.add(d);
        return d;
    }
    getPoArcId(sourceId, destinationId, i) {
        const id = `${i}${Ilp2MinerIlpSolver.PO_ARC_SEPARATOR}${sourceId}${Ilp2MinerIlpSolver.PO_ARC_SEPARATOR}${destinationId}`;
        this._poVariableNames.add(id);
        return id;
    }
    branchingProcessFiringRule(event) {
        const variables = event.ingoingArcs.map(a => {
            const p = a.source;
            for (const aa of p.ingoingArcs) {
                let source = aa.source;
                this._directlyFollowsExtractor.add(event.label, source.label);
            }
            return this.variable(this.getPlaceVariable(p));
        });
        variables.push(this.variable(this.transitionVariableName(event.label, VariableName.INGOING_ARC_WEIGHT_PREFIX), -1));
        return this.greaterEqualThan(variables, 0).constraints;
    }
    branchingProcessTokenFlow(event) {
        const variables = event.ingoingArcs.map(a => this.variable(this.getPlaceVariable(a.source)));
        variables.push(this.variable(this.transitionVariableName(event.label, VariableName.INGOING_ARC_WEIGHT_PREFIX), -1));
        variables.push(this.variable(this.transitionVariableName(event.label, VariableName.OUTGOING_ARC_WEIGHT_PREFIX)));
        variables.push(...event.outgoingArcs.map(a => this.variable(this.getPlaceVariable(a.destination), -1)));
        return this.equal(variables, 0).constraints;
    }
    getPlaceVariable(place) {
        if (place.ingoingArcs.length === 0) {
            return VariableName.INITIAL_MARKING;
        }
        this._poVariableNames.add(place.id);
        return place.id;
    }
    setUpBaseIlp() {
        const goalVariables = Array.from(this._allVariables).concat(VariableName.INITIAL_MARKING);
        return {
            name: 'ilp',
            objective: {
                name: 'goal',
                direction: Goal.MINIMUM,
                // vars: goalVariables.map(v => {
                //     let coef;
                //     if (v.startsWith(VariableName.INITIAL_MARKING)) {
                //         coef = 30;
                //     } else if (v.startsWith(VariableName.OUTGOING_ARC_WEIGHT_PREFIX)) {
                //         coef = 10;
                //     } else {
                //         coef = -1;
                //     }
                //     return this.variable(v, coef);
                // })
                vars: Array.from(this._poVariableNames).map(v => {
                    return this.variable(v, 1);
                })
            },
            subjectTo: [],
            // TODO enable arc weights with a config setting?
            binaries: goalVariables,
            generals: Array.from(this._poVariableNames)
        };
    }
    populateIlp(baseIlp, baseConstraints, causalPair) {
        const result = Object.assign({}, baseIlp);
        result.subjectTo = [...baseConstraints];
        result.subjectTo = result.subjectTo.concat(this.greaterEqualThan(this.variable(this.transitionVariableName(causalPair[0], VariableName.OUTGOING_ARC_WEIGHT_PREFIX)), 1).constraints);
        result.subjectTo = result.subjectTo.concat(this.greaterEqualThan(this.variable(this.transitionVariableName(causalPair[1], VariableName.INGOING_ARC_WEIGHT_PREFIX)), 1).constraints);
        return result;
    }
}
Ilp2MinerIlpSolver.PO_ARC_SEPARATOR = '#';
Ilp2MinerIlpSolver.FINAL_MARKING = 'mf';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWxwMi1taW5lci1pbHAtc29sdmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvY29tcG9uZW50cy9zcmMvbGliL2FsZ29yaXRobXMvcG4vc3ludGhlc2lzL2lscDItbWluZXIvaWxwMi1taW5lci1pbHAtc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLDZDQUE2QyxDQUFDO0FBQy9FLE9BQU8sRUFBQyxTQUFTLEVBQUUsSUFBSSxFQUFjLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQU0xRCxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sOENBQThDLENBQUM7QUFDMUUsT0FBTyxFQUFDLHdCQUF3QixFQUFDLE1BQU0sZ0RBQWdELENBQUM7QUFDeEYsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLHdDQUF3QyxDQUFDO0FBTTVELE1BQU0sT0FBTyxrQkFBbUIsU0FBUSxrQkFBa0I7SUFRdEQsWUFBWSxPQUF5QjtRQUNqQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDZixJQUFJLENBQUMseUJBQXlCLEdBQUcsSUFBSSx3QkFBd0IsRUFBRSxDQUFDO1FBQ2hFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO0lBQzlDLENBQUM7SUFFTSxhQUFhLENBQUMsR0FBbUM7UUFDcEQsTUFBTSxrQkFBa0IsR0FBcUIsRUFBRSxDQUFDO1FBRWhELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNwQix3RUFBd0U7WUFFeEUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ2pDLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7Z0JBQzdCLEtB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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0FyY1dlaWdodElscFNvbHZlcn0gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbGl0eS9nbHBrL0FyY1dlaWdodElscFNvbHZlcic7XHJcbmltcG9ydCB7Y29uY2F0TWFwLCBmcm9tLCBPYnNlcnZhYmxlLCB0b0FycmF5fSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtHTFBLLCBMUH0gZnJvbSAnZ2xway5qcyc7XHJcbmltcG9ydCB7UGFydGlhbE9yZGVyfSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMvcG8vbW9kZWwvcGFydGlhbC1vcmRlcic7XHJcbmltcG9ydCB7UHJvYmxlbVNvbHV0aW9ufSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMvZ2xway9wcm9ibGVtLXNvbHV0aW9uJztcclxuaW1wb3J0IHtTdWJqZWN0VG99IGZyb20gJy4uLy4uLy4uLy4uL21vZGVscy9nbHBrL3N1YmplY3QtdG8nO1xyXG5pbXBvcnQge0V2ZW50fSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMvcG8vbW9kZWwvZXZlbnQnO1xyXG5pbXBvcnQge1ZhcmlhYmxlTmFtZX0gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbGl0eS9nbHBrL21vZGVsL3ZhcmlhYmxlLW5hbWUnO1xyXG5pbXBvcnQge0RpcmVjdGx5Rm9sbG93c0V4dHJhY3Rvcn0gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbGl0eS9kaXJlY3RseS1mb2xsb3dzLWV4dHJhY3Rvcic7XHJcbmltcG9ydCB7R29hbH0gZnJvbSAnLi4vLi4vLi4vLi4vbW9kZWxzL2dscGsvZ2xway1jb25zdGFudHMnO1xyXG5pbXBvcnQge1BldHJpTmV0fSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMvcG4vbW9kZWwvcGV0cmktbmV0JztcclxuaW1wb3J0IHtUcmFuc2l0aW9ufSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMvcG4vbW9kZWwvdHJhbnNpdGlvbic7XHJcbmltcG9ydCB7UGxhY2V9IGZyb20gJy4uLy4uLy4uLy4uL21vZGVscy9wbi9tb2RlbC9wbGFjZSc7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIElscDJNaW5lcklscFNvbHZlciBleHRlbmRzIEFyY1dlaWdodElscFNvbHZlciB7XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgUE9fQVJDX1NFUEFSQVRPUiA9ICcjJztcclxuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEZJTkFMX01BUktJTkcgPSAnbWYnO1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2RpcmVjdGx5Rm9sbG93c0V4dHJhY3RvcjogRGlyZWN0bHlGb2xsb3dzRXh0cmFjdG9yO1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBfcG9WYXJpYWJsZU5hbWVzOiBTZXQ8c3RyaW5nPjtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihzb2x2ZXIkOiBPYnNlcnZhYmxlPEdMUEs+KSB7XHJcbiAgICAgICAgc3VwZXIoc29sdmVyJCk7XHJcbiAgICAgICAgdGhpcy5fZGlyZWN0bHlGb2xsb3dzRXh0cmFjdG9yID0gbmV3IERpcmVjdGx5Rm9sbG93c0V4dHJhY3RvcigpO1xyXG4gICAgICAgIHRoaXMuX3BvVmFyaWFibGVOYW1lcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmaW5kU29sdXRpb25zKHBvczogQXJyYXk8UGFydGlhbE9yZGVyPiB8IFBldHJpTmV0KTogT2JzZXJ2YWJsZTxBcnJheTxQcm9ibGVtU29sdXRpb24+PiB7XHJcbiAgICAgICAgY29uc3QgYmFzZUlscENvbnN0cmFpbnRzOiBBcnJheTxTdWJqZWN0VG8+ID0gW107XHJcblxyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBvcykpIHtcclxuICAgICAgICAgICAgLy8gY3JlYXRlcyB0b2tlbmZsb3cgc3lzdGVtIHdpdGggdW5pcXVlIHZhcmlhYmxlcyBmb3IgZWFjaCBwYXJ0aWFsIG9yZGVyXHJcblxyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXZlbnRzID0gcG9zW2ldLmV2ZW50cztcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZSBvZiBldmVudHMpIHtcclxuICAgICAgICAgICAgICAgICAgICBiYXNlSWxwQ29uc3RyYWludHMucHVzaCguLi50aGlzLmZpcmluZ1J1bGUoZSwgaSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJhc2VJbHBDb25zdHJhaW50cy5wdXNoKC4uLnRoaXMudG9rZW5GbG93KGUsIGkpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJhc2VJbHBDb25zdHJhaW50cy5wdXNoKC4uLnRoaXMuaW5pdGlhbE1hcmtpbmcoZXZlbnRzLCBpKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyB1c2VzIHRoZSBjb21iaW5lZCBicmFuY2hpbmcgcHJvY2VzcyB0byByZWR1Y2UgdGhlIG51bWJlciBvZiB1bmlxdWUgdmFyaWFibGVzXHJcblxyXG4gICAgICAgICAgICBjb25zdCBldmVudHMgPSBwb3MuZ2V0VHJhbnNpdGlvbnMoKTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBlIG9mIGV2ZW50cykge1xyXG4gICAgICAgICAgICAgICAgYmFzZUlscENvbnN0cmFpbnRzLnB1c2goLi4udGhpcy5icmFuY2hpbmdQcm9jZXNzRmlyaW5nUnVsZShlKSk7XHJcbiAgICAgICAgICAgICAgICBiYXNlSWxwQ29uc3RyYWludHMucHVzaCguLi50aGlzLmJyYW5jaGluZ1Byb2Nlc3NUb2tlbkZsb3coZSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBiYXNlSWxwID0gdGhpcy5zZXRVcEJhc2VJbHAoKTtcclxuXHJcbiAgICAgICAgY29uc3QgcHJvYmxlbXMgPSB0aGlzLl9kaXJlY3RseUZvbGxvd3NFeHRyYWN0b3Iub25lV2F5RGlyZWN0bHlGb2xsb3dzKCkubWFwKHBhaXIgPT4gKHtcclxuICAgICAgICAgICAgYmFzZUlscENvbnN0cmFpbnRzLFxyXG4gICAgICAgICAgICBiYXNlSWxwLFxyXG4gICAgICAgICAgICBwYWlyXHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICByZXR1cm4gZnJvbShwcm9ibGVtcykucGlwZShcclxuICAgICAgICAgICAgY29uY2F0TWFwKHByb2JsZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc29sdmVJTFAodGhpcy5wb3B1bGF0ZUlscChwcm9ibGVtLmJhc2VJbHAsIHByb2JsZW0uYmFzZUlscENvbnN0cmFpbnRzLCBwcm9ibGVtLnBhaXIpKTtcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIHRvQXJyYXkoKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBmaXJpbmdSdWxlKGV2ZW50OiBFdmVudCwgaTogbnVtYmVyKTogQXJyYXk8U3ViamVjdFRvPiB7XHJcbiAgICAgICAgY29uc3QgdmFyaWFibGVzID0gW3RoaXMudmFyaWFibGUodGhpcy5nZXRQb0V2ZW50SWQoZXZlbnQuaWQsIGkpKV07XHJcbiAgICAgICAgZm9yIChjb25zdCBwcmUgb2YgZXZlbnQucHJldmlvdXNFdmVudHMpIHtcclxuICAgICAgICAgICAgdmFyaWFibGVzLnB1c2godGhpcy52YXJpYWJsZSh0aGlzLmdldFBvQXJjSWQocHJlLmlkLCBldmVudC5pZCwgaSkpKTtcclxuICAgICAgICAgICAgdGhpcy5fZGlyZWN0bHlGb2xsb3dzRXh0cmFjdG9yLmFkZChldmVudC5sYWJlbCEsIHByZS5sYWJlbCEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXJpYWJsZXMucHVzaCh0aGlzLnZhcmlhYmxlKHRoaXMudHJhbnNpdGlvblZhcmlhYmxlTmFtZShldmVudC5sYWJlbCEsIFZhcmlhYmxlTmFtZS5JTkdPSU5HX0FSQ19XRUlHSFRfUFJFRklYKSwgLTEpKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5ncmVhdGVyRXF1YWxUaGFuKHZhcmlhYmxlcywgMCkuY29uc3RyYWludHM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB0b2tlbkZsb3coZXZlbnQ6IEV2ZW50LCBpOiBudW1iZXIpOiBBcnJheTxTdWJqZWN0VG8+IHtcclxuICAgICAgICBjb25zdCB2YXJpYWJsZXMgPSBbdGhpcy52YXJpYWJsZSh0aGlzLmdldFBvRXZlbnRJZChldmVudC5pZCwgaSkpXTtcclxuICAgICAgICBmb3IgKGNvbnN0IHByZSBvZiBldmVudC5wcmV2aW91c0V2ZW50cykge1xyXG4gICAgICAgICAgICB2YXJpYWJsZXMucHVzaCh0aGlzLnZhcmlhYmxlKHRoaXMuZ2V0UG9BcmNJZChwcmUuaWQsIGV2ZW50LmlkLCBpKSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGNvbnN0IHBvc3Qgb2YgZXZlbnQubmV4dEV2ZW50cykge1xyXG4gICAgICAgICAgICB2YXJpYWJsZXMucHVzaCh0aGlzLnZhcmlhYmxlKHRoaXMuZ2V0UG9BcmNJZChldmVudC5pZCwgcG9zdC5pZCwgaSksIC0xKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChldmVudC5uZXh0RXZlbnRzLnNpemUgPT09IDApIHtcclxuICAgICAgICAgICAgdmFyaWFibGVzLnB1c2godGhpcy52YXJpYWJsZSh0aGlzLmdldFBvQXJjSWQoZXZlbnQuaWQsIElscDJNaW5lcklscFNvbHZlci5GSU5BTF9NQVJLSU5HLCBpKSwgLTEpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyaWFibGVzLnB1c2godGhpcy52YXJpYWJsZSh0aGlzLnRyYW5zaXRpb25WYXJpYWJsZU5hbWUoZXZlbnQubGFiZWwhLCBWYXJpYWJsZU5hbWUuSU5HT0lOR19BUkNfV0VJR0hUX1BSRUZJWCksIC0xKSk7XHJcbiAgICAgICAgdmFyaWFibGVzLnB1c2godGhpcy52YXJpYWJsZSh0aGlzLnRyYW5zaXRpb25WYXJpYWJsZU5hbWUoZXZlbnQubGFiZWwhLCBWYXJpYWJsZU5hbWUuT1VUR09JTkdfQVJDX1dFSUdIVF9QUkVGSVgpKSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXF1YWwodmFyaWFibGVzLCAwKS5jb25zdHJhaW50cztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGluaXRpYWxNYXJraW5nKGV2ZW50czogQXJyYXk8RXZlbnQ+LCBpOiBudW1iZXIpOiBBcnJheTxTdWJqZWN0VG8+IHtcclxuICAgICAgICBjb25zdCB2YXJpYWJsZXMgPSBldmVudHMubWFwKGUgPT4gdGhpcy52YXJpYWJsZSh0aGlzLmdldFBvRXZlbnRJZChlLmlkLCBpKSwgLTEpKTtcclxuICAgICAgICB2YXJpYWJsZXMucHVzaCh0aGlzLnZhcmlhYmxlKFZhcmlhYmxlTmFtZS5JTklUSUFMX01BUktJTkcpKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5lcXVhbCh2YXJpYWJsZXMsIDApLmNvbnN0cmFpbnRzO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UG9FdmVudElkKGlkOiBzdHJpbmcsIGk6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgZCA9IGAke2l9JHtJbHAyTWluZXJJbHBTb2x2ZXIuUE9fQVJDX1NFUEFSQVRPUn0ke2lkfWA7XHJcbiAgICAgICAgdGhpcy5fcG9WYXJpYWJsZU5hbWVzLmFkZChkKTtcclxuICAgICAgICByZXR1cm4gZDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFBvQXJjSWQoc291cmNlSWQ6IHN0cmluZywgZGVzdGluYXRpb25JZDogc3RyaW5nLCBpOiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IGlkID0gYCR7aX0ke0lscDJNaW5lcklscFNvbHZlci5QT19BUkNfU0VQQVJBVE9SfSR7c291cmNlSWR9JHtJbHAyTWluZXJJbHBTb2x2ZXIuUE9fQVJDX1NFUEFSQVRPUn0ke2Rlc3RpbmF0aW9uSWR9YDtcclxuICAgICAgICB0aGlzLl9wb1ZhcmlhYmxlTmFtZXMuYWRkKGlkKTtcclxuICAgICAgICByZXR1cm4gaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBicmFuY2hpbmdQcm9jZXNzRmlyaW5nUnVsZShldmVudDogVHJhbnNpdGlvbik6IEFycmF5PFN1YmplY3RUbz4ge1xyXG4gICAgICAgIGNvbnN0IHZhcmlhYmxlcyA9IGV2ZW50LmluZ29pbmdBcmNzLm1hcChhID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcCA9IGEuc291cmNlIGFzIFBsYWNlO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGFhIG9mIHAuaW5nb2luZ0FyY3MpIHtcclxuICAgICAgICAgICAgICAgIGxldCBzb3VyY2UgPSBhYS5zb3VyY2UgYXMgVHJhbnNpdGlvbjtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2RpcmVjdGx5Rm9sbG93c0V4dHJhY3Rvci5hZGQoZXZlbnQubGFiZWwhLCBzb3VyY2UubGFiZWwhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy52YXJpYWJsZSh0aGlzLmdldFBsYWNlVmFyaWFibGUocCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHZhcmlhYmxlcy5wdXNoKHRoaXMudmFyaWFibGUodGhpcy50cmFuc2l0aW9uVmFyaWFibGVOYW1lKGV2ZW50LmxhYmVsISwgVmFyaWFibGVOYW1lLklOR09JTkdfQVJDX1dFSUdIVF9QUkVGSVgpLCAtMSkpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdyZWF0ZXJFcXVhbFRoYW4odmFyaWFibGVzLCAwKS5jb25zdHJhaW50cztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGJyYW5jaGluZ1Byb2Nlc3NUb2tlbkZsb3coZXZlbnQ6IFRyYW5zaXRpb24pOiBBcnJheTxTdWJqZWN0VG8+IHtcclxuICAgICAgICBjb25zdCB2YXJpYWJsZXMgPSBldmVudC5pbmdvaW5nQXJjcy5tYXAoYSA9PiB0aGlzLnZhcmlhYmxlKHRoaXMuZ2V0UGxhY2VWYXJpYWJsZShhLnNvdXJjZSBhcyBQbGFjZSkpKTtcclxuICAgICAgICB2YXJpYWJsZXMucHVzaCh0aGlzLnZhcmlhYmxlKHRoaXMudHJhbnNpdGlvblZhcmlhYmxlTmFtZShldmVudC5sYWJlbCEsIFZhcmlhYmxlTmFtZS5JTkdPSU5HX0FSQ19XRUlHSFRfUFJFRklYKSwgLTEpKTtcclxuICAgICAgICB2YXJpYWJsZXMucHVzaCh0aGlzLnZhcmlhYmxlKHRoaXMudHJhbnNpdGlvblZhcmlhYmxlTmFtZShldmVudC5sYWJlbCEsIFZhcmlhYmxlTmFtZS5PVVRHT0lOR19BUkNfV0VJR0hUX1BSRUZJWCkpKTtcclxuICAgICAgICB2YXJpYWJsZXMucHVzaCguLi5ldmVudC5vdXRnb2luZ0FyY3MubWFwKGEgPT4gdGhpcy52YXJpYWJsZSh0aGlzLmdldFBsYWNlVmFyaWFibGUoYS5kZXN0aW5hdGlvbiBhcyBQbGFjZSksIC0xKSkpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmVxdWFsKHZhcmlhYmxlcywgMCkuY29uc3RyYWludHM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRQbGFjZVZhcmlhYmxlKHBsYWNlOiBQbGFjZSk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKHBsYWNlLmluZ29pbmdBcmNzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gVmFyaWFibGVOYW1lLklOSVRJQUxfTUFSS0lORztcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fcG9WYXJpYWJsZU5hbWVzLmFkZChwbGFjZS5pZCEpO1xyXG4gICAgICAgIHJldHVybiBwbGFjZS5pZCE7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRVcEJhc2VJbHAoKTogTFAge1xyXG4gICAgICAgIGNvbnN0IGdvYWxWYXJpYWJsZXMgPSBBcnJheS5mcm9tKHRoaXMuX2FsbFZhcmlhYmxlcykuY29uY2F0KFZhcmlhYmxlTmFtZS5JTklUSUFMX01BUktJTkcpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIG5hbWU6ICdpbHAnLFxyXG4gICAgICAgICAgICBvYmplY3RpdmU6IHtcclxuICAgICAgICAgICAgICAgIG5hbWU6ICdnb2FsJyxcclxuICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogR29hbC5NSU5JTVVNLFxyXG4gICAgICAgICAgICAgICAgLy8gdmFyczogZ29hbFZhcmlhYmxlcy5tYXAodiA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgbGV0IGNvZWY7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgaWYgKHYuc3RhcnRzV2l0aChWYXJpYWJsZU5hbWUuSU5JVElBTF9NQVJLSU5HKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICBjb2VmID0gMzA7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgfSBlbHNlIGlmICh2LnN0YXJ0c1dpdGgoVmFyaWFibGVOYW1lLk9VVEdPSU5HX0FSQ19XRUlHSFRfUFJFRklYKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICBjb2VmID0gMTA7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgY29lZiA9IC0xO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gdGhpcy52YXJpYWJsZSh2LCBjb2VmKTtcclxuICAgICAgICAgICAgICAgIC8vIH0pXHJcbiAgICAgICAgICAgICAgICB2YXJzOiBBcnJheS5mcm9tKHRoaXMuX3BvVmFyaWFibGVOYW1lcykubWFwKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZhcmlhYmxlKHYsIDEpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc3ViamVjdFRvOiBbXSxcclxuICAgICAgICAgICAgLy8gVE9ETyBlbmFibGUgYXJjIHdlaWdodHMgd2l0aCBhIGNvbmZpZyBzZXR0aW5nP1xyXG4gICAgICAgICAgICBiaW5hcmllczogZ29hbFZhcmlhYmxlcyxcclxuICAgICAgICAgICAgZ2VuZXJhbHM6IEFycmF5LmZyb20odGhpcy5fcG9WYXJpYWJsZU5hbWVzKVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwb3B1bGF0ZUlscChiYXNlSWxwOiBMUCwgYmFzZUNvbnN0cmFpbnRzOiBBcnJheTxTdWJqZWN0VG8+LCBjYXVzYWxQYWlyOiBBcnJheTxzdHJpbmc+KTogTFAge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5hc3NpZ24oe30sIGJhc2VJbHApO1xyXG4gICAgICAgIHJlc3VsdC5zdWJqZWN0VG8gPSBbLi4uYmFzZUNvbnN0cmFpbnRzXTtcclxuICAgICAgICByZXN1bHQuc3ViamVjdFRvID0gcmVzdWx0LnN1YmplY3RUby5jb25jYXQodGhpcy5ncmVhdGVyRXF1YWxUaGFuKHRoaXMudmFyaWFibGUodGhpcy50cmFuc2l0aW9uVmFyaWFibGVOYW1lKGNhdXNhbFBhaXJbMF0sIFZhcmlhYmxlTmFtZS5PVVRHT0lOR19BUkNfV0VJR0hUX1BSRUZJWCkpLCAxKS5jb25zdHJhaW50cyk7XHJcbiAgICAgICAgcmVzdWx0LnN1YmplY3RUbyA9IHJlc3VsdC5zdWJqZWN0VG8uY29uY2F0KHRoaXMuZ3JlYXRlckVxdWFsVGhhbih0aGlzLnZhcmlhYmxlKHRoaXMudHJhbnNpdGlvblZhcmlhYmxlTmFtZShjYXVzYWxQYWlyWzFdLCBWYXJpYWJsZU5hbWUuSU5HT0lOR19BUkNfV0VJR0hUX1BSRUZJWCkpLCAxKS5jb25zdHJhaW50cyk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxufVxyXG4iXX0=