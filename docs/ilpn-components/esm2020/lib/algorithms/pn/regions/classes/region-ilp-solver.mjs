import { BehaviorSubject, ReplaySubject, switchMap } from 'rxjs';
import { PetriNet } from '../../../../models/pn/model/petri-net';
import { Goal, Solution } from '../../../../models/glpk/glpk-constants';
import { ConstraintsWithNewVariables } from '../../../../models/glpk/constraints-with-new-variables';
import { IlpSolver } from '../../../../utility/glpk/abstract-ilp-solver';
export class RegionIlpSolver extends IlpSolver {
    constructor(_regionTransformer, _solver$) {
        super(_solver$);
        this._regionTransformer = _regionTransformer;
        this._placeVariables = new Set();
    }
    computeRegions(nets, config) {
        const regions$ = new ReplaySubject();
        const combined = this.combineInputNets(nets);
        const ilp$ = new BehaviorSubject(this.setUpInitialILP(combined, config));
        ilp$.pipe(switchMap(ilp => this.solveILP(ilp))).subscribe((ps) => {
            if (ps.solution.result.status === Solution.OPTIMAL) {
                const region = this._regionTransformer.displayRegionInNet(ps.solution, combined.net);
                // TODO check if the region is new and we are not trapped in a loop
                const nonEmptyInputSet = combined.inputs.find(inputs => inputs.size > 0) ?? [];
                regions$.next({ net: region, inputs: Array.from(nonEmptyInputSet) });
                ilp$.next(this.addConstraintsToILP(ps));
            }
            else {
                // we are done, there are no more regions
                console.debug('final non-optimal result', ps.solution);
                regions$.complete();
                ilp$.complete();
            }
        });
        return regions$.asObservable();
    }
    combineInputNets(nets) {
        if (nets.length === 0) {
            throw new Error('Synthesis must be performed on at least one input net!');
        }
        let result = nets[0];
        const inputs = [result.inputPlaces];
        const outputs = [result.outputPlaces];
        for (let i = 1; i < nets.length; i++) {
            const union = PetriNet.netUnion(result, nets[i]);
            result = union.net;
            inputs.push(union.inputPlacesB);
            outputs.push(union.outputPlacesB);
        }
        return { net: result, inputs, outputs };
    }
    setUpInitialILP(combined, config) {
        const net = combined.net;
        this._placeVariables = new Set(net.getPlaces().map(p => p.getId()));
        this._allVariables = new Set(this._placeVariables);
        const initial = {
            name: 'ilp',
            objective: {
                name: 'region',
                direction: Goal.MINIMUM,
                vars: net.getPlaces().map(p => this.variable(p.getId())),
            },
            subjectTo: [],
        };
        initial[config.oneBoundRegions ? 'binaries' : 'generals'] = Array.from(this._placeVariables);
        this.applyConstraints(initial, this.createInitialConstraints(combined, config));
        return initial;
    }
    createInitialConstraints(combined, config) {
        const net = combined.net;
        const result = [];
        // only non-negative solutions
        result.push(...net.getPlaces().map(p => this.greaterEqualThan(this.variable(p.getId()), 0)));
        // non-zero solutions
        result.push(this.greaterEqualThan(net.getPlaces().map(p => this.variable(p.getId())), 1));
        // initial markings must be the same
        if (combined.inputs.length > 1) {
            const nonemptyInputs = combined.inputs.filter(inputs => inputs.size !== 0);
            const inputsA = Array.from(nonemptyInputs[0]);
            for (let i = 1; i < nonemptyInputs.length; i++) {
                const inputsB = Array.from(nonemptyInputs[i]);
                result.push(this.sumEqualsZero(...inputsA.map(id => this.variable(id, 1)), ...inputsB.map(id => this.variable(id, -1))));
            }
        }
        // places with no post-set should be empty
        if (config.noOutputPlaces) {
            result.push(...net.getPlaces().filter(p => p.outgoingArcs.length === 0).map(p => this.lessEqualThan(this.variable(p.getId()), 0)));
        }
        // gradient constraints
        const labels = this.collectTransitionByLabel(net);
        const riseSumVariables = [];
        const absoluteRiseSumVariables = [];
        for (const [key, transitions] of labels.entries()) {
            const transitionsWithSameLabel = transitions.length;
            const t1 = transitions.splice(0, 1)[0];
            if (config.obtainPartialOrders) {
                // t1 post-set
                riseSumVariables.push(...this.createVariablesFromPlaceIds(t1.outgoingArcs.map((a) => a.destinationId), 1));
                // t1 pre-set
                riseSumVariables.push(...this.createVariablesFromPlaceIds(t1.ingoingArcs.map((a) => a.sourceId), -1));
                const singleRiseVariables = this.createVariablesFromPlaceIds(t1.outgoingArcs.map((a) => a.destinationId), 1);
                singleRiseVariables.push(...this.createVariablesFromPlaceIds(t1.ingoingArcs.map((a) => a.sourceId), -1));
                const singleRise = this.combineCoefficients(singleRiseVariables);
                const abs = this.helperVariableName('abs');
                const absoluteRise = this.xAbsoluteOfSum(abs, singleRise);
                absoluteRiseSumVariables.push(abs);
                result.push(ConstraintsWithNewVariables.combineAndIntroduceVariables(undefined, abs, absoluteRise));
            }
            if (transitionsWithSameLabel === 1) {
                continue;
            }
            for (const t2 of transitions) {
                // t1 post-set
                let variables = this.createVariablesFromPlaceIds(t1.outgoingArcs.map((a) => a.destinationId), 1);
                // t1 pre-set
                variables.push(...this.createVariablesFromPlaceIds(t1.ingoingArcs.map((a) => a.sourceId), -1));
                // t2 post-set
                variables.push(...this.createVariablesFromPlaceIds(t2.outgoingArcs.map((a) => a.destinationId), -1));
                // t2 pre-set
                variables.push(...this.createVariablesFromPlaceIds(t2.ingoingArcs.map((a) => a.sourceId), 1));
                variables = this.combineCoefficients(variables);
                result.push(this.sumEqualsZero(...variables));
            }
        }
        if (config.obtainPartialOrders) {
            /*
                Sum of rises should be 0 AND Sum of absolute rises should be 2 (internal places)
                OR
                Sum of absolute rises should be 1 (initial and final places)
             */
            // sum of rises is 0
            const riseSumIsZero = this.helperVariableName('riseEqualZero');
            result.push(this.xWhenAEqualsB(riseSumIsZero, this.combineCoefficients(riseSumVariables), 0));
            // sum of absolute values of rises is 2
            const absRiseSumIsTwo = this.helperVariableName('absRiseSumTwo');
            result.push(this.xWhenAEqualsB(absRiseSumIsTwo, absoluteRiseSumVariables, 2));
            // sum is 0 AND sum absolute is 2
            const internalPlace = this.helperVariableName('placeIsInternal');
            result.push(ConstraintsWithNewVariables.combineAndIntroduceVariables([riseSumIsZero, absRiseSumIsTwo], undefined, this.xAandB(internalPlace, riseSumIsZero, absRiseSumIsTwo)));
            // sum of absolute values of rise is 1
            const absRiseSumIsOne = this.helperVariableName('absRiseSumOne');
            result.push(this.xWhenAEqualsB(absRiseSumIsOne, absoluteRiseSumVariables, 1));
            // place is internal OR place is initial/final
            const internalOrFinal = this.helperVariableName('internalOrFinal');
            result.push(ConstraintsWithNewVariables.combineAndIntroduceVariables([internalPlace, absRiseSumIsOne, internalOrFinal], undefined, this.xAorB(internalOrFinal, internalPlace, absRiseSumIsOne)));
            // place is internal OR place is initial/final must be true
            result.push(this.equal(this.variable(internalOrFinal), 1));
        }
        return ConstraintsWithNewVariables.combine(...result);
    }
    addConstraintsToILP(ps) {
        const ilp = ps.ilp;
        // no region that contains the new solution as subset
        const region = ps.solution.result.vars;
        const regionPlaces = Object.entries(region).filter(([k, v]) => v != 0 && this._placeVariables.has(k));
        const additionalConstraints = regionPlaces.map(([k, v]) => this.yWhenAGreaterEqualB(k, v));
        const yVariables = additionalConstraints
            .reduce((arr, constraint) => {
            arr.push(...constraint.binaryVariables);
            return arr;
        }, [])
            .map(y => this.variable(y));
        /*
            Sum of x-es should be less than their number
            x = 1 - y
            Therefore sum of y should be greater than 0
         */
        additionalConstraints.push(this.sumGreaterThan(yVariables, 0));
        this.applyConstraints(ilp, ConstraintsWithNewVariables.combine(...additionalConstraints));
        console.debug('solution', ps.solution.result.vars);
        console.debug('non-zero', regionPlaces);
        console.debug('additional constraint', ilp.subjectTo[ilp.subjectTo.length - 1]);
        return ilp;
    }
    collectTransitionByLabel(net) {
        const result = new Map();
        for (const t of net.getTransitions()) {
            if (t.label === undefined) {
                throw new Error(`Transition with id '${t.id}' has no label! All transitions must be labeled in the input net!`);
            }
            const array = result.get(t.label);
            if (array === undefined) {
                result.set(t.label, [t]);
            }
            else {
                array.push(t);
            }
        }
        return result;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaW9uLWlscC1zb2x2ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jb21wb25lbnRzL3NyYy9saWIvYWxnb3JpdGhtcy9wbi9yZWdpb25zL2NsYXNzZXMvcmVnaW9uLWlscC1zb2x2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLGVBQWUsRUFBYyxhQUFhLEVBQUUsU0FBUyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBRTNFLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSx1Q0FBdUMsQ0FBQztBQUUvRCxPQUFPLEVBQUMsSUFBSSxFQUFFLFFBQVEsRUFBQyxNQUFNLHdDQUF3QyxDQUFDO0FBSXRFLE9BQU8sRUFBQywyQkFBMkIsRUFBQyxNQUFNLHdEQUF3RCxDQUFDO0FBS25HLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSw4Q0FBOEMsQ0FBQztBQUd2RSxNQUFNLE9BQU8sZUFBZ0IsU0FBUSxTQUFTO0lBSzFDLFlBQW9CLGtCQUFvRCxFQUFFLFFBQTBCO1FBQ2hHLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQURBLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBa0M7UUFFcEUsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO0lBQzdDLENBQUM7SUFFTSxjQUFjLENBQUMsSUFBcUIsRUFBRSxNQUE0QjtRQUVyRSxNQUFNLFFBQVEsR0FBRyxJQUFJLGFBQWEsRUFBVSxDQUFDO1FBRTdDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3QyxNQUFNLElBQUksR0FBRyxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3pFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFB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eEMsT0FBTyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFaEYsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDO0lBRU8sd0JBQXdCLENBQUMsR0FBYTtRQUMxQyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBNkIsQ0FBQztRQUNwRCxLQUFLLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxjQUFjLEVBQUUsRUFBRTtZQUNsQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO2dCQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUMsRUFBRSxtRUFBbUUsQ0FBQyxDQUFDO2FBQ25IO1lBQ0QsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbEMsSUFBSSxLQUFLLEtBQUssU0FBUyxFQUFFO2dCQUNyQixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzVCO2lCQUFNO2dCQUNILEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDakI7U0FDSjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0LCBzd2l0Y2hNYXB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge0dMUEssIExQfSBmcm9tICdnbHBrLmpzJztcclxuaW1wb3J0IHtQZXRyaU5ldH0gZnJvbSAnLi4vLi4vLi4vLi4vbW9kZWxzL3BuL21vZGVsL3BldHJpLW5ldCc7XHJcbmltcG9ydCB7UHJvYmxlbVNvbHV0aW9ufSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMvZ2xway9wcm9ibGVtLXNvbHV0aW9uJztcclxuaW1wb3J0IHtHb2FsLCBTb2x1dGlvbn0gZnJvbSAnLi4vLi4vLi4vLi4vbW9kZWxzL2dscGsvZ2xway1jb25zdGFudHMnO1xyXG5pbXBvcnQge0FyY30gZnJvbSAnLi4vLi4vLi4vLi4vbW9kZWxzL3BuL21vZGVsL2FyYyc7XHJcbmltcG9ydCB7VHJhbnNpdGlvbn0gZnJvbSAnLi4vLi4vLi4vLi4vbW9kZWxzL3BuL21vZGVsL3RyYW5zaXRpb24nO1xyXG5pbXBvcnQge1ZhcmlhYmxlfSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMvZ2xway92YXJpYWJsZSc7XHJcbmltcG9ydCB7Q29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzfSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMvZ2xway9jb25zdHJhaW50cy13aXRoLW5ldy12YXJpYWJsZXMnO1xyXG5pbXBvcnQge1BldHJpTmV0UmVnaW9uVHJhbnNmb3JtZXJTZXJ2aWNlfSBmcm9tICcuLi9wZXRyaS1uZXQtcmVnaW9uLXRyYW5zZm9ybWVyLnNlcnZpY2UnO1xyXG5pbXBvcnQge0NvbWJpbmF0aW9uUmVzdWx0fSBmcm9tICcuL2NvbWJpbmF0aW9uLXJlc3VsdCc7XHJcbmltcG9ydCB7UmVnaW9ufSBmcm9tICcuL3JlZ2lvbic7XHJcbmltcG9ydCB7UmVnaW9uc0NvbmZpZ3VyYXRpb259IGZyb20gJy4vcmVnaW9ucy1jb25maWd1cmF0aW9uJztcclxuaW1wb3J0IHtJbHBTb2x2ZXJ9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxpdHkvZ2xway9hYnN0cmFjdC1pbHAtc29sdmVyJztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgUmVnaW9uSWxwU29sdmVyIGV4dGVuZHMgSWxwU29sdmVyIHtcclxuXHJcbiAgICBwcml2YXRlIF9wbGFjZVZhcmlhYmxlczogU2V0PHN0cmluZz47XHJcblxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX3JlZ2lvblRyYW5zZm9ybWVyOiBQZXRyaU5ldFJlZ2lvblRyYW5zZm9ybWVyU2VydmljZSwgX3NvbHZlciQ6IE9ic2VydmFibGU8R0xQSz4pIHtcclxuICAgICAgICBzdXBlcihfc29sdmVyJCk7XHJcbiAgICAgICAgdGhpcy5fcGxhY2VWYXJpYWJsZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY29tcHV0ZVJlZ2lvbnMobmV0czogQXJyYXk8UGV0cmlOZXQ+LCBjb25maWc6IFJlZ2lvbnNDb25maWd1cmF0aW9uKTogT2JzZXJ2YWJsZTxSZWdpb24+IHtcclxuXHJcbiAgICAgICAgY29uc3QgcmVnaW9ucyQgPSBuZXcgUmVwbGF5U3ViamVjdDxSZWdpb24+KCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbWJpbmVkID0gdGhpcy5jb21iaW5lSW5wdXROZXRzKG5ldHMpO1xyXG5cclxuICAgICAgICBjb25zdCBpbHAkID0gbmV3IEJlaGF2aW9yU3ViamVjdCh0aGlzLnNldFVwSW5pdGlhbElMUChjb21iaW5lZCwgY29uZmlnKSk7XHJcbiAgICAgICAgaWxwJC5waXBlKHN3aXRjaE1hcChpbHAgPT4gdGhpcy5zb2x2ZUlMUChpbHApKSkuc3Vic2NyaWJlKChwczogUHJvYmxlbVNvbHV0aW9uKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChwcy5zb2x1dGlvbi5yZXN1bHQuc3RhdHVzID09PSBTb2x1dGlvbi5PUFRJTUFMKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZWdpb24gPSB0aGlzLl9yZWdpb25UcmFuc2Zvcm1lci5kaXNwbGF5UmVnaW9uSW5OZXQocHMuc29sdXRpb24sIGNvbWJpbmVkLm5ldCk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gVE9ETyBjaGVjayBpZiB0aGUgcmVnaW9uIGlzIG5ldyBhbmQgd2UgYXJlIG5vdCB0cmFwcGVkIGluIGEgbG9vcFxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vbkVtcHR5SW5wdXRTZXQgPSBjb21iaW5lZC5pbnB1dHMuZmluZChpbnB1dHMgPT4gaW5wdXRzLnNpemUgPiAwKSA/PyBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICByZWdpb25zJC5uZXh0KHtuZXQ6IHJlZ2lvbiwgaW5wdXRzOiBBcnJheS5mcm9tKG5vbkVtcHR5SW5wdXRTZXQpfSk7XHJcbiAgICAgICAgICAgICAgICBpbHAkLm5leHQodGhpcy5hZGRDb25zdHJhaW50c1RvSUxQKHBzKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgZG9uZSwgdGhlcmUgYXJlIG5vIG1vcmUgcmVnaW9uc1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnZmluYWwgbm9uLW9wdGltYWwgcmVzdWx0JywgcHMuc29sdXRpb24pO1xyXG4gICAgICAgICAgICAgICAgcmVnaW9ucyQuY29tcGxldGUoKTtcclxuICAgICAgICAgICAgICAgIGlscCQuY29tcGxldGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVnaW9ucyQuYXNPYnNlcnZhYmxlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb21iaW5lSW5wdXROZXRzKG5ldHM6IEFycmF5PFBldHJpTmV0Pik6IENvbWJpbmF0aW9uUmVzdWx0IHtcclxuICAgICAgICBpZiAobmV0cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTeW50aGVzaXMgbXVzdCBiZSBwZXJmb3JtZWQgb24gYXQgbGVhc3Qgb25lIGlucHV0IG5ldCEnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCByZXN1bHQgPSBuZXRzWzBdO1xyXG4gICAgICAgIGNvbnN0IGlucHV0czogQXJyYXk8U2V0PHN0cmluZz4+ID0gW3Jlc3VsdC5pbnB1dFBsYWNlc107XHJcbiAgICAgICAgY29uc3Qgb3V0cHV0czogQXJyYXk8U2V0PHN0cmluZz4+ID0gW3Jlc3VsdC5vdXRwdXRQbGFjZXNdO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IG5ldHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgY29uc3QgdW5pb24gPSBQZXRyaU5ldC5uZXRVbmlvbihyZXN1bHQsIG5ldHNbaV0pO1xyXG4gICAgICAgICAgICByZXN1bHQgPSB1bmlvbi5uZXQ7XHJcbiAgICAgICAgICAgIGlucHV0cy5wdXNoKHVuaW9uLmlucHV0UGxhY2VzQik7XHJcbiAgICAgICAgICAgIG91dHB1dHMucHVzaCh1bmlvbi5vdXRwdXRQbGFjZXNCKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7bmV0OiByZXN1bHQsIGlucHV0cywgb3V0cHV0c307XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRVcEluaXRpYWxJTFAoY29tYmluZWQ6IENvbWJpbmF0aW9uUmVzdWx0LCBjb25maWc6IFJlZ2lvbnNDb25maWd1cmF0aW9uKTogTFAge1xyXG4gICAgICAgIGNvbnN0IG5ldCA9IGNvbWJpbmVkLm5ldDtcclxuXHJcbiAgICAgICAgdGhpcy5fcGxhY2VWYXJpYWJsZXMgPSBuZXcgU2V0KG5ldC5nZXRQbGFjZXMoKS5tYXAocCA9PiBwLmdldElkKCkpKTtcclxuICAgICAgICB0aGlzLl9hbGxWYXJpYWJsZXMgPSBuZXcgU2V0PHN0cmluZz4odGhpcy5fcGxhY2VWYXJpYWJsZXMpO1xyXG5cclxuICAgICAgICBjb25zdCBpbml0aWFsOiBMUCA9IHtcclxuICAgICAgICAgICAgbmFtZTogJ2lscCcsXHJcbiAgICAgICAgICAgIG9iamVjdGl2ZToge1xyXG4gICAgICAgICAgICAgICAgbmFtZTogJ3JlZ2lvbicsXHJcbiAgICAgICAgICAgICAgICBkaXJlY3Rpb246IEdvYWwuTUlOSU1VTSxcclxuICAgICAgICAgICAgICAgIHZhcnM6IG5ldC5nZXRQbGFjZXMoKS5tYXAocCA9PiB0aGlzLnZhcmlhYmxlKHAuZ2V0SWQoKSkpLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzdWJqZWN0VG86IFtdLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgaW5pdGlhbFtjb25maWcub25lQm91bmRSZWdpb25zID8gJ2JpbmFyaWVzJyA6ICdnZW5lcmFscyddID0gQXJyYXkuZnJvbSh0aGlzLl9wbGFjZVZhcmlhYmxlcyk7XHJcbiAgICAgICAgdGhpcy5hcHBseUNvbnN0cmFpbnRzKGluaXRpYWwsIHRoaXMuY3JlYXRlSW5pdGlhbENvbnN0cmFpbnRzKGNvbWJpbmVkLCBjb25maWcpKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGluaXRpYWw7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVJbml0aWFsQ29uc3RyYWludHMoY29tYmluZWQ6IENvbWJpbmF0aW9uUmVzdWx0LCBjb25maWc6IFJlZ2lvbnNDb25maWd1cmF0aW9uKTogQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzIHtcclxuICAgICAgICBjb25zdCBuZXQgPSBjb21iaW5lZC5uZXQ7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0OiBBcnJheTxDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXM+ID0gW107XHJcblxyXG4gICAgICAgIC8vIG9ubHkgbm9uLW5lZ2F0aXZlIHNvbHV0aW9uc1xyXG4gICAgICAgIHJlc3VsdC5wdXNoKC4uLm5ldC5nZXRQbGFjZXMoKS5tYXAocCA9PiB0aGlzLmdyZWF0ZXJFcXVhbFRoYW4odGhpcy52YXJpYWJsZShwLmdldElkKCkpLCAwKSkpO1xyXG5cclxuICAgICAgICAvLyBub24temVybyBzb2x1dGlvbnNcclxuICAgICAgICByZXN1bHQucHVzaCh0aGlzLmdyZWF0ZXJFcXVhbFRoYW4obmV0LmdldFBsYWNlcygpLm1hcChwID0+IHRoaXMudmFyaWFibGUocC5nZXRJZCgpKSksIDEpKTtcclxuXHJcbiAgICAgICAgLy8gaW5pdGlhbCBtYXJraW5ncyBtdXN0IGJlIHRoZSBzYW1lXHJcbiAgICAgICAgaWYgKGNvbWJpbmVkLmlucHV0cy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vbmVtcHR5SW5wdXRzID0gY29tYmluZWQuaW5wdXRzLmZpbHRlcihpbnB1dHMgPT4gaW5wdXRzLnNpemUgIT09IDApO1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dHNBID0gQXJyYXkuZnJvbShub25lbXB0eUlucHV0c1swXSk7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbm9uZW1wdHlJbnB1dHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0c0IgPSBBcnJheS5mcm9tKG5vbmVtcHR5SW5wdXRzW2ldKTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRoaXMuc3VtRXF1YWxzWmVybyguLi5pbnB1dHNBLm1hcChpZCA9PiB0aGlzLnZhcmlhYmxlKGlkLCAxKSksIC4uLmlucHV0c0IubWFwKGlkID0+IHRoaXMudmFyaWFibGUoaWQsIC0xKSkpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gcGxhY2VzIHdpdGggbm8gcG9zdC1zZXQgc2hvdWxkIGJlIGVtcHR5XHJcbiAgICAgICAgaWYgKGNvbmZpZy5ub091dHB1dFBsYWNlcykge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCguLi5uZXQuZ2V0UGxhY2VzKCkuZmlsdGVyKHAgPT4gcC5vdXRnb2luZ0FyY3MubGVuZ3RoID09PSAwKS5tYXAocCA9PiB0aGlzLmxlc3NFcXVhbFRoYW4odGhpcy52YXJpYWJsZShwLmdldElkKCkpLCAwKSkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZ3JhZGllbnQgY29uc3RyYWludHNcclxuICAgICAgICBjb25zdCBsYWJlbHMgPSB0aGlzLmNvbGxlY3RUcmFuc2l0aW9uQnlMYWJlbChuZXQpO1xyXG4gICAgICAgIGNvbnN0IHJpc2VTdW1WYXJpYWJsZXM6IEFycmF5PFZhcmlhYmxlPiA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGFic29sdXRlUmlzZVN1bVZhcmlhYmxlczogQXJyYXk8c3RyaW5nPiA9IFtdO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHRyYW5zaXRpb25zXSBvZiBsYWJlbHMuZW50cmllcygpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRyYW5zaXRpb25zV2l0aFNhbWVMYWJlbCA9IHRyYW5zaXRpb25zLmxlbmd0aDtcclxuICAgICAgICAgICAgY29uc3QgdDEgPSB0cmFuc2l0aW9ucy5zcGxpY2UoMCwgMSlbMF07XHJcblxyXG4gICAgICAgICAgICBpZiAoY29uZmlnLm9idGFpblBhcnRpYWxPcmRlcnMpIHtcclxuICAgICAgICAgICAgICAgIC8vIHQxIHBvc3Qtc2V0XHJcbiAgICAgICAgICAgICAgICByaXNlU3VtVmFyaWFibGVzLnB1c2goLi4udGhpcy5jcmVhdGVWYXJpYWJsZXNGcm9tUGxhY2VJZHModDEub3V0Z29pbmdBcmNzLm1hcCgoYTogQXJjKSA9PiBhLmRlc3RpbmF0aW9uSWQpLCAxKSk7XHJcbiAgICAgICAgICAgICAgICAvLyB0MSBwcmUtc2V0XHJcbiAgICAgICAgICAgICAgICByaXNlU3VtVmFyaWFibGVzLnB1c2goLi4udGhpcy5jcmVhdGVWYXJpYWJsZXNGcm9tUGxhY2VJZHModDEuaW5nb2luZ0FyY3MubWFwKChhOiBBcmMpID0+IGEuc291cmNlSWQpLCAtMSkpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHNpbmdsZVJpc2VWYXJpYWJsZXMgPSB0aGlzLmNyZWF0ZVZhcmlhYmxlc0Zyb21QbGFjZUlkcyh0MS5vdXRnb2luZ0FyY3MubWFwKChhOiBBcmMpID0+IGEuZGVzdGluYXRpb25JZCksIDEpO1xyXG4gICAgICAgICAgICAgICAgc2luZ2xlUmlzZVZhcmlhYmxlcy5wdXNoKC4uLnRoaXMuY3JlYXRlVmFyaWFibGVzRnJvbVBsYWNlSWRzKHQxLmluZ29pbmdBcmNzLm1hcCgoYTogQXJjKSA9PiBhLnNvdXJjZUlkKSwgLTEpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaW5nbGVSaXNlID0gdGhpcy5jb21iaW5lQ29lZmZpY2llbnRzKHNpbmdsZVJpc2VWYXJpYWJsZXMpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYWJzID0gdGhpcy5oZWxwZXJWYXJpYWJsZU5hbWUoJ2FicycpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYWJzb2x1dGVSaXNlID0gdGhpcy54QWJzb2x1dGVPZlN1bShhYnMsIHNpbmdsZVJpc2UpO1xyXG5cclxuICAgICAgICAgICAgICAgIGFic29sdXRlUmlzZVN1bVZhcmlhYmxlcy5wdXNoKGFicyk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZUFuZEludHJvZHVjZVZhcmlhYmxlcyhcclxuICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQsIGFicyxcclxuICAgICAgICAgICAgICAgICAgICBhYnNvbHV0ZVJpc2UpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodHJhbnNpdGlvbnNXaXRoU2FtZUxhYmVsID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9yIChjb25zdCB0MiBvZiB0cmFuc2l0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgLy8gdDEgcG9zdC1zZXRcclxuICAgICAgICAgICAgICAgIGxldCB2YXJpYWJsZXMgPSB0aGlzLmNyZWF0ZVZhcmlhYmxlc0Zyb21QbGFjZUlkcyh0MS5vdXRnb2luZ0FyY3MubWFwKChhOiBBcmMpID0+IGEuZGVzdGluYXRpb25JZCksIDEpO1xyXG4gICAgICAgICAgICAgICAgLy8gdDEgcHJlLXNldFxyXG4gICAgICAgICAgICAgICAgdmFyaWFibGVzLnB1c2goLi4udGhpcy5jcmVhdGVWYXJpYWJsZXNGcm9tUGxhY2VJZHModDEuaW5nb2luZ0FyY3MubWFwKChhOiBBcmMpID0+IGEuc291cmNlSWQpLCAtMSkpO1xyXG4gICAgICAgICAgICAgICAgLy8gdDIgcG9zdC1zZXRcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlcy5wdXNoKC4uLnRoaXMuY3JlYXRlVmFyaWFibGVzRnJvbVBsYWNlSWRzKHQyLm91dGdvaW5nQXJjcy5tYXAoKGE6IEFyYykgPT4gYS5kZXN0aW5hdGlvbklkKSwgLTEpKTtcclxuICAgICAgICAgICAgICAgIC8vIHQyIHByZS1zZXRcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlcy5wdXNoKC4uLnRoaXMuY3JlYXRlVmFyaWFibGVzRnJvbVBsYWNlSWRzKHQyLmluZ29pbmdBcmNzLm1hcCgoYTogQXJjKSA9PiBhLnNvdXJjZUlkKSwgMSkpO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlcyA9IHRoaXMuY29tYmluZUNvZWZmaWNpZW50cyh2YXJpYWJsZXMpO1xyXG5cclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRoaXMuc3VtRXF1YWxzWmVybyguLi52YXJpYWJsZXMpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGNvbmZpZy5vYnRhaW5QYXJ0aWFsT3JkZXJzKSB7XHJcbiAgICAgICAgICAgIC8qXHJcbiAgICAgICAgICAgICAgICBTdW0gb2YgcmlzZXMgc2hvdWxkIGJlIDAgQU5EIFN1bSBvZiBhYnNvbHV0ZSByaXNlcyBzaG91bGQgYmUgMiAoaW50ZXJuYWwgcGxhY2VzKVxyXG4gICAgICAgICAgICAgICAgT1JcclxuICAgICAgICAgICAgICAgIFN1bSBvZiBhYnNvbHV0ZSByaXNlcyBzaG91bGQgYmUgMSAoaW5pdGlhbCBhbmQgZmluYWwgcGxhY2VzKVxyXG4gICAgICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgICAgIC8vIHN1bSBvZiByaXNlcyBpcyAwXHJcbiAgICAgICAgICAgIGNvbnN0IHJpc2VTdW1Jc1plcm8gPSB0aGlzLmhlbHBlclZhcmlhYmxlTmFtZSgncmlzZUVxdWFsWmVybycpO1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh0aGlzLnhXaGVuQUVxdWFsc0IocmlzZVN1bUlzWmVybywgdGhpcy5jb21iaW5lQ29lZmZpY2llbnRzKHJpc2VTdW1WYXJpYWJsZXMpLCAwKSk7XHJcbiAgICAgICAgICAgIC8vIHN1bSBvZiBhYnNvbHV0ZSB2YWx1ZXMgb2YgcmlzZXMgaXMgMlxyXG4gICAgICAgICAgICBjb25zdCBhYnNSaXNlU3VtSXNUd28gPSB0aGlzLmhlbHBlclZhcmlhYmxlTmFtZSgnYWJzUmlzZVN1bVR3bycpO1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh0aGlzLnhXaGVuQUVxdWFsc0IoYWJzUmlzZVN1bUlzVHdvLCBhYnNvbHV0ZVJpc2VTdW1WYXJpYWJsZXMsIDIpKTtcclxuICAgICAgICAgICAgLy8gc3VtIGlzIDAgQU5EIHN1bSBhYnNvbHV0ZSBpcyAyXHJcbiAgICAgICAgICAgIGNvbnN0IGludGVybmFsUGxhY2UgPSB0aGlzLmhlbHBlclZhcmlhYmxlTmFtZSgncGxhY2VJc0ludGVybmFsJyk7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKENvbnN0cmFpbnRzV2l0aE5ld1ZhcmlhYmxlcy5jb21iaW5lQW5kSW50cm9kdWNlVmFyaWFibGVzKFxyXG4gICAgICAgICAgICAgICAgW3Jpc2VTdW1Jc1plcm8sIGFic1Jpc2VTdW1Jc1R3b10sIHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgIHRoaXMueEFhbmRCKGludGVybmFsUGxhY2UsIHJpc2VTdW1Jc1plcm8sIGFic1Jpc2VTdW1Jc1R3bylcclxuICAgICAgICAgICAgKSk7XHJcblxyXG4gICAgICAgICAgICAvLyBzdW0gb2YgYWJzb2x1dGUgdmFsdWVzIG9mIHJpc2UgaXMgMVxyXG4gICAgICAgICAgICBjb25zdCBhYnNSaXNlU3VtSXNPbmUgPSB0aGlzLmhlbHBlclZhcmlhYmxlTmFtZSgnYWJzUmlzZVN1bU9uZScpO1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh0aGlzLnhXaGVuQUVxdWFsc0IoYWJzUmlzZVN1bUlzT25lLCBhYnNvbHV0ZVJpc2VTdW1WYXJpYWJsZXMsIDEpKTtcclxuXHJcbiAgICAgICAgICAgIC8vIHBsYWNlIGlzIGludGVybmFsIE9SIHBsYWNlIGlzIGluaXRpYWwvZmluYWxcclxuICAgICAgICAgICAgY29uc3QgaW50ZXJuYWxPckZpbmFsID0gdGhpcy5oZWxwZXJWYXJpYWJsZU5hbWUoJ2ludGVybmFsT3JGaW5hbCcpO1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZUFuZEludHJvZHVjZVZhcmlhYmxlcyhcclxuICAgICAgICAgICAgICAgIFtpbnRlcm5hbFBsYWNlLCBhYnNSaXNlU3VtSXNPbmUsIGludGVybmFsT3JGaW5hbF0sIHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgIHRoaXMueEFvckIoaW50ZXJuYWxPckZpbmFsLCBpbnRlcm5hbFBsYWNlLCBhYnNSaXNlU3VtSXNPbmUpXHJcbiAgICAgICAgICAgICkpO1xyXG5cclxuICAgICAgICAgICAgLy8gcGxhY2UgaXMgaW50ZXJuYWwgT1IgcGxhY2UgaXMgaW5pdGlhbC9maW5hbCBtdXN0IGJlIHRydWVcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2godGhpcy5lcXVhbCh0aGlzLnZhcmlhYmxlKGludGVybmFsT3JGaW5hbCksIDEpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBDb25zdHJhaW50c1dpdGhOZXdWYXJpYWJsZXMuY29tYmluZSguLi5yZXN1bHQpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWRkQ29uc3RyYWludHNUb0lMUChwczogUHJvYmxlbVNvbHV0aW9uKTogTFAge1xyXG4gICAgICAgIGNvbnN0IGlscCA9IHBzLmlscDtcclxuXHJcbiAgICAgICAgLy8gbm8gcmVnaW9uIHRoYXQgY29udGFpbnMgdGhlIG5ldyBzb2x1dGlvbiBhcyBzdWJzZXRcclxuICAgICAgICBjb25zdCByZWdpb24gPSBwcy5zb2x1dGlvbi5yZXN1bHQudmFycztcclxuICAgICAgICBjb25zdCByZWdpb25QbGFjZXMgPSBPYmplY3QuZW50cmllcyhyZWdpb24pLmZpbHRlcigoW2ssIHZdKSA9PiB2ICE9IDAgJiYgdGhpcy5fcGxhY2VWYXJpYWJsZXMuaGFzKGspKTtcclxuICAgICAgICBjb25zdCBhZGRpdGlvbmFsQ29uc3RyYWludHMgPSByZWdpb25QbGFjZXMubWFwKChbaywgdl0pID0+IHRoaXMueVdoZW5BR3JlYXRlckVxdWFsQihrLCB2KSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHlWYXJpYWJsZXMgPVxyXG4gICAgICAgICAgICBhZGRpdGlvbmFsQ29uc3RyYWludHNcclxuICAgICAgICAgICAgICAgIC5yZWR1Y2UoXHJcbiAgICAgICAgICAgICAgICAgICAgKGFyciwgY29uc3RyYWludCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnIucHVzaCguLi5jb25zdHJhaW50LmJpbmFyeVZhcmlhYmxlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcnI7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgW10gYXMgQXJyYXk8c3RyaW5nPilcclxuICAgICAgICAgICAgICAgIC5tYXAoXHJcbiAgICAgICAgICAgICAgICAgICAgeSA9PiB0aGlzLnZhcmlhYmxlKHkpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgIC8qXHJcbiAgICAgICAgICAgIFN1bSBvZiB4LWVzIHNob3VsZCBiZSBsZXNzIHRoYW4gdGhlaXIgbnVtYmVyXHJcbiAgICAgICAgICAgIHggPSAxIC0geVxyXG4gICAgICAgICAgICBUaGVyZWZvcmUgc3VtIG9mIHkgc2hvdWxkIGJlIGdyZWF0ZXIgdGhhbiAwXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgYWRkaXRpb25hbENvbnN0cmFpbnRzLnB1c2godGhpcy5zdW1HcmVhdGVyVGhhbih5VmFyaWFibGVzLCAwKSk7XHJcbiAgICAgICAgdGhpcy5hcHBseUNvbnN0cmFpbnRzKGlscCwgQ29uc3RyYWludHNXaXRoTmV3VmFyaWFibGVzLmNvbWJpbmUoLi4uYWRkaXRpb25hbENvbnN0cmFpbnRzKSk7XHJcblxyXG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ3NvbHV0aW9uJywgcHMuc29sdXRpb24ucmVzdWx0LnZhcnMpO1xyXG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ25vbi16ZXJvJywgcmVnaW9uUGxhY2VzKTtcclxuICAgICAgICBjb25zb2xlLmRlYnVnKCdhZGRpdGlvbmFsIGNvbnN0cmFpbnQnLCBpbHAuc3ViamVjdFRvW2lscC5zdWJqZWN0VG8ubGVuZ3RoIC0gMV0pO1xyXG5cclxuICAgICAgICByZXR1cm4gaWxwO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY29sbGVjdFRyYW5zaXRpb25CeUxhYmVsKG5ldDogUGV0cmlOZXQpOiBNYXA8c3RyaW5nLCBBcnJheTxUcmFuc2l0aW9uPj4ge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBNYXA8c3RyaW5nLCBBcnJheTxUcmFuc2l0aW9uPj4oKTtcclxuICAgICAgICBmb3IgKGNvbnN0IHQgb2YgbmV0LmdldFRyYW5zaXRpb25zKCkpIHtcclxuICAgICAgICAgICAgaWYgKHQubGFiZWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmFuc2l0aW9uIHdpdGggaWQgJyR7dC5pZH0nIGhhcyBubyBsYWJlbCEgQWxsIHRyYW5zaXRpb25zIG11c3QgYmUgbGFiZWxlZCBpbiB0aGUgaW5wdXQgbmV0IWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGFycmF5ID0gcmVzdWx0LmdldCh0LmxhYmVsKTtcclxuICAgICAgICAgICAgaWYgKGFycmF5ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5zZXQodC5sYWJlbCwgW3RdKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGFycmF5LnB1c2godCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxufVxyXG4iXX0=