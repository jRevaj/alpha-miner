import { Relabeler } from '../../../utility/relabeler';
import { OccurenceMatrixType } from '../../../algorithms/log/concurrency-oracle/occurrence-matrix';
export class ConcurrencyRelation {
    constructor(relabeler) {
        this._uniqueConcurrencyMatrix = {};
        this._wildcardConcurrencyMatrix = {};
        this._mixedConcurrencyMatrix = {};
        this._wildCardLabels = new Set();
        this._relabeler = relabeler.clone();
    }
    static noConcurrency() {
        return new ConcurrencyRelation(new Relabeler());
    }
    static fromOccurrenceMatrix(matrix, relabeler) {
        const result = new ConcurrencyRelation(relabeler);
        const keys = Array.from(matrix.keys);
        for (let i = 0; i < keys.length; i++) {
            const k1 = keys[i];
            for (let j = i + 1; j < keys.length; j++) {
                const k2 = keys[j];
                if (matrix.get(k1, k2) && matrix.get(k2, k1)) {
                    switch (matrix.type) {
                        case OccurenceMatrixType.UNIQUE:
                            result.setUniqueConcurrent(k1, k2, matrix.getOccurrenceFrequency(k1, k2), matrix.getOccurrenceFrequency(k2, k1));
                            break;
                        case OccurenceMatrixType.WILDCARD:
                            result.setWildcardConcurrent(k1, k2, matrix.getOccurrenceFrequency(k1, k2), matrix.getOccurrenceFrequency(k2, k1));
                            break;
                    }
                }
            }
        }
        return result;
    }
    isConcurrent(labelA, labelB) {
        const unique = this.read(this._uniqueConcurrencyMatrix, labelA, labelB);
        if (unique) {
            return true;
        }
        const wildcardA = this.getWildcard(labelA);
        const wildcardB = this.getWildcard(labelB);
        if (!wildcardA && !wildcardB) {
            return false;
        }
        else if (wildcardA && wildcardB) {
            return this.read(this._wildcardConcurrencyMatrix, wildcardA, wildcardB);
        }
        else if (wildcardA && !wildcardB) {
            return this.read(this._mixedConcurrencyMatrix, wildcardA, labelB);
        }
        else {
            return this.read(this._mixedConcurrencyMatrix, wildcardB, labelA);
        }
    }
    setUniqueConcurrent(uniqueLabelA, uniqueLabelB, value = true, frequencyBA) {
        if (typeof value === 'boolean') {
            this.set(this._uniqueConcurrencyMatrix, uniqueLabelA, uniqueLabelB, value);
            this.set(this._uniqueConcurrencyMatrix, uniqueLabelB, uniqueLabelA, value);
        }
        else {
            this.set(this._uniqueConcurrencyMatrix, uniqueLabelA, uniqueLabelB, value);
            this.set(this._uniqueConcurrencyMatrix, uniqueLabelB, uniqueLabelA, frequencyBA);
        }
    }
    setWildcardConcurrent(wildcardLabelA, wildcardLabelB, value = true, frequencyBA) {
        if (typeof value === 'boolean') {
            this.set(this._wildcardConcurrencyMatrix, wildcardLabelA, wildcardLabelB, value);
            this.set(this._wildcardConcurrencyMatrix, wildcardLabelB, wildcardLabelA, value);
        }
        else {
            this.set(this._wildcardConcurrencyMatrix, wildcardLabelA, wildcardLabelB, value);
            this.set(this._wildcardConcurrencyMatrix, wildcardLabelB, wildcardLabelA, frequencyBA);
        }
        this._wildCardLabels.add(wildcardLabelA);
        this._wildCardLabels.add(wildcardLabelB);
    }
    setMixedConcurrent(wildcardLabel, uniqueLabel, concurrency = true) {
        this.set(this._mixedConcurrencyMatrix, wildcardLabel, uniqueLabel, concurrency);
        this._wildCardLabels.add(wildcardLabel);
    }
    set(matrix, uniqueLabelA, uniqueLabelB, value = true) {
        const row = matrix[uniqueLabelA];
        if (row === undefined) {
            matrix[uniqueLabelA] = { [uniqueLabelB]: value };
            return;
        }
        row[uniqueLabelB] = value;
    }
    read(matrix, row, column) {
        const matrixRow = matrix[row];
        if (matrixRow === undefined) {
            return false;
        }
        return !!matrixRow[column];
    }
    getWildcard(label) {
        const undone = this.relabeler.undoLabel(label);
        if (this._wildCardLabels.has(undone)) {
            return undone;
        }
        return undefined;
    }
    get relabeler() {
        return this._relabeler;
    }
    cloneConcurrencyMatrices() {
        return {
            unique: this.cloneMatrix(this._uniqueConcurrencyMatrix),
            wildcard: this.cloneMatrix(this._wildcardConcurrencyMatrix),
            mixed: this.cloneMatrix(this._mixedConcurrencyMatrix)
        };
    }
    cloneMatrix(matrix) {
        const result = {};
        for (const row of Object.keys(matrix)) {
            for (const column of Object.keys(matrix[row])) {
                if (!matrix[row][column]) {
                    continue;
                }
                this.set(result, row, column, matrix[row][column]);
            }
        }
        return result;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uY3VycmVuY3ktcmVsYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jb21wb25lbnRzL3NyYy9saWIvbW9kZWxzL2NvbmN1cnJlbmN5L21vZGVsL2NvbmN1cnJlbmN5LXJlbGF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUNyRCxPQUFPLEVBQ0gsbUJBQW1CLEVBRXRCLE1BQU0sOERBQThELENBQUM7QUFJdEUsTUFBTSxPQUFPLG1CQUFtQjtJQVE1QixZQUFzQixTQUFvQjtRQUN0QyxJQUFJLENBQUMsd0JBQXdCLEdBQUcsRUFBRSxDQUFDO1FBQ25DLElBQUksQ0FBQywwQkFBMEIsR0FBRyxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLHVCQUF1QixHQUFHLEVBQUUsQ0FBQztRQUNsQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDekMsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUVNLE1BQU0sQ0FBQyxhQUFhO1FBQ3ZCLE9BQU8sSUFBSSxtQkFBbUIsQ0FBQyxJQUFJLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVNLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxNQUF3QixFQUFFLFNBQW9CO1FBQzdFLE1BQU0sTUFBTSxHQUFHLElBQUksbUJBQW1CLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFbEQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDbEMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDdEMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNuQixJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFO29CQUMxQyxRQUFRLE1BQU0sQ0FBQyxJQUFJLEVBQUU7d0JBQ2pCLEtBQUssbUJBQW1CLENBQUMsTUFBTTs0QkFDM0IsTUFBTSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsTUFBTSxDQUFDLHNCQUFzQixDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUUsRUFBRSxNQUFNLENBQUMsc0JBQXNCLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBRSxDQUFDLENBQUM7NEJBQ25ILE1BQU07d0JBQ1YsS0FBSyxtQkFBbUIsQ0FBQyxRQUFROzRCQUM3QixNQUFNLENBQUMscUJBQXFCLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsc0JBQXNCLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBRSxFQUFFLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFFLENBQUMsQ0FBQzs0QkFDckgsTUFBTTtxQkFDYjtpQkFDSjthQUNKO1NBQ0o7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRU0sWUFBWSxDQUFDLE1BQWMsRUFBRSxNQUFjO1FBQzlDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUF3QixFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN4RSxJQUFJLE1BQU0sRUFBRTtZQUNSLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFFRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzNDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUMxQixPQUFPLEtBQUssQ0FBQztTQUNoQjthQUFNLElBQUksU0FBUyxJQUFJLFNBQVMsRUFBRTtZQUMvQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLDBCQUEwQixFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUMzRTthQUFNLElBQUksU0FBUyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2hDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ3JFO2FBQU07WUFDSCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLFNBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUN0RTtJQUNMLENBQUM7SUFJTSxtQkFBbUIsQ0FBQyxZQUFvQixFQUFFLFlBQW9CLEVBQUUsUUFBMEIsSUFBSSxFQUFFLFdBQW9CO1FBQ3ZILElBQUksT0FBTyxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQzVCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLHdCQUF3QixFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDM0UsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM5RTthQUFNO1lBQ0gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMzRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLFdBQVksQ0FBQyxDQUFDO1NBQ3JGO0lBQ0wsQ0FBQztJQUlNLHFCQUFxQixDQUFDLGNBQXNCLEVBQUUsY0FBc0IsRUFBRSxRQUEwQixJQUFJLEVBQUUsV0FBb0I7UUFDN0gsSUFBSSxPQUFPLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDNUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNqRixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQywwQkFBMEIsRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3BGO2FBQU07WUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQywwQkFBMEIsRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2pGLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLDBCQUEwQixFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsV0FBWSxDQUFDLENBQUM7U0FDM0Y7UUFFRCxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRU0sa0JBQWtCLENBQUMsYUFBcUIsRUFBRSxXQUFtQixFQUFFLGNBQXVCLElBQUk7UUFDN0YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBSVMsR0FBRyxDQUFDLE1BQXlCLEVBQUUsWUFBb0IsRUFBRSxZQUFvQixFQUFFLFFBQTBCLElBQUk7UUFDL0csTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2pDLElBQUksR0FBRyxLQUFLLFNBQVMsRUFBRTtZQUNuQixNQUFNLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBQyxDQUFDLFlBQVksQ0FBQyxFQUFFLEtBQUssRUFBQyxDQUFDO1lBQy9DLE9BQU87U0FDVjtRQUNELEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUVTLElBQUksQ0FBQyxNQUF5QixFQUFFLEdBQVcsRUFBRSxNQUFjO1FBQ2pFLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QixJQUFJLFNBQVMsS0FBSyxTQUFTLEVBQUU7WUFDekIsT0FBTyxLQUFLLENBQUM7U0FDaEI7UUFDRCxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVTLFdBQVcsQ0FBQyxLQUFhO1FBQy9CLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9DLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbEMsT0FBTyxNQUFNLENBQUM7U0FDakI7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNyQixDQUFDO0lBRUQsSUFBSSxTQUFTO1FBQ1QsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQzNCLENBQUM7SUFFTSx3QkFBd0I7UUFDM0IsT0FBTztZQUNILE1BQU0sRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQztZQUN2RCxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUM7WUFDM0QsS0FBSyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDO1NBQ3hELENBQUM7SUFDTixDQUFDO0lBRVMsV0FBVyxDQUFDLE1BQXlCO1FBQzNDLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUVsQixLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbkMsS0FBSyxNQUFNLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dCQUMzQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUN0QixTQUFTO2lCQUNaO2dCQUNELElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBVyxDQUFDLENBQUM7YUFDaEU7U0FDSjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UmVsYWJlbGVyfSBmcm9tICcuLi8uLi8uLi91dGlsaXR5L3JlbGFiZWxlcic7XHJcbmltcG9ydCB7XHJcbiAgICBPY2N1cmVuY2VNYXRyaXhUeXBlLFxyXG4gICAgT2NjdXJyZW5jZU1hdHJpeFxyXG59IGZyb20gJy4uLy4uLy4uL2FsZ29yaXRobXMvbG9nL2NvbmN1cnJlbmN5LW9yYWNsZS9vY2N1cnJlbmNlLW1hdHJpeCc7XHJcbmltcG9ydCB7Q29uY3VycmVuY3lNYXRyaWNlcywgQ29uY3VycmVuY3lNYXRyaXh9IGZyb20gJy4vY29uY3VycmVuY3ktbWF0cml4JztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgQ29uY3VycmVuY3lSZWxhdGlvbiB7XHJcblxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBfcmVsYWJlbGVyOiBSZWxhYmVsZXI7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF91bmlxdWVDb25jdXJyZW5jeU1hdHJpeDogQ29uY3VycmVuY3lNYXRyaXg7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF93aWxkY2FyZENvbmN1cnJlbmN5TWF0cml4OiBDb25jdXJyZW5jeU1hdHJpeDtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX21peGVkQ29uY3VycmVuY3lNYXRyaXg6IENvbmN1cnJlbmN5TWF0cml4O1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBfd2lsZENhcmRMYWJlbHM6IFNldDxzdHJpbmc+O1xyXG5cclxuICAgIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihyZWxhYmVsZXI6IFJlbGFiZWxlcikge1xyXG4gICAgICAgIHRoaXMuX3VuaXF1ZUNvbmN1cnJlbmN5TWF0cml4ID0ge307XHJcbiAgICAgICAgdGhpcy5fd2lsZGNhcmRDb25jdXJyZW5jeU1hdHJpeCA9IHt9O1xyXG4gICAgICAgIHRoaXMuX21peGVkQ29uY3VycmVuY3lNYXRyaXggPSB7fTtcclxuICAgICAgICB0aGlzLl93aWxkQ2FyZExhYmVscyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG4gICAgICAgIHRoaXMuX3JlbGFiZWxlciA9IHJlbGFiZWxlci5jbG9uZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgbm9Db25jdXJyZW5jeSgpOiBDb25jdXJyZW5jeVJlbGF0aW9uIHtcclxuICAgICAgICByZXR1cm4gbmV3IENvbmN1cnJlbmN5UmVsYXRpb24obmV3IFJlbGFiZWxlcigpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGZyb21PY2N1cnJlbmNlTWF0cml4KG1hdHJpeDogT2NjdXJyZW5jZU1hdHJpeCwgcmVsYWJlbGVyOiBSZWxhYmVsZXIpOiBDb25jdXJyZW5jeVJlbGF0aW9uIHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQ29uY3VycmVuY3lSZWxhdGlvbihyZWxhYmVsZXIpO1xyXG5cclxuICAgICAgICBjb25zdCBrZXlzID0gQXJyYXkuZnJvbShtYXRyaXgua2V5cyk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGsxID0ga2V5c1tpXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IGkgKyAxOyBqIDwga2V5cy5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgazIgPSBrZXlzW2pdO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1hdHJpeC5nZXQoazEsIGsyKSAmJiBtYXRyaXguZ2V0KGsyLCBrMSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1hdHJpeC50eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgT2NjdXJlbmNlTWF0cml4VHlwZS5VTklRVUU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQuc2V0VW5pcXVlQ29uY3VycmVudChrMSwgazIsIG1hdHJpeC5nZXRPY2N1cnJlbmNlRnJlcXVlbmN5KGsxLCBrMikhLCBtYXRyaXguZ2V0T2NjdXJyZW5jZUZyZXF1ZW5jeShrMiwgazEpISk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBPY2N1cmVuY2VNYXRyaXhUeXBlLldJTERDQVJEOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnNldFdpbGRjYXJkQ29uY3VycmVudChrMSwgazIsIG1hdHJpeC5nZXRPY2N1cnJlbmNlRnJlcXVlbmN5KGsxLCBrMikhLCBtYXRyaXguZ2V0T2NjdXJyZW5jZUZyZXF1ZW5jeShrMiwgazEpISk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGlzQ29uY3VycmVudChsYWJlbEE6IHN0cmluZywgbGFiZWxCOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCB1bmlxdWUgPSB0aGlzLnJlYWQodGhpcy5fdW5pcXVlQ29uY3VycmVuY3lNYXRyaXgsIGxhYmVsQSwgbGFiZWxCKTtcclxuICAgICAgICBpZiAodW5pcXVlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgd2lsZGNhcmRBID0gdGhpcy5nZXRXaWxkY2FyZChsYWJlbEEpO1xyXG4gICAgICAgIGNvbnN0IHdpbGRjYXJkQiA9IHRoaXMuZ2V0V2lsZGNhcmQobGFiZWxCKTtcclxuICAgICAgICBpZiAoIXdpbGRjYXJkQSAmJiAhd2lsZGNhcmRCKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2UgaWYgKHdpbGRjYXJkQSAmJiB3aWxkY2FyZEIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVhZCh0aGlzLl93aWxkY2FyZENvbmN1cnJlbmN5TWF0cml4LCB3aWxkY2FyZEEsIHdpbGRjYXJkQik7XHJcbiAgICAgICAgfSBlbHNlIGlmICh3aWxkY2FyZEEgJiYgIXdpbGRjYXJkQikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZWFkKHRoaXMuX21peGVkQ29uY3VycmVuY3lNYXRyaXgsIHdpbGRjYXJkQSwgbGFiZWxCKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZWFkKHRoaXMuX21peGVkQ29uY3VycmVuY3lNYXRyaXgsIHdpbGRjYXJkQiEsIGxhYmVsQSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXRVbmlxdWVDb25jdXJyZW50KHVuaXF1ZUxhYmVsQTogc3RyaW5nLCB1bmlxdWVMYWJlbEI6IHN0cmluZywgY29uY3VycmVuY3k/OiBib29sZWFuKTogdm9pZDtcclxuICAgIHB1YmxpYyBzZXRVbmlxdWVDb25jdXJyZW50KHVuaXF1ZUxhYmVsQTogc3RyaW5nLCB1bmlxdWVMYWJlbEI6IHN0cmluZywgZnJlcXVlbmN5QUI6IG51bWJlciwgZnJlcXVlbmN5QkE6IG51bWJlcik6IHZvaWQ7XHJcbiAgICBwdWJsaWMgc2V0VW5pcXVlQ29uY3VycmVudCh1bmlxdWVMYWJlbEE6IHN0cmluZywgdW5pcXVlTGFiZWxCOiBzdHJpbmcsIHZhbHVlOiBib29sZWFuIHwgbnVtYmVyID0gdHJ1ZSwgZnJlcXVlbmN5QkE/OiBudW1iZXIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXQodGhpcy5fdW5pcXVlQ29uY3VycmVuY3lNYXRyaXgsIHVuaXF1ZUxhYmVsQSwgdW5pcXVlTGFiZWxCLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0KHRoaXMuX3VuaXF1ZUNvbmN1cnJlbmN5TWF0cml4LCB1bmlxdWVMYWJlbEIsIHVuaXF1ZUxhYmVsQSwgdmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0KHRoaXMuX3VuaXF1ZUNvbmN1cnJlbmN5TWF0cml4LCB1bmlxdWVMYWJlbEEsIHVuaXF1ZUxhYmVsQiwgdmFsdWUpO1xyXG4gICAgICAgICAgICB0aGlzLnNldCh0aGlzLl91bmlxdWVDb25jdXJyZW5jeU1hdHJpeCwgdW5pcXVlTGFiZWxCLCB1bmlxdWVMYWJlbEEsIGZyZXF1ZW5jeUJBISk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXRXaWxkY2FyZENvbmN1cnJlbnQod2lsZGNhcmRMYWJlbEE6IHN0cmluZywgd2lsZGNhcmRMYWJlbEI6IHN0cmluZywgY29uY3VycmVuY3k/OiBib29sZWFuKTogdm9pZDtcclxuICAgIHB1YmxpYyBzZXRXaWxkY2FyZENvbmN1cnJlbnQod2lsZGNhcmRMYWJlbEE6IHN0cmluZywgd2lsZGNhcmRMYWJlbEI6IHN0cmluZywgZnJlcXVlbmN5QUI6IG51bWJlciwgZnJlcXVlbmN5QkE6IG51bWJlcik6IHZvaWQ7XHJcbiAgICBwdWJsaWMgc2V0V2lsZGNhcmRDb25jdXJyZW50KHdpbGRjYXJkTGFiZWxBOiBzdHJpbmcsIHdpbGRjYXJkTGFiZWxCOiBzdHJpbmcsIHZhbHVlOiBib29sZWFuIHwgbnVtYmVyID0gdHJ1ZSwgZnJlcXVlbmN5QkE/OiBudW1iZXIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXQodGhpcy5fd2lsZGNhcmRDb25jdXJyZW5jeU1hdHJpeCwgd2lsZGNhcmRMYWJlbEEsIHdpbGRjYXJkTGFiZWxCLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0KHRoaXMuX3dpbGRjYXJkQ29uY3VycmVuY3lNYXRyaXgsIHdpbGRjYXJkTGFiZWxCLCB3aWxkY2FyZExhYmVsQSwgdmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0KHRoaXMuX3dpbGRjYXJkQ29uY3VycmVuY3lNYXRyaXgsIHdpbGRjYXJkTGFiZWxBLCB3aWxkY2FyZExhYmVsQiwgdmFsdWUpO1xyXG4gICAgICAgICAgICB0aGlzLnNldCh0aGlzLl93aWxkY2FyZENvbmN1cnJlbmN5TWF0cml4LCB3aWxkY2FyZExhYmVsQiwgd2lsZGNhcmRMYWJlbEEsIGZyZXF1ZW5jeUJBISk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl93aWxkQ2FyZExhYmVscy5hZGQod2lsZGNhcmRMYWJlbEEpO1xyXG4gICAgICAgIHRoaXMuX3dpbGRDYXJkTGFiZWxzLmFkZCh3aWxkY2FyZExhYmVsQik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldE1peGVkQ29uY3VycmVudCh3aWxkY2FyZExhYmVsOiBzdHJpbmcsIHVuaXF1ZUxhYmVsOiBzdHJpbmcsIGNvbmN1cnJlbmN5OiBib29sZWFuID0gdHJ1ZSkge1xyXG4gICAgICAgIHRoaXMuc2V0KHRoaXMuX21peGVkQ29uY3VycmVuY3lNYXRyaXgsIHdpbGRjYXJkTGFiZWwsIHVuaXF1ZUxhYmVsLCBjb25jdXJyZW5jeSk7XHJcbiAgICAgICAgdGhpcy5fd2lsZENhcmRMYWJlbHMuYWRkKHdpbGRjYXJkTGFiZWwpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBzZXQobWF0cml4OiBDb25jdXJyZW5jeU1hdHJpeCwgdW5pcXVlTGFiZWxBOiBzdHJpbmcsIHVuaXF1ZUxhYmVsQjogc3RyaW5nLCBjb25jdXJyZW5jeT86IGJvb2xlYW4pOiB2b2lkO1xyXG4gICAgcHJvdGVjdGVkIHNldChtYXRyaXg6IENvbmN1cnJlbmN5TWF0cml4LCB1bmlxdWVMYWJlbEE6IHN0cmluZywgdW5pcXVlTGFiZWxCOiBzdHJpbmcsIGZyZXF1ZW5jeTogbnVtYmVyKTogdm9pZDtcclxuICAgIHByb3RlY3RlZCBzZXQobWF0cml4OiBDb25jdXJyZW5jeU1hdHJpeCwgdW5pcXVlTGFiZWxBOiBzdHJpbmcsIHVuaXF1ZUxhYmVsQjogc3RyaW5nLCB2YWx1ZTogYm9vbGVhbiB8IG51bWJlciA9IHRydWUpIHtcclxuICAgICAgICBjb25zdCByb3cgPSBtYXRyaXhbdW5pcXVlTGFiZWxBXTtcclxuICAgICAgICBpZiAocm93ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgbWF0cml4W3VuaXF1ZUxhYmVsQV0gPSB7W3VuaXF1ZUxhYmVsQl06IHZhbHVlfTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICByb3dbdW5pcXVlTGFiZWxCXSA9IHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCByZWFkKG1hdHJpeDogQ29uY3VycmVuY3lNYXRyaXgsIHJvdzogc3RyaW5nLCBjb2x1bW46IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IG1hdHJpeFJvdyA9IG1hdHJpeFtyb3ddO1xyXG4gICAgICAgIGlmIChtYXRyaXhSb3cgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAhIW1hdHJpeFJvd1tjb2x1bW5dO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRXaWxkY2FyZChsYWJlbDogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICBjb25zdCB1bmRvbmUgPSB0aGlzLnJlbGFiZWxlci51bmRvTGFiZWwobGFiZWwpO1xyXG4gICAgICAgIGlmICh0aGlzLl93aWxkQ2FyZExhYmVscy5oYXModW5kb25lKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kb25lO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCByZWxhYmVsZXIoKTogUmVsYWJlbGVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcmVsYWJlbGVyO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbG9uZUNvbmN1cnJlbmN5TWF0cmljZXMoKTogQ29uY3VycmVuY3lNYXRyaWNlcyB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdW5pcXVlOiB0aGlzLmNsb25lTWF0cml4KHRoaXMuX3VuaXF1ZUNvbmN1cnJlbmN5TWF0cml4KSxcclxuICAgICAgICAgICAgd2lsZGNhcmQ6IHRoaXMuY2xvbmVNYXRyaXgodGhpcy5fd2lsZGNhcmRDb25jdXJyZW5jeU1hdHJpeCksXHJcbiAgICAgICAgICAgIG1peGVkOiB0aGlzLmNsb25lTWF0cml4KHRoaXMuX21peGVkQ29uY3VycmVuY3lNYXRyaXgpXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgY2xvbmVNYXRyaXgobWF0cml4OiBDb25jdXJyZW5jeU1hdHJpeCk6IENvbmN1cnJlbmN5TWF0cml4IHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB7fTtcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCByb3cgb2YgT2JqZWN0LmtleXMobWF0cml4KSkge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGNvbHVtbiBvZiBPYmplY3Qua2V5cyhtYXRyaXhbcm93XSkpIHtcclxuICAgICAgICAgICAgICAgIGlmICghbWF0cml4W3Jvd11bY29sdW1uXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXQocmVzdWx0LCByb3csIGNvbHVtbiwgbWF0cml4W3Jvd11bY29sdW1uXSBhcyBudW1iZXIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG59XHJcblxyXG4iXX0=