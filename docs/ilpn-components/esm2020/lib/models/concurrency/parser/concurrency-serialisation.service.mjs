import { Injectable } from '@angular/core';
import { AbstractParser } from '../../../utility/abstract-parser';
import * as i0 from "@angular/core";
export class ConcurrencySerialisationService {
    constructor() {
    }
    serialise(concurrency) {
        let result = `${AbstractParser.TYPE_BLOCK} concurrency\n`;
        const relabeler = concurrency.relabeler;
        const cachedUniqueLabels = new Map();
        const matrices = concurrency.cloneConcurrencyMatrices();
        this.iterateConcurrentEntries(matrices.unique, true, (labelA, labelB, fab, fba) => {
            const originalA = this.getOriginalLabel(labelA, cachedUniqueLabels, relabeler);
            const originalB = this.getOriginalLabel(labelB, cachedUniqueLabels, relabeler);
            result += this.formatConcurrencyEntry(this.formatUniqueLabel(originalA), this.formatUniqueLabel(originalB), fab, fba);
        });
        this.iterateConcurrentEntries(matrices.wildcard, true, (labelA, labelB, fab, fba) => {
            // TODO unmapping of wildcard labels might be needed
            result += this.formatConcurrencyEntry(labelA, labelB, fab, fba);
        });
        this.iterateConcurrentEntries(matrices.mixed, false, (wildcardLabel, uniqueLabel) => {
            // TODO unmapping of wildcard labels might be needed
            const uniqueOriginal = this.getOriginalLabel(uniqueLabel, cachedUniqueLabels, relabeler);
            result += this.formatConcurrencyEntry(wildcardLabel, this.formatUniqueLabel(uniqueOriginal));
        });
        return result;
    }
    iterateConcurrentEntries(matrix, symmetric, consumer) {
        if (!symmetric) {
            for (const labelA of Object.keys(matrix)) {
                for (const labelB of Object.keys(matrix[labelA])) {
                    this.processMatrixEntry(matrix, labelA, labelB, consumer);
                }
            }
        }
        else {
            const keys = Object.keys(matrix);
            for (let i = 0; i < keys.length; i++) {
                const labelA = keys[i];
                for (let j = i + 1; j < keys.length; j++) {
                    const labelB = keys[j];
                    this.processMatrixEntry(matrix, labelA, labelB, consumer);
                }
            }
        }
    }
    processMatrixEntry(matrix, labelA, labelB, consumer) {
        if (!matrix[labelA][labelB]) {
            return;
        }
        if (typeof matrix[labelA][labelB] === 'boolean') {
            consumer(labelA, labelB);
        }
        else {
            consumer(labelA, labelB, matrix[labelA][labelB], matrix[labelB][labelA]);
        }
    }
    getOriginalLabel(label, cachedUniqueLabels, relabeler) {
        const m = cachedUniqueLabels.get(label);
        if (m !== undefined) {
            return m;
        }
        const original = relabeler.getLabelMapping().get(label);
        if (original === undefined) {
            console.debug(relabeler);
            console.debug(label);
            throw new Error('Unique concurrency matrix contains an entry unknown to the relabeling function!');
        }
        const order = relabeler.getLabelOrder().get(original).findIndex(l => l === label);
        if (order === -1) {
            console.debug(relabeler);
            console.debug(label);
            throw new Error('Unique concurrency matrix contains an entry outside of the relabeling order of the relabeling function!');
        }
        cachedUniqueLabels.set(label, { original, order });
        return cachedUniqueLabels.get(label);
    }
    formatConcurrencyEntry(formattedLabelA, formattedLabelB, frequencyAB, frequencyBA) {
        if (frequencyAB === undefined && frequencyBA === undefined) {
            return `${formattedLabelA}${ConcurrencySerialisationService.PARALLEL_SYMBOL}${formattedLabelB}\n`;
        }
        else {
            return `${formattedLabelA}${ConcurrencySerialisationService.PARALLEL_SYMBOL}${formattedLabelB} #${frequencyAB} ${frequencyBA}\n`;
        }
    }
    formatUniqueLabel(label) {
        return `${label.original}[${label.order + 1}]`;
    }
}
ConcurrencySerialisationService.PARALLEL_SYMBOL = '∥';
ConcurrencySerialisationService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ConcurrencySerialisationService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
ConcurrencySerialisationService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ConcurrencySerialisationService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ConcurrencySerialisationService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uY3VycmVuY3ktc2VyaWFsaXNhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvY29tcG9uZW50cy9zcmMvbGliL21vZGVscy9jb25jdXJyZW5jeS9wYXJzZXIvY29uY3VycmVuY3ktc2VyaWFsaXNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFekMsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLGtDQUFrQyxDQUFDOztBQWFoRSxNQUFNLE9BQU8sK0JBQStCO0lBSXhDO0lBQ0EsQ0FBQztJQUVNLFNBQVMsQ0FBQyxXQUFnQztRQUM3QyxJQUFJLE1BQU0sR0FBRyxHQUFHLGNBQWMsQ0FBQyxVQUFVLGdCQUFnQixDQUFBO1FBRXpELE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUM7UUFDeEMsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLEdBQUcsRUFBMkIsQ0FBQztRQUM5RCxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUV4RCxJQUFJLENBQUMsd0JBQXdCLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUM5RSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLGtCQUFrQixFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQy9FLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsa0JBQWtCLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFL0UsTUFBTSxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFB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LGVBQWUsSUFBSSxDQUFDO1NBQ3JHO2FBQU07WUFDSCxPQUFPLEdBQUcsZUFBZSxHQUFHLCtCQUErQixDQUFDLGVBQWUsR0FBRyxlQUFlLEtBQUssV0FBVyxJQUFJLFdBQVcsSUFBSSxDQUFDO1NBQ3BJO0lBQ0wsQ0FBQztJQUVTLGlCQUFpQixDQUFDLEtBQXNCO1FBQzlDLE9BQU8sR0FBRyxLQUFLLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLENBQUM7SUFDbkQsQ0FBQzs7QUFqR2MsK0NBQWUsR0FBRyxHQUFJLENBQUE7NEhBRjVCLCtCQUErQjtnSUFBL0IsK0JBQStCLGNBRjVCLE1BQU07MkZBRVQsK0JBQStCO2tCQUgzQyxVQUFVO21CQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7Q29uY3VycmVuY3lSZWxhdGlvbn0gZnJvbSAnLi4vbW9kZWwvY29uY3VycmVuY3ktcmVsYXRpb24nO1xyXG5pbXBvcnQge0Fic3RyYWN0UGFyc2VyfSBmcm9tICcuLi8uLi8uLi91dGlsaXR5L2Fic3RyYWN0LXBhcnNlcic7XHJcbmltcG9ydCB7UmVsYWJlbGVyfSBmcm9tICcuLi8uLi8uLi91dGlsaXR5L3JlbGFiZWxlcic7XHJcbmltcG9ydCB7Q29uY3VycmVuY3lNYXRyaXh9IGZyb20gJy4uL21vZGVsL2NvbmN1cnJlbmN5LW1hdHJpeCc7XHJcblxyXG5cclxuaW50ZXJmYWNlIE9yZGVyZWRPcmlnaW5hbCB7XHJcbiAgICBvcmlnaW5hbDogc3RyaW5nLFxyXG4gICAgb3JkZXI6IG51bWJlclxyXG59XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIENvbmN1cnJlbmN5U2VyaWFsaXNhdGlvblNlcnZpY2Uge1xyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIFBBUkFMTEVMX1NZTUJPTCA9ICfiiKUnO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXJpYWxpc2UoY29uY3VycmVuY3k6IENvbmN1cnJlbmN5UmVsYXRpb24pOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCByZXN1bHQgPSBgJHtBYnN0cmFjdFBhcnNlci5UWVBFX0JMT0NLfSBjb25jdXJyZW5jeVxcbmBcclxuXHJcbiAgICAgICAgY29uc3QgcmVsYWJlbGVyID0gY29uY3VycmVuY3kucmVsYWJlbGVyO1xyXG4gICAgICAgIGNvbnN0IGNhY2hlZFVuaXF1ZUxhYmVscyA9IG5ldyBNYXA8c3RyaW5nLCBPcmRlcmVkT3JpZ2luYWw+KCk7XHJcbiAgICAgICAgY29uc3QgbWF0cmljZXMgPSBjb25jdXJyZW5jeS5jbG9uZUNvbmN1cnJlbmN5TWF0cmljZXMoKTtcclxuXHJcbiAgICAgICAgdGhpcy5pdGVyYXRlQ29uY3VycmVudEVudHJpZXMobWF0cmljZXMudW5pcXVlLCB0cnVlLCAobGFiZWxBLCBsYWJlbEIsIGZhYiwgZmJhKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsQSA9IHRoaXMuZ2V0T3JpZ2luYWxMYWJlbChsYWJlbEEsIGNhY2hlZFVuaXF1ZUxhYmVscywgcmVsYWJlbGVyKTtcclxuICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxCID0gdGhpcy5nZXRPcmlnaW5hbExhYmVsKGxhYmVsQiwgY2FjaGVkVW5pcXVlTGFiZWxzLCByZWxhYmVsZXIpO1xyXG5cclxuICAgICAgICAgICAgcmVzdWx0ICs9IHRoaXMuZm9ybWF0Q29uY3VycmVuY3lFbnRyeSh0aGlzLmZvcm1hdFVuaXF1ZUxhYmVsKG9yaWdpbmFsQSksIHRoaXMuZm9ybWF0VW5pcXVlTGFiZWwob3JpZ2luYWxCKSwgZmFiISwgZmJhISk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuaXRlcmF0ZUNvbmN1cnJlbnRFbnRyaWVzKG1hdHJpY2VzLndpbGRjYXJkLCB0cnVlLCAobGFiZWxBLCBsYWJlbEIsIGZhYiwgZmJhKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIFRPRE8gdW5tYXBwaW5nIG9mIHdpbGRjYXJkIGxhYmVscyBtaWdodCBiZSBuZWVkZWRcclxuICAgICAgICAgICAgcmVzdWx0ICs9IHRoaXMuZm9ybWF0Q29uY3VycmVuY3lFbnRyeShsYWJlbEEsIGxhYmVsQiwgZmFiISwgZmJhISk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuaXRlcmF0ZUNvbmN1cnJlbnRFbnRyaWVzKG1hdHJpY2VzLm1peGVkLCBmYWxzZSwgKHdpbGRjYXJkTGFiZWwsIHVuaXF1ZUxhYmVsKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIFRPRE8gdW5tYXBwaW5nIG9mIHdpbGRjYXJkIGxhYmVscyBtaWdodCBiZSBuZWVkZWRcclxuICAgICAgICAgICAgY29uc3QgdW5pcXVlT3JpZ2luYWwgPSB0aGlzLmdldE9yaWdpbmFsTGFiZWwodW5pcXVlTGFiZWwsIGNhY2hlZFVuaXF1ZUxhYmVscywgcmVsYWJlbGVyKTtcclxuXHJcbiAgICAgICAgICAgIHJlc3VsdCArPSB0aGlzLmZvcm1hdENvbmN1cnJlbmN5RW50cnkod2lsZGNhcmRMYWJlbCwgdGhpcy5mb3JtYXRVbmlxdWVMYWJlbCh1bmlxdWVPcmlnaW5hbCkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBpdGVyYXRlQ29uY3VycmVudEVudHJpZXMobWF0cml4OiBDb25jdXJyZW5jeU1hdHJpeCwgc3ltbWV0cmljOiBib29sZWFuLCBjb25zdW1lcjogKGE6IHN0cmluZywgYjogc3RyaW5nLCBmYWI/OiBudW1iZXIsIGZiYT86IG51bWJlcikgPT4gdm9pZCkge1xyXG4gICAgICAgIGlmICghc3ltbWV0cmljKSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgbGFiZWxBIG9mIE9iamVjdC5rZXlzKG1hdHJpeCkpIHtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbGFiZWxCIG9mIE9iamVjdC5rZXlzKG1hdHJpeFtsYWJlbEFdKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc01hdHJpeEVudHJ5KG1hdHJpeCwgbGFiZWxBLCBsYWJlbEIsIGNvbnN1bWVyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhtYXRyaXgpO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsQSA9IGtleXNbaV07XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gaSArIDE7IGogPCBrZXlzLmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFiZWxCID0ga2V5c1tqXTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NNYXRyaXhFbnRyeShtYXRyaXgsIGxhYmVsQSwgbGFiZWxCLCBjb25zdW1lcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHByb2Nlc3NNYXRyaXhFbnRyeShtYXRyaXg6IENvbmN1cnJlbmN5TWF0cml4LCBsYWJlbEE6IHN0cmluZywgbGFiZWxCOiBzdHJpbmcsIGNvbnN1bWVyOiAoYTogc3RyaW5nLCBiOiBzdHJpbmcsIGZhYj86IG51bWJlciwgZmJhPzogbnVtYmVyKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgaWYgKCFtYXRyaXhbbGFiZWxBXVtsYWJlbEJdKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHR5cGVvZiBtYXRyaXhbbGFiZWxBXVtsYWJlbEJdID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgY29uc3VtZXIobGFiZWxBLCBsYWJlbEIpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN1bWVyKGxhYmVsQSwgbGFiZWxCLCBtYXRyaXhbbGFiZWxBXVtsYWJlbEJdIGFzIG51bWJlciwgbWF0cml4W2xhYmVsQl1bbGFiZWxBXSBhcyBudW1iZXIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2V0T3JpZ2luYWxMYWJlbChsYWJlbDogc3RyaW5nLCBjYWNoZWRVbmlxdWVMYWJlbHM6IE1hcDxzdHJpbmcsIE9yZGVyZWRPcmlnaW5hbD4sIHJlbGFiZWxlcjogUmVsYWJlbGVyKTogT3JkZXJlZE9yaWdpbmFsIHtcclxuICAgICAgICBjb25zdCBtID0gY2FjaGVkVW5pcXVlTGFiZWxzLmdldChsYWJlbCk7XHJcbiAgICAgICAgaWYgKG0gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgb3JpZ2luYWwgPSByZWxhYmVsZXIuZ2V0TGFiZWxNYXBwaW5nKCkuZ2V0KGxhYmVsKTtcclxuICAgICAgICBpZiAob3JpZ2luYWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKHJlbGFiZWxlcik7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcobGFiZWwpO1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuaXF1ZSBjb25jdXJyZW5jeSBtYXRyaXggY29udGFpbnMgYW4gZW50cnkgdW5rbm93biB0byB0aGUgcmVsYWJlbGluZyBmdW5jdGlvbiEnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgb3JkZXIgPSByZWxhYmVsZXIuZ2V0TGFiZWxPcmRlcigpLmdldChvcmlnaW5hbCkhLmZpbmRJbmRleChsID0+IGwgPT09IGxhYmVsKTtcclxuICAgICAgICBpZiAob3JkZXIgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcocmVsYWJlbGVyKTtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhsYWJlbCk7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5pcXVlIGNvbmN1cnJlbmN5IG1hdHJpeCBjb250YWlucyBhbiBlbnRyeSBvdXRzaWRlIG9mIHRoZSByZWxhYmVsaW5nIG9yZGVyIG9mIHRoZSByZWxhYmVsaW5nIGZ1bmN0aW9uIScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYWNoZWRVbmlxdWVMYWJlbHMuc2V0KGxhYmVsLCB7b3JpZ2luYWwsIG9yZGVyfSk7XHJcbiAgICAgICAgcmV0dXJuIGNhY2hlZFVuaXF1ZUxhYmVscy5nZXQobGFiZWwpITtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZm9ybWF0Q29uY3VycmVuY3lFbnRyeShmb3JtYXR0ZWRMYWJlbEE6IHN0cmluZywgZm9ybWF0dGVkTGFiZWxCOiBzdHJpbmcpOiBzdHJpbmc7XHJcbiAgICBwcm90ZWN0ZWQgZm9ybWF0Q29uY3VycmVuY3lFbnRyeShmb3JtYXR0ZWRMYWJlbEE6IHN0cmluZywgZm9ybWF0dGVkTGFiZWxCOiBzdHJpbmcsIGZyZXF1ZW5jeUFCOiBudW1iZXIsIGZyZXF1ZW5jeUJBOiBudW1iZXIpOiBzdHJpbmdcclxuICAgIHByb3RlY3RlZCBmb3JtYXRDb25jdXJyZW5jeUVudHJ5KGZvcm1hdHRlZExhYmVsQTogc3RyaW5nLCBmb3JtYXR0ZWRMYWJlbEI6IHN0cmluZywgZnJlcXVlbmN5QUI/OiBudW1iZXIsIGZyZXF1ZW5jeUJBPzogbnVtYmVyKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoZnJlcXVlbmN5QUIgPT09IHVuZGVmaW5lZCAmJiBmcmVxdWVuY3lCQSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHtmb3JtYXR0ZWRMYWJlbEF9JHtDb25jdXJyZW5jeVNlcmlhbGlzYXRpb25TZXJ2aWNlLlBBUkFMTEVMX1NZTUJPTH0ke2Zvcm1hdHRlZExhYmVsQn1cXG5gO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHtmb3JtYXR0ZWRMYWJlbEF9JHtDb25jdXJyZW5jeVNlcmlhbGlzYXRpb25TZXJ2aWNlLlBBUkFMTEVMX1NZTUJPTH0ke2Zvcm1hdHRlZExhYmVsQn0gIyR7ZnJlcXVlbmN5QUJ9ICR7ZnJlcXVlbmN5QkF9XFxuYDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGZvcm1hdFVuaXF1ZUxhYmVsKGxhYmVsOiBPcmRlcmVkT3JpZ2luYWwpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBgJHtsYWJlbC5vcmlnaW5hbH1bJHtsYWJlbC5vcmRlciArIDF9XWA7XHJcbiAgICB9XHJcbn1cclxuIl19