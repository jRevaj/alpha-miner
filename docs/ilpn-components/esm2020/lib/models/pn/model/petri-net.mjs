import { Place } from './place';
import { Transition } from './transition';
import { Arc } from './arc';
import { Subject } from 'rxjs';
import { createUniqueString, IncrementingCounter } from '../../../utility/incrementing-counter';
import { getById } from '../../../utility/get-by-id';
import { Marking } from './marking';
export class PetriNet {
    constructor() {
        this._placeCounter = new IncrementingCounter();
        this._transitionCounter = new IncrementingCounter();
        this._arcCounter = new IncrementingCounter();
        this._places = new Map();
        this._transitions = new Map();
        this._arcs = new Map();
        this._kill$ = new Subject();
        this._redraw$ = new Subject();
        this._inputPlaces = new Set();
        this._outputPlaces = new Set();
    }
    static createFromArcSubset(net, arcs) {
        const result = new PetriNet();
        net.getPlaces().forEach(p => {
            result.addPlace(new Place(p.marking, p.x, p.y, p.id));
        });
        net.getTransitions().forEach(t => {
            result.addTransition(new Transition(t.label, t.x, t.y, t.id));
        });
        arcs.forEach(a => {
            let source;
            let destination;
            if (a.source instanceof Place) {
                source = result.getPlace(a.sourceId);
                destination = result.getTransition(a.destinationId);
            }
            else {
                source = result.getTransition(a.sourceId);
                destination = result.getPlace(a.destinationId);
            }
            result.addArc(new Arc(a.getId(), source, destination, a.weight));
        });
        return result;
    }
    static netUnion(a, b) {
        const result = a.clone();
        const counter = new IncrementingCounter();
        const placeMap = new Map();
        const transitionMap = new Map();
        b.getPlaces().forEach(p => {
            let mappedId = p.getId();
            while (result.getPlace(mappedId) !== undefined) {
                mappedId = p.getId() + counter.next();
            }
            placeMap.set(p.getId(), mappedId);
            result.addPlace(new Place(p.marking, p.x, p.y, mappedId));
        });
        b.getTransitions().forEach(t => {
            let mappedId = t.getId();
            while (result.getTransition(mappedId) !== undefined) {
                mappedId = t.getId() + counter.next();
            }
            transitionMap.set(t.getId(), mappedId);
            result.addTransition(new Transition(t.label, t.x, t.y, mappedId));
        });
        b.getArcs().forEach(arc => {
            let arcId = arc.getId();
            while (result.getArc(arcId) !== undefined) {
                arcId = arc.getId() + counter.next();
            }
            if (arc.source instanceof Place) {
                result.addArc(new Arc(arcId, result.getPlace(placeMap.get(arc.sourceId)), result.getTransition(transitionMap.get(arc.destinationId)), arc.weight));
            }
            else {
                result.addArc(new Arc(arcId, result.getTransition(transitionMap.get(arc.sourceId)), result.getPlace(placeMap.get(arc.destinationId)), arc.weight));
            }
        });
        const inputPlacesB = new Set(result._inputPlaces);
        const outputPlacesB = new Set(result._outputPlaces);
        a.inputPlaces.forEach(p => {
            inputPlacesB.delete(p);
        });
        a.outputPlaces.forEach(p => {
            outputPlacesB.delete(p);
        });
        return { net: result, inputPlacesB, outputPlacesB };
    }
    static fireTransitionInMarking(net, transitionId, marking) {
        const transition = net.getTransition(transitionId);
        if (transition === undefined) {
            throw new Error(`The given net does not contain a transition with id '${transitionId}'`);
        }
        const newMarking = new Marking(marking);
        for (const inArc of transition.ingoingArcs) {
            const m = marking.get(inArc.sourceId);
            if (m === undefined) {
                throw new Error(`The transition with id '${transitionId}' has an incoming arc from a place with id '${inArc.sourceId}' but no such place is defined in the provided marking!`);
            }
            if (m - inArc.weight < 0) {
                throw new Error(`The transition with id '${transitionId}' is not enabled in the provided marking! The place with id '${inArc.sourceId}' contains ${m} tokens, but the arc weight is ${inArc.weight}.`);
            }
            newMarking.set(inArc.sourceId, m - inArc.weight);
        }
        for (const outArc of transition.outgoingArcs) {
            const m = marking.get(outArc.destinationId);
            if (m === undefined) {
                throw new Error(`The transition with id '${transitionId}' has an outgoing arc to a place with id '${outArc.destinationId}' but no such place is defined in the provided marking!`);
            }
            newMarking.set(outArc.destinationId, m + outArc.weight);
        }
        return newMarking;
    }
    static getAllEnabledTransitions(net, marking) {
        return net.getTransitions().filter(t => PetriNet.isTransitionEnabledInMarking(net, t.id, marking));
    }
    static isTransitionEnabledInMarking(net, transitionId, marking) {
        const transition = net.getTransition(transitionId);
        if (transition === undefined) {
            throw new Error(`The given net does not contain a transition with id '${transitionId}'`);
        }
        for (const inArc of transition.ingoingArcs) {
            const m = marking.get(inArc.sourceId);
            if (m === undefined) {
                throw new Error(`The transition with id '${transitionId}' has an incoming arc from a place with id '${inArc.sourceId}' but no such place is defined in the provided marking!`);
            }
            if (m - inArc.weight < 0) {
                return false;
            }
        }
        return true;
    }
    static determineInOut(p, input, output) {
        if (p.ingoingArcs.length === 0) {
            input.add(p.getId());
        }
        if (p.outgoingArcs.length === 0) {
            output.add(p.getId());
        }
    }
    getTransition(id) {
        return this._transitions.get(id);
    }
    getTransitions() {
        return Array.from(this._transitions.values());
    }
    getTransitionCount() {
        return this._transitions.size;
    }
    addTransition(transition) {
        if (transition.id === undefined) {
            transition.id = createUniqueString('t', this._transitions, this._transitionCounter);
        }
        this._transitions.set(transition.id, transition);
    }
    removeTransition(transition) {
        const t = getById(this._transitions, transition);
        if (t === undefined) {
            return;
        }
        transition = t;
        this._transitions.delete(transition.getId());
        transition.outgoingArcs.forEach(a => {
            this.removeArc(a);
        });
        transition.ingoingArcs.forEach(a => {
            this.removeArc(a);
        });
    }
    getPlace(id) {
        return this._places.get(id);
    }
    getPlaces() {
        return Array.from(this._places.values());
    }
    getPlaceCount() {
        return this._places.size;
    }
    addPlace(place) {
        if (place.id === undefined) {
            place.id = createUniqueString('p', this._places, this._placeCounter);
        }
        this._places.set(place.id, place);
        this._inputPlaces.add(place.id);
        this._outputPlaces.add(place.id);
    }
    removePlace(place) {
        const p = getById(this._places, place);
        if (p === undefined) {
            return;
        }
        place = p;
        this._places.delete(place.getId());
        place.outgoingArcs.forEach(a => {
            this.removeArc(a);
        });
        place.ingoingArcs.forEach(a => {
            this.removeArc(a);
        });
        this._inputPlaces.delete(place.getId());
        this._outputPlaces.delete(place.getId());
    }
    getArc(id) {
        return this._arcs.get(id);
    }
    getArcs() {
        return Array.from(this._arcs.values());
    }
    getArcCount() {
        return this._arcs.size;
    }
    addArc(arcOrSource, destination, weight = 1) {
        if (arcOrSource instanceof Arc) {
            this._arcs.set(arcOrSource.getId(), arcOrSource);
            if (arcOrSource.source instanceof Place) {
                this._outputPlaces.delete(arcOrSource.sourceId);
            }
            else if (arcOrSource.destination instanceof Place) {
                this._inputPlaces.delete(arcOrSource.destinationId);
            }
        }
        else {
            this.addArc(new Arc(createUniqueString('a', this._arcs, this._arcCounter), arcOrSource, destination, weight));
        }
    }
    removeArc(arc) {
        const a = getById(this._arcs, arc);
        if (a === undefined) {
            return;
        }
        arc = a;
        this._arcs.delete(arc.getId());
        arc.source.removeArc(arc);
        arc.destination.removeArc(arc);
        if (arc.source instanceof Place && arc.source.outgoingArcs.length === 0) {
            this._outputPlaces.add(arc.sourceId);
        }
        else if (arc.destination instanceof Place && arc.destination.ingoingArcs.length === 0) {
            this._inputPlaces.add(arc.destinationId);
        }
    }
    get frequency() {
        return this._frequency;
    }
    set frequency(value) {
        this._frequency = value;
    }
    get inputPlaces() {
        return this._inputPlaces;
    }
    get outputPlaces() {
        return this._outputPlaces;
    }
    getInputPlaces() {
        return this.getPlacesById(this._inputPlaces);
    }
    getOutputPlaces() {
        return this.getPlacesById(this._outputPlaces);
    }
    getInitialMarking() {
        const m = new Marking({});
        this.getPlaces().forEach(p => {
            m.set(p.id, p.marking);
        });
        return m;
    }
    isEmpty() {
        return this._places.size === 0 && this._transitions.size === 0;
    }
    clone() {
        return PetriNet.createFromArcSubset(this, this.getArcs());
    }
    destroy() {
        if (!this._kill$.closed) {
            this._kill$.next();
            this._kill$.complete();
        }
        this._redraw$.complete();
    }
    bindEvents(mouseMoved$, mouseUp$) {
        this._places.forEach((v, k) => v.bindEvents(mouseMoved$, mouseUp$, this._kill$.asObservable(), this._redraw$));
        this._transitions.forEach((v, k) => v.bindEvents(mouseMoved$, mouseUp$, this._kill$.asObservable(), this._redraw$));
        this._arcs.forEach((v, k) => v.bindEvents(mouseMoved$, mouseUp$, this._kill$.asObservable(), this._redraw$));
    }
    redrawRequest$() {
        return this._redraw$.asObservable();
    }
    getPlacesById(ids) {
        const r = [];
        for (const id of ids) {
            const p = this.getPlace(id);
            if (p === undefined) {
                throw new Error(`Place with id '${id}' is not present in the net!`);
            }
            r.push(p);
        }
        return r;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGV0cmktbmV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvY29tcG9uZW50cy9zcmMvbGliL21vZGVscy9wbi9tb2RlbC9wZXRyaS1uZXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLFNBQVMsQ0FBQztBQUM5QixPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBQ3hDLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxFQUFhLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN6QyxPQUFPLEVBQUMsa0JBQWtCLEVBQUUsbUJBQW1CLEVBQUMsTUFBTSx1Q0FBdUMsQ0FBQztBQUU5RixPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFDbkQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUVsQyxNQUFNLE9BQU8sUUFBUTtJQWdCakI7UUFKUSxrQkFBYSxHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQztRQUMxQyx1QkFBa0IsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7UUFDL0MsZ0JBQVcsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7UUFHNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBaUIsQ0FBQztRQUN4QyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQ2xELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxHQUFHLEVBQWUsQ0FBQztRQUNwQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDbEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUN0QyxJ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R0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzVCLElBQUksQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSw4QkFBOEIsQ0FBQyxDQUFDO2FBQ3ZFO1lBQ0QsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNiO1FBQ0QsT0FBTyxDQUFDLENBQUM7SUFDYixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1BsYWNlfSBmcm9tICcuL3BsYWNlJztcclxuaW1wb3J0IHtUcmFuc2l0aW9ufSBmcm9tICcuL3RyYW5zaXRpb24nO1xyXG5pbXBvcnQge0FyY30gZnJvbSAnLi9hcmMnO1xyXG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3R9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge2NyZWF0ZVVuaXF1ZVN0cmluZywgSW5jcmVtZW50aW5nQ291bnRlcn0gZnJvbSAnLi4vLi4vLi4vdXRpbGl0eS9pbmNyZW1lbnRpbmctY291bnRlcic7XHJcbmltcG9ydCB7TmV0VW5pb25SZXN1bHR9IGZyb20gJy4vbmV0LXVuaW9uLXJlc3VsdCc7XHJcbmltcG9ydCB7Z2V0QnlJZH0gZnJvbSAnLi4vLi4vLi4vdXRpbGl0eS9nZXQtYnktaWQnO1xyXG5pbXBvcnQge01hcmtpbmd9IGZyb20gJy4vbWFya2luZyc7XHJcblxyXG5leHBvcnQgY2xhc3MgUGV0cmlOZXQge1xyXG4gICAgcHJpdmF0ZSBfcGxhY2VzOiBNYXA8c3RyaW5nLCBQbGFjZT47XHJcbiAgICBwcml2YXRlIF90cmFuc2l0aW9uczogTWFwPHN0cmluZywgVHJhbnNpdGlvbj47XHJcbiAgICBwcml2YXRlIF9hcmNzOiBNYXA8c3RyaW5nLCBBcmM+O1xyXG4gICAgcHJpdmF0ZSBfZnJlcXVlbmN5OiBudW1iZXIgfCB1bmRlZmluZWQ7XHJcbiAgICBwcml2YXRlIF9pbnB1dFBsYWNlczogU2V0PHN0cmluZz47XHJcbiAgICBwcml2YXRlIF9vdXRwdXRQbGFjZXM6IFNldDxzdHJpbmc+O1xyXG5cclxuICAgIHByaXZhdGUgX2tpbGwkOiBTdWJqZWN0PHZvaWQ+O1xyXG5cclxuICAgIHByaXZhdGUgX3JlZHJhdyQ6IFN1YmplY3Q8dm9pZD47XHJcblxyXG4gICAgcHJpdmF0ZSBfcGxhY2VDb3VudGVyID0gbmV3IEluY3JlbWVudGluZ0NvdW50ZXIoKTtcclxuICAgIHByaXZhdGUgX3RyYW5zaXRpb25Db3VudGVyID0gbmV3IEluY3JlbWVudGluZ0NvdW50ZXIoKTtcclxuICAgIHByaXZhdGUgX2FyY0NvdW50ZXIgPSBuZXcgSW5jcmVtZW50aW5nQ291bnRlcigpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMuX3BsYWNlcyA9IG5ldyBNYXA8c3RyaW5nLCBQbGFjZT4oKTtcclxuICAgICAgICB0aGlzLl90cmFuc2l0aW9ucyA9IG5ldyBNYXA8c3RyaW5nLCBUcmFuc2l0aW9uPigpO1xyXG4gICAgICAgIHRoaXMuX2FyY3MgPSBuZXcgTWFwPHN0cmluZywgQXJjPigpO1xyXG4gICAgICAgIHRoaXMuX2tpbGwkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuICAgICAgICB0aGlzLl9yZWRyYXckID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuICAgICAgICB0aGlzLl9pbnB1dFBsYWNlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG4gICAgICAgIHRoaXMuX291dHB1dFBsYWNlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlRnJvbUFyY1N1YnNldChuZXQ6IFBldHJpTmV0LCBhcmNzOiBBcnJheTxBcmM+KTogUGV0cmlOZXQge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBQZXRyaU5ldCgpO1xyXG4gICAgICAgIG5ldC5nZXRQbGFjZXMoKS5mb3JFYWNoKHAgPT4ge1xyXG4gICAgICAgICAgICByZXN1bHQuYWRkUGxhY2UobmV3IFBsYWNlKHAubWFya2luZywgcC54LCBwLnksIHAuaWQpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBuZXQuZ2V0VHJhbnNpdGlvbnMoKS5mb3JFYWNoKHQgPT4ge1xyXG4gICAgICAgICAgICByZXN1bHQuYWRkVHJhbnNpdGlvbihuZXcgVHJhbnNpdGlvbih0LmxhYmVsLCB0LngsIHQueSwgdC5pZCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGFyY3MuZm9yRWFjaChhID0+IHtcclxuICAgICAgICAgICAgbGV0IHNvdXJjZTtcclxuICAgICAgICAgICAgbGV0IGRlc3RpbmF0aW9uO1xyXG4gICAgICAgICAgICBpZiAoYS5zb3VyY2UgaW5zdGFuY2VvZiBQbGFjZSkge1xyXG4gICAgICAgICAgICAgICAgc291cmNlID0gcmVzdWx0LmdldFBsYWNlKGEuc291cmNlSWQpIGFzIFBsYWNlO1xyXG4gICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSByZXN1bHQuZ2V0VHJhbnNpdGlvbihhLmRlc3RpbmF0aW9uSWQpIGFzIFRyYW5zaXRpb247XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzb3VyY2UgPSByZXN1bHQuZ2V0VHJhbnNpdGlvbihhLnNvdXJjZUlkKSBhcyBUcmFuc2l0aW9uO1xyXG4gICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSByZXN1bHQuZ2V0UGxhY2UoYS5kZXN0aW5hdGlvbklkKSBhcyBQbGFjZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXN1bHQuYWRkQXJjKG5ldyBBcmMoYS5nZXRJZCgpLCBzb3VyY2UsIGRlc3RpbmF0aW9uLCBhLndlaWdodCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBuZXRVbmlvbihhOiBQZXRyaU5ldCwgYjogUGV0cmlOZXQpOiBOZXRVbmlvblJlc3VsdCB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYS5jbG9uZSgpO1xyXG5cclxuICAgICAgICBjb25zdCBjb3VudGVyID0gbmV3IEluY3JlbWVudGluZ0NvdW50ZXIoKTtcclxuICAgICAgICBjb25zdCBwbGFjZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcbiAgICAgICAgY29uc3QgdHJhbnNpdGlvbk1hcCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcblxyXG4gICAgICAgIGIuZ2V0UGxhY2VzKCkuZm9yRWFjaChwID0+IHtcclxuICAgICAgICAgICAgbGV0IG1hcHBlZElkID0gcC5nZXRJZCgpO1xyXG4gICAgICAgICAgICB3aGlsZSAocmVzdWx0LmdldFBsYWNlKG1hcHBlZElkKSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBtYXBwZWRJZCA9IHAuZ2V0SWQoKSArIGNvdW50ZXIubmV4dCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHBsYWNlTWFwLnNldChwLmdldElkKCksIG1hcHBlZElkKTtcclxuICAgICAgICAgICAgcmVzdWx0LmFkZFBsYWNlKG5ldyBQbGFjZShwLm1hcmtpbmcsIHAueCwgcC55LCBtYXBwZWRJZCkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBiLmdldFRyYW5zaXRpb25zKCkuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgbGV0IG1hcHBlZElkID0gdC5nZXRJZCgpO1xyXG4gICAgICAgICAgICB3aGlsZSAocmVzdWx0LmdldFRyYW5zaXRpb24obWFwcGVkSWQpICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIG1hcHBlZElkID0gdC5nZXRJZCgpICsgY291bnRlci5uZXh0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdHJhbnNpdGlvbk1hcC5zZXQodC5nZXRJZCgpLCBtYXBwZWRJZCk7XHJcbiAgICAgICAgICAgIHJlc3VsdC5hZGRUcmFuc2l0aW9uKG5ldyBUcmFuc2l0aW9uKHQubGFiZWwsIHQueCwgdC55LCBtYXBwZWRJZCkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBiLmdldEFyY3MoKS5mb3JFYWNoKGFyYyA9PiB7XHJcbiAgICAgICAgICAgIGxldCBhcmNJZCA9IGFyYy5nZXRJZCgpO1xyXG4gICAgICAgICAgICB3aGlsZSAocmVzdWx0LmdldEFyYyhhcmNJZCkgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgYXJjSWQgPSBhcmMuZ2V0SWQoKSArIGNvdW50ZXIubmV4dCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhcmMuc291cmNlIGluc3RhbmNlb2YgUGxhY2UpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5hZGRBcmMobmV3IEFyYyhhcmNJZCwgcmVzdWx0LmdldFBsYWNlKHBsYWNlTWFwLmdldChhcmMuc291cmNlSWQpIGFzIHN0cmluZykgYXMgUGxhY2UsIHJlc3VsdC5nZXRUcmFuc2l0aW9uKHRyYW5zaXRpb25NYXAuZ2V0KGFyYy5kZXN0aW5hdGlvbklkKSBhcyBzdHJpbmcpIGFzIFRyYW5zaXRpb24sIGFyYy53ZWlnaHQpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5hZGRBcmMobmV3IEFyYyhhcmNJZCwgcmVzdWx0LmdldFRyYW5zaXRpb24odHJhbnNpdGlvbk1hcC5nZXQoYXJjLnNvdXJjZUlkKSBhcyBzdHJpbmcpIGFzIFRyYW5zaXRpb24sIHJlc3VsdC5nZXRQbGFjZShwbGFjZU1hcC5nZXQoYXJjLmRlc3RpbmF0aW9uSWQpIGFzIHN0cmluZykgYXMgUGxhY2UsIGFyYy53ZWlnaHQpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBpbnB1dFBsYWNlc0IgPSBuZXcgU2V0PHN0cmluZz4ocmVzdWx0Ll9pbnB1dFBsYWNlcyk7XHJcbiAgICAgICAgY29uc3Qgb3V0cHV0UGxhY2VzQiA9IG5ldyBTZXQ8c3RyaW5nPihyZXN1bHQuX291dHB1dFBsYWNlcyk7XHJcblxyXG4gICAgICAgIGEuaW5wdXRQbGFjZXMuZm9yRWFjaChwID0+IHtcclxuICAgICAgICAgICAgaW5wdXRQbGFjZXNCLmRlbGV0ZShwKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIGEub3V0cHV0UGxhY2VzLmZvckVhY2gocCA9PiB7XHJcbiAgICAgICAgICAgIG91dHB1dFBsYWNlc0IuZGVsZXRlKHApXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgcmV0dXJuIHtuZXQ6IHJlc3VsdCwgaW5wdXRQbGFjZXNCLCBvdXRwdXRQbGFjZXNCfTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGZpcmVUcmFuc2l0aW9uSW5NYXJraW5nKG5ldDogUGV0cmlOZXQsIHRyYW5zaXRpb25JZDogc3RyaW5nLCBtYXJraW5nOiBNYXJraW5nKTogTWFya2luZyB7XHJcbiAgICAgICAgY29uc3QgdHJhbnNpdGlvbiA9IG5ldC5nZXRUcmFuc2l0aW9uKHRyYW5zaXRpb25JZCk7XHJcbiAgICAgICAgaWYgKHRyYW5zaXRpb24gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBnaXZlbiBuZXQgZG9lcyBub3QgY29udGFpbiBhIHRyYW5zaXRpb24gd2l0aCBpZCAnJHt0cmFuc2l0aW9uSWR9J2ApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbmV3TWFya2luZzogTWFya2luZyA9IG5ldyBNYXJraW5nKG1hcmtpbmcpO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGluQXJjIG9mIHRyYW5zaXRpb24uaW5nb2luZ0FyY3MpIHtcclxuICAgICAgICAgICAgY29uc3QgbSA9IG1hcmtpbmcuZ2V0KGluQXJjLnNvdXJjZUlkKTtcclxuICAgICAgICAgICAgaWYgKG0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgdHJhbnNpdGlvbiB3aXRoIGlkICcke3RyYW5zaXRpb25JZH0nIGhhcyBhbiBpbmNvbWluZyBhcmMgZnJvbSBhIHBsYWNlIHdpdGggaWQgJyR7aW5BcmMuc291cmNlSWR9JyBidXQgbm8gc3VjaCBwbGFjZSBpcyBkZWZpbmVkIGluIHRoZSBwcm92aWRlZCBtYXJraW5nIWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChtIC0gaW5BcmMud2VpZ2h0IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgdHJhbnNpdGlvbiB3aXRoIGlkICcke3RyYW5zaXRpb25JZH0nIGlzIG5vdCBlbmFibGVkIGluIHRoZSBwcm92aWRlZCBtYXJraW5nISBUaGUgcGxhY2Ugd2l0aCBpZCAnJHtpbkFyYy5zb3VyY2VJZH0nIGNvbnRhaW5zICR7bX0gdG9rZW5zLCBidXQgdGhlIGFyYyB3ZWlnaHQgaXMgJHtpbkFyYy53ZWlnaHR9LmApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG5ld01hcmtpbmcuc2V0KGluQXJjLnNvdXJjZUlkLCBtIC0gaW5BcmMud2VpZ2h0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3Qgb3V0QXJjIG9mIHRyYW5zaXRpb24ub3V0Z29pbmdBcmNzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG0gPSBtYXJraW5nLmdldChvdXRBcmMuZGVzdGluYXRpb25JZCk7XHJcbiAgICAgICAgICAgIGlmIChtID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHRyYW5zaXRpb24gd2l0aCBpZCAnJHt0cmFuc2l0aW9uSWR9JyBoYXMgYW4gb3V0Z29pbmcgYXJjIHRvIGEgcGxhY2Ugd2l0aCBpZCAnJHtvdXRBcmMuZGVzdGluYXRpb25JZH0nIGJ1dCBubyBzdWNoIHBsYWNlIGlzIGRlZmluZWQgaW4gdGhlIHByb3ZpZGVkIG1hcmtpbmchYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbmV3TWFya2luZy5zZXQob3V0QXJjLmRlc3RpbmF0aW9uSWQsIG0gKyBvdXRBcmMud2VpZ2h0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBuZXdNYXJraW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0QWxsRW5hYmxlZFRyYW5zaXRpb25zKG5ldDogUGV0cmlOZXQsIG1hcmtpbmc6IE1hcmtpbmcpOiBBcnJheTxUcmFuc2l0aW9uPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldC5nZXRUcmFuc2l0aW9ucygpLmZpbHRlcih0ID0+IFBldHJpTmV0LmlzVHJhbnNpdGlvbkVuYWJsZWRJbk1hcmtpbmcobmV0LCB0LmlkISwgbWFya2luZykpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgaXNUcmFuc2l0aW9uRW5hYmxlZEluTWFya2luZyhuZXQ6IFBldHJpTmV0LCB0cmFuc2l0aW9uSWQ6IHN0cmluZywgbWFya2luZzogTWFya2luZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IHRyYW5zaXRpb24gPSBuZXQuZ2V0VHJhbnNpdGlvbih0cmFuc2l0aW9uSWQpO1xyXG4gICAgICAgIGlmICh0cmFuc2l0aW9uID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZ2l2ZW4gbmV0IGRvZXMgbm90IGNvbnRhaW4gYSB0cmFuc2l0aW9uIHdpdGggaWQgJyR7dHJhbnNpdGlvbklkfSdgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgaW5BcmMgb2YgdHJhbnNpdGlvbi5pbmdvaW5nQXJjcykge1xyXG4gICAgICAgICAgICBjb25zdCBtID0gbWFya2luZy5nZXQoaW5BcmMuc291cmNlSWQpO1xyXG4gICAgICAgICAgICBpZiAobSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSB0cmFuc2l0aW9uIHdpdGggaWQgJyR7dHJhbnNpdGlvbklkfScgaGFzIGFuIGluY29taW5nIGFyYyBmcm9tIGEgcGxhY2Ugd2l0aCBpZCAnJHtpbkFyYy5zb3VyY2VJZH0nIGJ1dCBubyBzdWNoIHBsYWNlIGlzIGRlZmluZWQgaW4gdGhlIHByb3ZpZGVkIG1hcmtpbmchYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG0gLSBpbkFyYy53ZWlnaHQgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZGV0ZXJtaW5lSW5PdXQocDogUGxhY2UsIGlucHV0OiBTZXQ8c3RyaW5nPiwgb3V0cHV0OiBTZXQ8c3RyaW5nPikge1xyXG4gICAgICAgIGlmIChwLmluZ29pbmdBcmNzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBpbnB1dC5hZGQocC5nZXRJZCgpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHAub3V0Z29pbmdBcmNzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBvdXRwdXQuYWRkKHAuZ2V0SWQoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRUcmFuc2l0aW9uKGlkOiBzdHJpbmcpOiBUcmFuc2l0aW9uIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fdHJhbnNpdGlvbnMuZ2V0KGlkKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0VHJhbnNpdGlvbnMoKTogQXJyYXk8VHJhbnNpdGlvbj4ge1xyXG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuX3RyYW5zaXRpb25zLnZhbHVlcygpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0VHJhbnNpdGlvbkNvdW50KCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RyYW5zaXRpb25zLnNpemU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFkZFRyYW5zaXRpb24odHJhbnNpdGlvbjogVHJhbnNpdGlvbikge1xyXG4gICAgICAgIGlmICh0cmFuc2l0aW9uLmlkID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdHJhbnNpdGlvbi5pZCA9IGNyZWF0ZVVuaXF1ZVN0cmluZygndCcsIHRoaXMuX3RyYW5zaXRpb25zLCB0aGlzLl90cmFuc2l0aW9uQ291bnRlcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX3RyYW5zaXRpb25zLnNldCh0cmFuc2l0aW9uLmlkLCB0cmFuc2l0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVtb3ZlVHJhbnNpdGlvbih0cmFuc2l0aW9uOiBUcmFuc2l0aW9uIHwgc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgdCA9IGdldEJ5SWQodGhpcy5fdHJhbnNpdGlvbnMsIHRyYW5zaXRpb24pO1xyXG4gICAgICAgIGlmICh0ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0cmFuc2l0aW9uID0gdDtcclxuXHJcbiAgICAgICAgdGhpcy5fdHJhbnNpdGlvbnMuZGVsZXRlKHRyYW5zaXRpb24uZ2V0SWQoKSk7XHJcbiAgICAgICAgdHJhbnNpdGlvbi5vdXRnb2luZ0FyY3MuZm9yRWFjaChhID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVBcmMoYSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdHJhbnNpdGlvbi5pbmdvaW5nQXJjcy5mb3JFYWNoKGEgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUFyYyhhKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0UGxhY2UoaWQ6IHN0cmluZyk6IFBsYWNlIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcGxhY2VzLmdldChpZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFBsYWNlcygpOiBBcnJheTxQbGFjZT4ge1xyXG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuX3BsYWNlcy52YWx1ZXMoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFBsYWNlQ291bnQoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcGxhY2VzLnNpemU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFkZFBsYWNlKHBsYWNlOiBQbGFjZSkge1xyXG4gICAgICAgIGlmIChwbGFjZS5pZCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHBsYWNlLmlkID0gY3JlYXRlVW5pcXVlU3RyaW5nKCdwJywgdGhpcy5fcGxhY2VzLCB0aGlzLl9wbGFjZUNvdW50ZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9wbGFjZXMuc2V0KHBsYWNlLmlkLCBwbGFjZSk7XHJcbiAgICAgICAgdGhpcy5faW5wdXRQbGFjZXMuYWRkKHBsYWNlLmlkKTtcclxuICAgICAgICB0aGlzLl9vdXRwdXRQbGFjZXMuYWRkKHBsYWNlLmlkKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVtb3ZlUGxhY2UocGxhY2U6IFBsYWNlIHwgc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgcCA9IGdldEJ5SWQodGhpcy5fcGxhY2VzLCBwbGFjZSk7XHJcbiAgICAgICAgaWYgKHAgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBsYWNlID0gcDtcclxuXHJcbiAgICAgICAgdGhpcy5fcGxhY2VzLmRlbGV0ZShwbGFjZS5nZXRJZCgpKTtcclxuICAgICAgICBwbGFjZS5vdXRnb2luZ0FyY3MuZm9yRWFjaChhID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVBcmMoYSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcGxhY2UuaW5nb2luZ0FyY3MuZm9yRWFjaChhID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVBcmMoYSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuX2lucHV0UGxhY2VzLmRlbGV0ZShwbGFjZS5nZXRJZCgpKTtcclxuICAgICAgICB0aGlzLl9vdXRwdXRQbGFjZXMuZGVsZXRlKHBsYWNlLmdldElkKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRBcmMoaWQ6IHN0cmluZyk6IEFyYyB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FyY3MuZ2V0KGlkKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QXJjcygpOiBBcnJheTxBcmM+IHtcclxuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLl9hcmNzLnZhbHVlcygpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QXJjQ291bnQoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fYXJjcy5zaXplO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRBcmMoYXJjOiBBcmMpOiB2b2lkO1xyXG4gICAgcHVibGljIGFkZEFyYyhzb3VyY2U6IFRyYW5zaXRpb24sIGRlc3RpbmF0aW9uOiBQbGFjZSwgd2VpZ2h0PzogbnVtYmVyKTogdm9pZDtcclxuICAgIHB1YmxpYyBhZGRBcmMoc291cmNlOiBQbGFjZSwgZGVzdGluYXRpb246IFRyYW5zaXRpb24sIHdlaWdodD86IG51bWJlcik6IHZvaWQ7XHJcbiAgICBwdWJsaWMgYWRkQXJjKGFyY09yU291cmNlOiBBcmMgfCBUcmFuc2l0aW9uIHwgUGxhY2UsIGRlc3RpbmF0aW9uPzogUGxhY2UgfCBUcmFuc2l0aW9uLCB3ZWlnaHQ6IG51bWJlciA9IDEpIHtcclxuICAgICAgICBpZiAoYXJjT3JTb3VyY2UgaW5zdGFuY2VvZiBBcmMpIHtcclxuICAgICAgICAgICAgdGhpcy5fYXJjcy5zZXQoYXJjT3JTb3VyY2UuZ2V0SWQoKSwgYXJjT3JTb3VyY2UpO1xyXG4gICAgICAgICAgICBpZiAoYXJjT3JTb3VyY2Uuc291cmNlIGluc3RhbmNlb2YgUGxhY2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX291dHB1dFBsYWNlcy5kZWxldGUoYXJjT3JTb3VyY2Uuc291cmNlSWQpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGFyY09yU291cmNlLmRlc3RpbmF0aW9uIGluc3RhbmNlb2YgUGxhY2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2lucHV0UGxhY2VzLmRlbGV0ZShhcmNPclNvdXJjZS5kZXN0aW5hdGlvbklkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkQXJjKG5ldyBBcmMoY3JlYXRlVW5pcXVlU3RyaW5nKCdhJywgdGhpcy5fYXJjcywgdGhpcy5fYXJjQ291bnRlciksIGFyY09yU291cmNlLCBkZXN0aW5hdGlvbiEsIHdlaWdodCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVtb3ZlQXJjKGFyYzogQXJjIHwgc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgYSA9IGdldEJ5SWQodGhpcy5fYXJjcywgYXJjKTtcclxuICAgICAgICBpZiAoYSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXJjID0gYTtcclxuXHJcbiAgICAgICAgdGhpcy5fYXJjcy5kZWxldGUoYXJjLmdldElkKCkpO1xyXG4gICAgICAgIGFyYy5zb3VyY2UucmVtb3ZlQXJjKGFyYyk7XHJcbiAgICAgICAgYXJjLmRlc3RpbmF0aW9uLnJlbW92ZUFyYyhhcmMpO1xyXG4gICAgICAgIGlmIChhcmMuc291cmNlIGluc3RhbmNlb2YgUGxhY2UgJiYgYXJjLnNvdXJjZS5vdXRnb2luZ0FyY3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX291dHB1dFBsYWNlcy5hZGQoYXJjLnNvdXJjZUlkKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGFyYy5kZXN0aW5hdGlvbiBpbnN0YW5jZW9mIFBsYWNlICYmIGFyYy5kZXN0aW5hdGlvbi5pbmdvaW5nQXJjcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5faW5wdXRQbGFjZXMuYWRkKGFyYy5kZXN0aW5hdGlvbklkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGZyZXF1ZW5jeSgpOiBudW1iZXIgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9mcmVxdWVuY3k7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IGZyZXF1ZW5jeSh2YWx1ZTogbnVtYmVyIHwgdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdGhpcy5fZnJlcXVlbmN5ID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGlucHV0UGxhY2VzKCk6IFNldDxzdHJpbmc+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faW5wdXRQbGFjZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG91dHB1dFBsYWNlcygpOiBTZXQ8c3RyaW5nPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX291dHB1dFBsYWNlcztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0SW5wdXRQbGFjZXMoKTogQXJyYXk8UGxhY2U+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQbGFjZXNCeUlkKHRoaXMuX2lucHV0UGxhY2VzKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0T3V0cHV0UGxhY2VzKCk6IEFycmF5PFBsYWNlPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGxhY2VzQnlJZCh0aGlzLl9vdXRwdXRQbGFjZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRJbml0aWFsTWFya2luZygpOiBNYXJraW5nIHtcclxuICAgICAgICBjb25zdCBtID0gbmV3IE1hcmtpbmcoe30pO1xyXG5cclxuICAgICAgICB0aGlzLmdldFBsYWNlcygpLmZvckVhY2gocCA9PiB7XHJcbiAgICAgICAgICAgIG0uc2V0KHAuaWQhLCBwLm1hcmtpbmcpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gbTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaXNFbXB0eSgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcGxhY2VzLnNpemUgPT09IDAgJiYgdGhpcy5fdHJhbnNpdGlvbnMuc2l6ZSA9PT0gMDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xvbmUoKTogUGV0cmlOZXQge1xyXG4gICAgICAgIHJldHVybiBQZXRyaU5ldC5jcmVhdGVGcm9tQXJjU3Vic2V0KHRoaXMsIHRoaXMuZ2V0QXJjcygpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZGVzdHJveSgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuX2tpbGwkLmNsb3NlZCkge1xyXG4gICAgICAgICAgICB0aGlzLl9raWxsJC5uZXh0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2tpbGwkLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX3JlZHJhdyQuY29tcGxldGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYmluZEV2ZW50cyhtb3VzZU1vdmVkJDogU3ViamVjdDxNb3VzZUV2ZW50PiwgbW91c2VVcCQ6IFN1YmplY3Q8TW91c2VFdmVudD4pIHtcclxuICAgICAgICB0aGlzLl9wbGFjZXMuZm9yRWFjaCgodiwgaykgPT4gdi5iaW5kRXZlbnRzKG1vdXNlTW92ZWQkLCBtb3VzZVVwJCwgdGhpcy5fa2lsbCQuYXNPYnNlcnZhYmxlKCksIHRoaXMuX3JlZHJhdyQpKTtcclxuICAgICAgICB0aGlzLl90cmFuc2l0aW9ucy5mb3JFYWNoKCh2LCBrKSA9PiB2LmJpbmRFdmVudHMobW91c2VNb3ZlZCQsIG1vdXNlVXAkLCB0aGlzLl9raWxsJC5hc09ic2VydmFibGUoKSwgdGhpcy5fcmVkcmF3JCkpO1xyXG4gICAgICAgIHRoaXMuX2FyY3MuZm9yRWFjaCgodiwgaykgPT4gdi5iaW5kRXZlbnRzKG1vdXNlTW92ZWQkLCBtb3VzZVVwJCwgdGhpcy5fa2lsbCQuYXNPYnNlcnZhYmxlKCksIHRoaXMuX3JlZHJhdyQpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVkcmF3UmVxdWVzdCQoKTogT2JzZXJ2YWJsZTx2b2lkPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JlZHJhdyQuYXNPYnNlcnZhYmxlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRQbGFjZXNCeUlkKGlkczogU2V0PHN0cmluZz4pOiBBcnJheTxQbGFjZT4ge1xyXG4gICAgICAgIGNvbnN0IHIgPSBbXTtcclxuICAgICAgICBmb3IgKGNvbnN0IGlkIG9mIGlkcykge1xyXG4gICAgICAgICAgICBjb25zdCBwID0gdGhpcy5nZXRQbGFjZShpZCk7XHJcbiAgICAgICAgICAgIGlmIChwID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGxhY2Ugd2l0aCBpZCAnJHtpZH0nIGlzIG5vdCBwcmVzZW50IGluIHRoZSBuZXQhYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgci5wdXNoKHApO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcjtcclxuICAgIH1cclxufVxyXG4iXX0=